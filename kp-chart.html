<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KP Astrology Chart (Cancelled/Partial Version)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; padding:0; background:linear-gradient(135deg,#f2f5fa 0,#eaf0ff 100%); font-family:'Segoe UI',Arial,sans-serif; }
    .container { max-width: 540px; margin: 40px auto 32px auto; padding:24px 16px 26px 16px; background:#fff; border-radius: 15px; box-shadow: 0 6px 36px #3451bf19, 0 1.5px 7px #b1b1b117;}
    h2 { color:#3451bf; margin-top:0;text-align:center; }
    label { display:block; margin-top:9px; margin-bottom:2px; font-weight:500;}
    input, select, button { width:100%; padding:8px 11px; margin-bottom:9px; border-radius:7px; border:1px solid #dbeafe; background:#f8fafc; font-size:1em;}
    input:focus,select:focus{border-color:#3451bf;}
    #drawBtn { background: linear-gradient(90deg, #3451bf 80%, #5e7bdf 100%); color: #fff; font-weight: 600; letter-spacing: 1px; cursor:pointer; border:none; margin-top:8px; border-radius:8px; font-size:1.07em; padding:12px 0; transition:background .18s; box-shadow:0 2px 8px #3451bf13;}
    #wheelBox { display:flex; justify-content:center; margin-top:22px; }
    #analysis { background:#f8f8fc; border-left:3px solid #3451bf; margin-top:22px; padding:13px 16px 12px 16px; font-size:1.09em; border-radius:7px; color:#26334d; min-height:40px;}
    .footer { text-align:center; color:#3451bf; font-size:1em; letter-spacing:1px; opacity:0.88; margin-top:28px;}
    @media(max-width:600px){
      .container{max-width:99vw;padding:4vw;}
      #wheelBox svg{width:95vw !important;height:95vw !important;}
      h2 { font-size: 1.33em;}
    }
    #placeGroup {display:flex;gap:4px;}
    #geocodeBtn {width:auto;background:#4a5fbf;color:#fff;padding:7px 16px;border-radius:7px;margin-bottom:0;font-size:1em;}
  </style>
</head>
<body>
  <div class="container">
    <h2>KP Astrology Chart <br><span style="font-size:0.74em;">(NASA Horizons Real Data)</span></h2>
    <form id="form" autocomplete="off">
      <label>Name</label>
      <input id="name" required placeholder="Your name" />
      <label>Date of Birth</label>
      <input id="date" type="date" required />
      <label>Time of Birth</label>
      <input id="time" type="time" required value="12:00" />
      <label>Latitude</label>
      <input id="lat" required placeholder="e.g. 6.9271" step="any" inputmode="decimal" />
      <label>Longitude</label>
      <input id="lon" required placeholder="e.g. 79.8612" step="any" inputmode="decimal" />
      <label>Place</label>
      <div id="placeGroup">
        <input id="place" autocomplete="off" placeholder="e.g. Colombo, Sri Lanka" style="flex:1" />
        <button type="button" id="geocodeBtn">Find</button>
      </div>
      <div id="placeResult" style="font-size:0.98em;color:#3451bf;margin-top:3px;"></div>
      <button id="drawBtn" type="submit">Draw KP Chart</button>
    </form>
    <div id="wheelBox"></div>
    <div id="analysis"></div>
    <div class="footer">sathyadarshana astrology</div>
  </div>
  <script>
    // Place geocode with OpenStreetMap
    async function geocodePlace(q) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const res = await fetch(url).then(r => r.json());
      if (!res.length) return null;
      return { lat: +res[0].lat, lon: +res[0].lon, label: res[0].display_name };
    }
    document.getElementById('geocodeBtn').onclick = async function() {
      const place = document.getElementById('place').value.trim();
      if (!place) { alert("Enter place name."); return; }
      const geo = await geocodePlace(place);
      const placeResult = document.getElementById('placeResult');
      if (!geo) {
        placeResult.innerHTML = "<span style='color:#c00;'>Place not found.        placeResult.innerHTML = "<span style='color:#c00;'>Place not found. Try a more specific name.</span>";
        return;
      }
      document.getElementById('lat').value = geo.lat;
      document.getElementById('lon').value = geo.lon;
      placeResult.innerHTML = `<span>üìç <b>${geo.label}</b> <span style="color:#333;">(${geo.lat}, ${geo.lon})</span></span>`;
    };

    // NASA Horizons API planet codes
    const planetCodes = [
      {name:"Sun", code:"10"},
      {name:"Mercury", code:"199"},
      {name:"Venus", code:"299"},
      {name:"Moon", code:"301"},
      {name:"Mars", code:"499"},
      {name:"Jupiter", code:"599"},
      {name:"Saturn", code:"699"},
      {name:"Uranus", code:"799"},
      {name:"Neptune", code:"899"},
      {name:"Pluto", code:"999"}
    ];
    const signs = ["Aries (Mesha)", "Taurus (Vrushabha)", "Gemini (Mithuna)", "Cancer (Kataka)", "Leo (Simha)", "Virgo (Kanya)", "Libra (Thula)", "Scorpio (Vrischika)", "Sagittarius (Dhanu)", "Capricorn (Makara)", "Aquarius (Kumbha)", "Pisces (Meena)"];

    // Fetch real planetary positions from NASA Horizons API via CORS proxy
    async function getPlanetsFromHorizons(date, time, lat, lon) {
      const dt = `${date}T${time}:00`;
      const codes = planetCodes.map(p=>p.code).join(",");
      const apiUrl = `https://ssd.jpl.nasa.gov/api/horizons.api?format=json&COMMAND='${codes}'&OBJ_DATA='NO'&MAKE_EPHEM='YES'&EPHEM_TYPE='OBSERVER'&CENTER='coord@399'&SITE_COORD='${lon},${lat},0'&START_TIME='${dt}'&STOP_TIME='${dt}'&STEP_SIZE='1 d'&QUANTITIES='1,4,20'`;
      // Use a public CORS proxy
      const proxy = "https://corsproxy.io/?";
      try {
        const res = await fetch(proxy + apiUrl);
        const data = await res.json();
        // Parse positions
        const results = [];
        for (const p of planetCodes) {
          const o = data.result?.table?.rows?.find(r => r.target === p.name);
          if (!o) continue;
          results.push({
            name: p.name,
            deg: o['Astro-Longitude'] || o['Astro Longitude'] || 0
          });
        }
        return results;
      } catch (e) {
        return null; // fallback to demo data
      }
    }

    // Fallback demo data (if fetch fails)
    function getDemoPlanets() {
      return [
        {name:"Sun",deg:140.5}, {name:"Mercury",deg:127.1}, {name:"Venus",deg:104.3}, {name:"Moon",deg:99.9},
        {name:"Mars",deg:80.2}, {name:"Jupiter",deg:44.8}, {name:"Saturn",deg:333.7}, {name:"Uranus",deg:19.2},
        {name:"Neptune",deg:345.4}, {name:"Pluto",deg:295.7}
      ];
    }

    // Draw wheel chart
    function drawWheel(planets) {
      const w = 340, r = 135, cx = w/2, cy = w/2;
      let svg = `<svg width="${w}" height="${w}" viewBox="0 0 ${w} ${w}">`;
      // Draw zodiac signs
      for (let i=0;i<12;i++) {
        const a1 = (i*30-90)*Math.PI/180, a2 = ((i+1)*30-90)*Math.PI/180;
        const x1 = cx + r*Math.cos(a1), y1 = cy + r*Math.sin(a1);
        const x2 = cx + r*Math.cos(a2), y2 = cy + r*Math.sin(a2);
        svg += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 0,1 ${x2},${y2}Z" fill="${i%2==0?'#eef2fc':'#e7eaff'}" stroke="#cfd8ec" stroke-width="1"/>`;
        // Sign name
        const tx = cx + (r-32)*Math.cos((a1+a2)/2), ty = cy + (r-32)*Math.sin((a1+a2)/2);
        svg += `<text x="${tx}" y="${ty}" fill="#3451bf" font-size="13" font-weight="bold" text-anchor="middle" alignment-baseline="middle">${signs[i].split(" ")[0]}</text>`;
      }
      // Planets
      for (const p of planets) {
        const a = (p.deg-90)*Math.PI/180;
        const px = cx + (r-55)*Math.cos(a);
        const py = cy + (r-55)*Math.sin(a);
        svg += `<circle cx="${px}" cy="${py}" r="12" fill="#fff" stroke="#3451bf" stroke-width="2"/><text x="${px}" y="${py+4}" fill="#3451bf" font-size="12" font-weight="bold" text-anchor="middle">${p.name[0]}</text>`;
      }
      svg += `</svg>`;
      document.getElementById('wheelBox').innerHTML = svg;
    }

    // Draw table
    function drawTable(planets) {
      let html = `<table style="margin:18px auto 0 auto;font-size:1.05em;"><tr><th style="padding:6px 18px;">Planet</th><th style="padding:6px 18px;">Degree</th><th style="padding:6px 18px;">Sign</th></tr>`;
      for (const p of planets) {
        const s = Math.floor(p.deg/30);
        const sign = signs[s];
        const d = (p.deg%30).toFixed(2);
        html += `<tr><td style="padding:5px 15px;">${p.name}</td><td style="padding:5px 15px;">${d}¬∞</td><td style="padding:5px 15px;">${sign}</td></tr>`;
      }
      html += "</table>";
      document.getElementById('analysis').innerHTML = html;
    }

    // Form Submit
    document.getElementById('form').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('drawBtn').disabled = true;
      document.getElementById('drawBtn').innerText = "Loading...";
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      let planets = await getPlanetsFromHorizons(date, time, lat, lon);
      if (!planets || planets.length < 5) {
        planets = getDemoPlanets();
        document.getElementById('analysis').innerHTML = "<span style='color:#c00;'>Real-time data unavailable. Showing demo data.</span>";
      }
      drawWheel(planets);
      drawTable(planets);
      document.getElementById('drawBtn').disabled = false;
      document.getElementById('drawBtn').innerText = "Draw KP Chart";
    };
  </script>
</body>
</html>
