<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KP Chart Generator – NASA JPL Horizons Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* ... (same styles as before, omitted for brevity) ... */
  </style>
</head>
<body>
  <div class="wrap">
    <h2>KP Chart Generator <span style="font-size:0.98rem;color:var(--neon2);text-shadow:0 0 2px #fff;" >– NASA JPL Edition</span></h2>
    <div class="form-glow">
      <form id="kpForm" autocomplete="off">
        <label>Name</label>
        <input type="text" id="name" required>
        <div class="row">
          <div>
            <label>Date of Birth</label>
            <input type="date" id="dob" required>
          </div>
          <div>
            <label>Time of Birth</label>
            <input type="time" id="tob" required>
          </div>
        </div>
        <label>Place of Birth</label>
        <input type="text" id="pob" placeholder="e.g. Colombo">
        <div class="row">
          <div>
            <label>Latitude</label>
            <input type="number" id="lat" step="0.0001" required placeholder="Click on map or enter">
          </div>
          <div>
            <label>Longitude</label>
            <input type="number" id="lon" step="0.0001" required placeholder="Click on map or enter">
          </div>
        </div>
        <label>Time Zone 
          <button type="button" id="detectTzBtn" style="float:right;margin-top:-2px;">Auto Detect</button>
        </label>
        <input type="text" id="timezone" required placeholder="+05:30">
        <button type="submit">Generate Chart</button>
        <div class="status" id="status"></div>
      </form>
    </div>
    <div id="map"></div>
    <div class="chart-section">
      <div id="wheel"></div>
      <table>
        <thead>
          <tr>
            <th>Planet</th><th>Degree</th><th>Sign</th><th>Nakshatra</th><th>Pada</th><th>Star Lord</th><th>Sub-Lord</th>
          </tr>
        </thead>
        <tbody id="tbl"></tbody>
      </table>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ... RASI_ICONS and KP helper functions (same as previous examples) ...

    // Map setup (same as before)
    // ...

    document.getElementById('kpForm').onsubmit = async function(e){
      e.preventDefault();
      const name = document.getElementById('name').value;
      const dob = document.getElementById('dob').value;
      const tob = document.getElementById('tob').value;
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const timezone = document.getElementById('timezone').value;

      // Parse date/time
      const [year, month, day] = dob.split('-').map(Number);
      const [hour, minute] = tob.split(':').map(Number);

      document.getElementById('status').textContent = 'Calculating...';

      try {
        // Call your backend proxy API (which connects to NASA JPL Horizons)
        const resp = await fetch('http://localhost:3001/api/planets',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({year,month,day,hour,minute,lat,lon})
        });
        if(!resp.ok) throw new Error('Failed to get planetary data');
        const data = await resp.json();

        // Assume data.planets = [{name, degree}, ...]
        renderTable(data.planets);
        renderWheel(data.planets);
        document.getElementById('status').textContent = '✓ Chart generated from NASA JPL Horizons!';
      } catch(e){
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    };

    // ... renderTable() and renderWheel() functions as before ...
  </script>
</body>
</html>
