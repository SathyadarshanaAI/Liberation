<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KP Astrology Book Generator (NASA Horizons Real Planets + KP UI Options)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; padding:0; background:linear-gradient(135deg,#f2f5fa 0,#eaf0ff 100%); font-family:'Segoe UI',Arial,sans-serif; }
    .container { max-width: 540px; margin: 40px auto 32px auto; padding:24px 16px 26px 16px; background:#fff; border-radius: 15px; box-shadow: 0 6px 36px #3451bf19, 0 1.5px 7px #b1b1b117;}
    h2 { color:#3451bf; margin-top:0;text-align:center; }
    label { display:block; margin-top:9px; margin-bottom:2px; font-weight:500;}
    input, select, button { width:100%; padding:8px 11px; margin-bottom:9px; border-radius:7px; border:1px solid #dbeafe; background:#f8fafc; font-size:1em;}
    input:focus,select:focus{border-color:#3451bf;}
    #drawBtn { background: linear-gradient(90deg, #3451bf 80%, #5e7bdf 100%); color: #fff; font-weight: 600; letter-spacing: 1px; cursor:pointer; border:none; margin-top:8px; border-radius:8px; font-size:1.07em; padding:12px 0; transition:background .18s; box-shadow:0 2px 8px #3451bf13;}
    #wheelBox { display:flex; justify-content:center; margin-top:22px; }
    #analysis { background:#f8f8fc; border-left:3px solid #3451bf; margin-top:22px; padding:13px 16px 12px 16px; font-size:1.09em; border-radius:7px; color:#26334d; min-height:40px;}
    .footer { text-align:center; color:#3451bf; font-size:1em; letter-spacing:1px; opacity:0.88; margin-top:28px;}
    @media(max-width:600px){
      .container{max-width:99vw;padding:4vw;}
      #wheelBox svg{width:95vw !important;height:95vw !important;}
      h2 { font-size: 1.33em;}
    }
    #placeGroup {display:flex;gap:4px;}
    #geocodeBtn {width:auto;background:#4a5fbf;color:#fff;padding:7px 16px;border-radius:7px;margin-bottom:0;font-size:1em;}
    #astroOptions {background:#f7f8fd;border-radius:10px;padding:16px 13px 9px 13px;margin-bottom:14px;border:1px solid #e4e7ed;}
    #astroOptions h3 {margin:0 0 10px 0;font-size:1.15em;color:#3451bf;}
    #astroOptions label {font-weight:500;}
  </style>
</head>
<body>
  <div class="container">
    <h2>KP Astrology Book Generator (Real NASA Planets)</h2>

    <!-- KP options (UI-‡∂∏‡∂∫‡∑í) -->
    <div id="astroOptions">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <span style="font-size:1.32em; color:#3451bf;">üî≠</span>
        <h3>KP Chart Options</h3>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:140px;">
          <label>Chart Type</label>
          <select id="chartType">
            <option value="kp" selected>KP (Krishnamurti)</option>
            <option value="vedic">Vedic</option>
            <option value="western">Western</option>
          </select>
        </div>
        <div style="flex:1;min-width:140px;">
          <label>Ayanamsa</label>
          <select id="ayanamsa">
            <option value="kp" selected>KP</option>
            <option value="lahiri">Lahiri</option>
            <option value="raman">Raman</option>
            <option value="fagan">Fagan/Bradley</option>
          </select>
        </div>
        <div style="flex:1;min-width:140px;">
          <label>House System</label>
          <select id="houseSystem">
            <option value="kp" selected>KP (Placidus)</option>
            <option value="equal">Equal</option>
            <option value="whole">Whole Sign</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
        <div style="flex:1;min-width:110px;display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="showSubLords" checked/>
          <label for="showSubLords" style="cursor:pointer;">Show Sub Lords</label>
        </div>
        <div style="flex:1;min-width:110px;display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="showCuspDegrees" checked/>
          <label for="showCuspDegrees" style="cursor:pointer;">Show House Cusps</label>
        </div>
      </div>
      <div style="margin-top:8px;font-size:0.98em;color:#888;">(KP options UI ‡∂¥‡∂∏‡∂´‡∂∫‡∑í. ‡∑É‡∂≠‡∑ä‚Äç‡∂∫ KP ‡∂ú‡∂´‡∂±‡∂∫ backend ‡∂ë‡∂ö‡∂ß.)</div>
    </div>

    <!-- Form -->
    <form id="form" autocomplete="off">
      <label>Name</label>
      <input id="name" required placeholder="Your name"/>

      <label>Date of Birth</label>
      <input id="date" type="date" required/>

      <label>Time of Birth</label>
      <input id="time" type="time" required value="12:00"/>

      <label>Time Zone (UTC Offset)</label>
      <input id="tz" required placeholder="+05:30" value="+05:30" />

      <label>Latitude</label>
      <input id="lat" required placeholder="e.g. 6.9271" step="any" inputmode="decimal"/>

      <label>Longitude</label>
      <input id="lon" required placeholder="e.g. 79.8612" step="any" inputmode="decimal"/>

      <label>Place</label>
      <div id="placeGroup">
        <input id="place" autocomplete="off" placeholder="e.g. Colombo, Sri Lanka" style="flex:1"/>
        <button type="button" id="geocodeBtn">Find</button>
      </div>
      <div id="placeResult" style="font-size:0.98em;color:#3451bf;margin-top:3px;"></div>

      <button id="drawBtn" type="submit">Draw KP Chart</button>
    </form>

    <div id="wheelBox"></div>
    <div id="analysis"></div>
    <div class="footer">sathyadarshana astrology</div>
  </div>

  <!-- ======== SCRIPT SECTION ======== -->
  <script>
    // Place geocode (Nominatim)
    async function geocodePlace(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }}).then(r=>r.json());
      if(!res.length) return null;
      return { lat:+res[0].lat, lon:+res[0].lon, label:res[0].display_name };
    }
    document.getElementById('geocodeBtn').onclick = async function(){
      const place = document.getElementById('place').value.trim();
      if(!place){ alert("Enter place name."); return; }
      const geo = await geocodePlace(place);
      const placeResult = document.getElementById('placeResult');
      if(!geo){
        placeResult.innerHTML = "<span style='color:#c00;'>Place not found. Try a more specific name.</span>";
        return;
      }
      document.getElementById('lat').value = geo.lat;
      document.getElementById('lon').value = geo.lon;
      placeResult.innerHTML = `<span>üìç <b>${geo.label}</b> <span style="color:#333;">(${geo.lat}, ${geo.lon})</span></span>`;
    };

    // Planet list
    const planetCodes = [
      {name:"Sun", code:"10"}, {name:"Mercury", code:"199"},
      {name:"Venus", code:"299"}, {name:"Moon", code:"301"},
      {name:"Mars", code:"499"}, {name:"Jupiter", code:"599"},
      {name:"Saturn", code:"699"}, {name:"Uranus", code:"799"},
      {name:"Neptune", code:"899"}, {name:"Pluto", code:"999"}
    ];
    const signs = ["Aries (Mesha)","Taurus (Vrushabha)","Gemini (Mithuna)","Cancer (Kataka)","Leo (Simha)","Virgo (Kanya)","Libra (Thula)","Scorpio (Vrischika)","Sagittarius (Dhanu)","Capricorn (Makara)","Aquarius (Kumbha)","Pisces (Meena)"];

    // ===== Helpers: TZ + RA/Dec ‚Üí Ecliptic
    function parseTZToMinutes(tzStr){
      const s = (tzStr||"").trim();
      let sign = +1, z = s;
      if (s.startsWith('-')) { sign = -1; z = s.slice(1); }
      else if (s.startsWith('+')) { sign = +1; z = s.slice(1); }
      if (z.includes(':')) {
        const [h,m] = z.split(':').map(Number);
        return sign * ((h||0)*60 + (m||0));
      } else if (z.includes('.')) {
        const f = parseFloat(z);
        const h = Math.trunc(Math.abs(f));
        const m = Math.round((Math.abs(f)-h)*60);
        return sign * (h*60 + m);
      } else {
        const h = parseInt(z||'0',10);
        return sign * (h*60);
      }
    }
    function toUTCFromOffset(dateStr, timeStr, offsetMinutes){
      const [Y,Mo,D] = dateStr.split('-').map(Number);
      const [h,m]    = timeStr.split(':').map(Number);
      const ms = Date.UTC(Y,(Mo||1)-1,D||1,h||0,m||0,0) - offsetMinutes*60000;
      return new Date(ms).toISOString().slice(0,19);
    }
    function parseRAtoDegrees(raStr){
      const parts = raStr.trim().replace(/:/g," ").split(/\s+/).map(Number);
      const H=parts[0]||0, M=parts[1]||0, S=parts[2]||0;
      return (H + M/60 + S/3600) * 15;
    }
    function parseDecString(decStr){
      const t = decStr.trim().replace(/:/g," ").split(/\s+/);
      if (t.length===1 && !isNaN(parseFloat(t[0]))) return parseFloat(t[0]);
      const neg = t[0].startsWith('-');
      const d = Math.abs(parseFloat(t[0]))||0, m=parseFloat(t[1])||0, s=parseFloat(t[2])||0;
      const val = d + m/60 + s/3600;
      return neg ? -val : val;
    }
    function eqToEclLongitude(raDeg, decDeg){
      const eps = 23.4392911 * Math.PI/180; // J2000 mean obliquity
      const ra = raDeg*Math.PI/180, dec = decDeg*Math.PI/180;
      const sinL = Math.sin(ra)*Math.cos(eps) + Math.tan(dec)*Math.sin(eps);
      const cosL = Math.cos(ra);
      let lam = Math.atan2(sinL, cosL) * 180/Math.PI;
      if (lam < 0) lam += 360;
      return lam;
    }

    async function fetchPlanet(dtISO, lat, lon, code, name){
      // NOTE: SITE_COORD = lon,lat,km
      const url = `https://ssd.jpl.nasa.gov/api/horizons.api`+
        `?format=json&MAKE_EPHEM=YES&TABLE_TYPE=OBSERVER&QUANTITIES='1'`+
        `&START_TIME='${dtISO}'&STOP_TIME='${dtISO}'&STEP_SIZE='1 m'`+
        `&SITE_COORD='${lon},${lat},0'&COMMAND='${code}'`;

      const res = await fetch(url);
      const json = await res.json();
      const txt = json.result || "";
      const lines = txt.split(/\r?\n/);
      const iS = lines.findIndex(l=>l.includes('$$SOE'));
      const iE = lines.findIndex((l,i)=> i>iS && l.includes('$$EOE'));
      if (iS<0 || iE<0) return null;

      const row = lines.slice(iS+1, iE).find(l=>/\S/.test(l)) || "";
      const raMatch  = row.match(/\b(\d{1,2}[:\s]\d{1,2}[:\s]\d{1,2}(\.\d+)?)\b/);
      const decMatch = row.match(/[+\-]?\d{1,2}(?::|\s)\d{1,2}(?::|\s)\d{1,2}(\.\d+)?|[+\-]?\d+\.\d+/g);
      if (!raMatch || !decMatch) return null;

      const raDeg  = parseRAtoDegrees(raMatch[1]);
      const decDeg = parseDecString(decMatch[0]);
      const eclLon = eqToEclLongitude(raDeg, decDeg);
      return { name, longitude: eclLon };
    }

    async function getPlanetsFromHorizonsISO(dtISO, lat, lon){
      const out = [];
      for (const p of planetCodes){
        const v = await fetchPlanet(dtISO, Number(lat), Number(lon), p.code, p.name);
        if (v) out.push(v);
      }
      return out;
    }

    function drawKPWheelChart(planets) {
      const wheel = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      wheel.setAttribute("width", 340); wheel.setAttribute("height", 340);
      const cx = 170, cy = 170, rOuter = 150, rInner = 70;
      const houseColors = ["#f8faff","#dbeafe","#e0e7ff","#f3f8fd","#fefce8","#f1f5f9","#fdf2fa","#f1f5f9","#fff7ed","#ecfdf5","#fff1f2","#f3f4f6"];
      for(let i=0;i<12;i++){
        const a1=(i/12)*2*Math.PI - Math.PI/2, a2=((i+1)/12)*2*Math.PI - Math.PI/2;
        const x1=cx+rOuter*Math.cos(a1), y1=cy+rOuter*Math.sin(a1);
        const x2=cx+rOuter*Math.cos(a2), y2=cy+rOuter*Math.sin(a2);
        const x3=cx+rInner*Math.cos(a2), y3=cy+rInner*Math.sin(a2);
        const x4=cx+rInner*Math.cos(a1), y4=cy+rInner*Math.sin(a1);
        const path=document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d",`M${x1},${y1} A${rOuter},${rOuter} 0 0,1 ${x2},${y2} L${x3},${y3} A${rInner},${rInner} 0 0,0 ${x4},${y4} Z`);
        path.setAttribute("fill",houseColors[i]); path.setAttribute("stroke","#bbb"); path.setAttribute("stroke-width",1);
        wheel.appendChild(path);
      }
      for(let i=0;i<12;i++){
        const a=(i/12)*2*Math.PI - Math.PI/2 + Math.PI/12;
        const tx=cx+(rInner+45)*Math.cos(a), ty=cy+(rInner+45)*Math.sin(a)+7;
        const label=document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x",tx); label.setAttribute("y",ty); label.setAttribute("text-anchor","middle");
        label.textContent=(i+1); wheel.appendChild(label);
      }
      const circle=document.createElementNS("http://www.w3.org/2000/svg","circle");
      circle.setAttribute("cx",cx); circle.setAttribute("cy",cy); circle.setAttribute("r",rOuter);
      circle.setAttribute("fill","none"); circle.setAttribute("stroke","#3451bf"); circle.setAttribute("stroke-width",2);
      wheel.appendChild(circle);
      const inner=document.createElementNS("http://www.w3.org/2000/svg","circle");
      inner.setAttribute("cx",cx); inner.setAttribute("cy",cy); inner.setAttribute("r",rInner);
      inner.setAttribute("fill","#fff"); inner.setAttribute("stroke","#bbb"); inner.setAttribute("stroke-width",1.4);
      wheel.appendChild(inner);

      const planetSymbols = {Sun:"‚òâ",Moon:"‚òΩ",Mercury:"‚òø",Venus:"‚ôÄ",Mars:"‚ôÇ",Jupiter:"‚ôÉ",Saturn:"‚ôÑ",Uranus:"‚ôÖ",Neptune:"‚ôÜ",Pluto:"‚ôá"};
      (planets||[]).forEach(pl=>{
        const angle=(pl.longitude/360)*2*Math.PI - Math.PI/2;
        const px=cx+100*Math.cos(angle), py=cy+100*Math.sin(angle);
        const g=document.createElementNS("http://www.w3.org/2000/svg","g");
        const dot=document.createElementNS("http://www.w3.org/2000/svg","circle");
        dot.setAttribute("cx",px); dot.setAttribute("cy",py); dot.setAttribute("r",13);
        dot.setAttribute("fill","#fff7c2"); dot.setAttribute("stroke","#ad8500"); dot.setAttribute("stroke-width",1.6);
        g.appendChild(dot);
        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x",px); t.setAttribute("y",py+7); t.setAttribute("text-anchor","middle");
        t.textContent = planetSymbols[pl.name] || pl.name[0]; g.appendChild(t);
        const lbl=document.createElementNS("http://www.w3.org/2000/svg","text");
        lbl.setAttribute("x",px); lbl.setAttribute("y",py+25); lbl.setAttribute("text-anchor","middle"); lbl.setAttribute("font-size","11px");
        lbl.textContent = pl.name; g.appendChild(lbl);
        wheel.appendChild(g);
      });

      document.getElementById('wheelBox').innerHTML='';
      document.getElementById('wheelBox').appendChild(wheel);
    }

    function getPlanetAnalysis(formData, planets){
      let txt = `<b>${formData.name || 'User'}'s KP Chart Analysis (NASA Horizons):</b><br><br>`;
      if (!planets) { txt += "Planetary data unavailable. Please try again."; return txt; }
      txt += `<b>Main Planetary Positions at Birth:</b><br>`;
      txt += '<table style="border-collapse:collapse;margin:7px 0;"><tr><th style="border:1px solid #dbeafe;padding:3px 7px;">Planet</th><th style="border:1px solid #dbeafe;padding:3px 7px;">Degree</th><th style="border:1px solid #dbeafe;padding:3px 7px;">Sign</th></tr>';
      planets.forEach(pl=>{
        const signNum = Math.floor(pl.longitude/30)%12;
        txt += `<tr>
          <td style="border:1px solid #dbeafe;padding:3px 7px;">${pl.name}</td>
          <td style="border:1px solid #dbeafe;padding:3px 7px;">${pl.longitude.toFixed(2)}¬∞</td>
          <td style="border:1px solid #dbeafe;padding:3px 7px;">${signs[signNum]}</td>
        </tr>`;
      });
      txt += '</table>';
      txt += `<br><i>Note: Positions use NASA Horizons data, converted from RA/Dec ‚Üí apparent ecliptic longitudes. KP/Vedic options are UI only.</i>`;
      return txt;
    }

    document.getElementById('form').onsubmit = async function(e){
      e.preventDefault();
      const formData = {
        name: document.getElementById('name').value.trim(),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        tz:   document.getElementById('tz').value.trim(),
        lat:  document.getElementById('lat').value,
        lon:  document.getElementById('lon').value,
        place: document.getElementById('place').value.trim(),
        chartType: document.getElementById('chartType').value,
        ayanamsa: document.getElementById('ayanamsa').value,
        houseSystem: document.getElementById('houseSystem').value,
        showSubLords: document.getElementById('showSubLords').checked,
        showCuspDegrees: document.getElementById('showCuspDegrees').checked,
      };
      if(!(formData.name && formData.date && formData.time && formData.lat && formData.lon)){
        alert('Please fill all required fields.'); return;
      }
      document.getElementById('analysis').innerHTML = "Calculating real planetary positions from NASA Horizons...";

      // Local time ‚Üí UTC
      const tzMinutes = parseTZToMinutes(formData.tz || "+00:00");
      const dtISO = toUTCFromOffset(formData.date, formData.time, tzMinutes); // "YYYY-MM-DDTHH:MM:SS"

      // Fetch planets (NOTE: CORS issue ‡∂±‡∂∏‡∑ä server proxy ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±)
      let planets;
      try {
        planets = await getPlanetsFromHorizonsISO(dtISO, formData.lat, formData.lon);
      } catch(e){
        console.error(e);
        planets = null;
      }

      if(!planets || !planets.length){
        document.getElementById('analysis').innerHTML =
          "Error: Could not fetch planetary positions (browser CORS ‡∑Ñ‡∑ù API limit). Try later or use server proxy (/horizons).";
        return;
      }
      drawKPWheelChart(planets);
      document.getElementById('analysis').innerHTML = getPlanetAnalysis(formData, planets);
    };
  </script>
</body>
</html>
