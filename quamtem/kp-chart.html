<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KP Astrology (NASA Horizons via Proxy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;padding:0;background:linear-gradient(135deg,#f2f5fa,#eaf0ff);font-family:'Segoe UI',Arial,sans-serif}
    .container{max-width:540px;margin:40px auto 32px;padding:24px 16px 26px;background:#fff;border-radius:15px;box-shadow:0 6px 36px #3451bf19,0 1.5px 7px #b1b1b117}
    h2{color:#3451bf;text-align:center;margin:0 0 16px}
    label{display:block;margin:9px 0 2px;font-weight:600}
    input,select,button{width:100%;padding:8px 11px;margin-bottom:9px;border-radius:7px;border:1px solid #dbeafe;background:#f8fafc;font-size:1em}
    #drawBtn{background:linear-gradient(90deg,#3451bf 80%,#5e7bdf);color:#fff;font-weight:600;letter-spacing:.5px;border:none;cursor:pointer;padding:12px 0;border-radius:8px;box-shadow:0 2px 8px #3451bf13}
    #wheelBox{display:flex;justify-content:center;margin-top:22px}
    #analysis{background:#f8f8fc;border-left:3px solid #3451bf;margin-top:22px;padding:13px 16px;border-radius:7px;color:#26334d;min-height:40px}
    #placeGroup{display:flex;gap:6px}
    #geocodeBtn{width:auto;background:#4a5fbf;color:#fff}
  </style>
</head>
<body>
  <div class="container">
    <h2>KP Astrology (Real Planets)</h2>

    <form id="form" autocomplete="off">
      <label>Name</label>
      <input id="name" required placeholder="Your name"/>

      <label>Date of Birth</label>
      <input id="date" type="date" required/>

      <label>Time of Birth</label>
      <input id="time" type="time" required value="12:00"/>

      <label>Time Zone (UTC Offset)</label>
      <input id="tz" required placeholder="+05:30" value="+05:30"/>

      <label>Latitude</label>
      <input id="lat" required step="any" inputmode="decimal"/>

      <label>Longitude</label>
      <input id="lon" required step="any" inputmode="decimal"/>

      <label>Place</label>
      <div id="placeGroup">
        <input id="place" autocomplete="off" placeholder="e.g. Kandy, Sri Lanka" style="flex:1"/>
        <button type="button" id="geocodeBtn">Find</button>
      </div>
      <div id="placeResult" style="font-size:.95em;color:#3451bf;margin-top:3px;"></div>

      <button id="drawBtn" type="submit">Draw KP Chart</button>
    </form>

    <div id="wheelBox"></div>
    <div id="analysis"></div>
  </div>

  <script>
    // -------- Helpers (TZ, geocode, wheel) ----------
    function parseTZToMinutes(tz){
      const s=(tz||'').trim(); let sign=+1,z=s;
      if(s.startsWith('-')){sign=-1;z=s.slice(1)} else if(s.startsWith('+')){z=s.slice(1)}
      if(z.includes(':')){const [h,m]=z.split(':').map(Number);return sign*((h||0)*60+(m||0))}
      if(z.includes('.')){const f=parseFloat(z);const h=Math.trunc(Math.abs(f));const m=Math.round((Math.abs(f)-h)*60);return sign*(h*60+m)}
      return sign*((parseInt(z||'0',10)||0)*60);
    }
    function toUTCFromOffset(dateStr,timeStr,offMin){
      const [Y,Mo,D]=dateStr.split('-').map(Number),[h,m]=timeStr.split(':').map(Number);
      const ms=Date.UTC(Y,(Mo||1)-1,D||1,h||0,m||0,0)-offMin*60000;
      return new Date(ms).toISOString().slice(0,19);
    }
    async function geocodePlace(q){
      const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const res=await fetch(url,{headers:{'Accept':'application/json'}}).then(r=>r.json());
      if(!res.length) return null;
      return { lat:+res[0].lat, lon:+res[0].lon, label:res[0].display_name };
    }
    document.getElementById('geocodeBtn').onclick = async ()=>{
      const q=document.getElementById('place').value.trim();
      if(!q) return alert('Enter place name.');
      const g=await geocodePlace(q);
      const out=document.getElementById('placeResult');
      if(!g){ out.innerHTML='<span style="color:#c00">Not found</span>'; return; }
      document.getElementById('lat').value=g.lat; document.getElementById('lon').value=g.lon;
      out.innerHTML = `üìç <b>${g.label}</b> <span style="color:#333">(${g.lat}, ${g.lon})</span>`;
    };

    function drawWheel(planets){
      const W=340,H=340,CX=170,CY=170,R_OUT=150,R_IN=70,R_P=100;
      const NS="http://www.w3.org/2000/svg", svg=document.createElementNS(NS,"svg");
      svg.setAttribute("width",W); svg.setAttribute("height",H);
      for(let i=0;i<12;i++){
        const a=i*30*Math.PI/180-Math.PI/2;
        const x1=CX+60*Math.cos(a),y1=CY+60*Math.sin(a);
        const x2=CX+R_OUT*Math.cos(a),y2=CY+R_OUT*Math.sin(a);
        const l=document.createElementNS(NS,"line"); l.setAttribute("x1",x1);l.setAttribute("y1",y1);l.setAttribute("x2",x2);l.setAttribute("y2",y2);
        l.setAttribute("stroke","#888"); l.setAttribute("stroke-width","1"); svg.appendChild(l);
        const mid=a+15*Math.PI/180; const tx=CX+R_IN*Math.cos(mid),ty=CY+R_IN*Math.sin(mid);
        const t=document.createElementNS(NS,"text"); t.setAttribute("x",tx); t.setAttribute("y",ty+4); t.setAttribute("text-anchor","middle"); t.textContent=i+1; svg.appendChild(t);
      }
      const c1=document.createElementNS(NS,"circle"); c1.setAttribute("cx",CX);c1.setAttribute("cy",CY);c1.setAttribute("r",R_OUT); c1.setAttribute("fill","none"); c1.setAttribute("stroke","#333"); c1.setAttribute("stroke-width","2"); svg.appendChild(c1);
      const c2=document.createElementNS(NS,"circle"); c2.setAttribute("cx",CX);c2.setAttribute("cy",CY);c2.setAttribute("r","60"); c2.setAttribute("fill","none"); c2.setAttribute("stroke","#bbb"); svg.appendChild(c2);

      (planets||[]).forEach(pl=>{
        const ang=(pl.longitude/360)*2*Math.PI - Math.PI/2;
        const px=CX+R_P*Math.cos(ang), py=CY+R_P*Math.sin(ang);
        const dot=document.createElementNS(NS,"circle"); dot.setAttribute("cx",px); dot.setAttribute("cy",py); dot.setAttribute("r","4"); dot.setAttribute("fill","#000"); svg.appendChild(dot);
        const lbl=document.createElementNS(NS,"text"); const lx=CX+(R_P+18)*Math.cos(ang), ly=CY+(R_P+18)*Math.sin(ang);
        lbl.setAttribute("x",lx); lbl.setAttribute("y",ly+4); lbl.setAttribute("text-anchor","middle"); lbl.setAttribute("font-size","11"); lbl.textContent=pl.name; svg.appendChild(lbl);
      });
      const box=document.getElementById('wheelBox'); box.innerHTML=''; box.appendChild(svg);
    }

    // -------- Submit ‚Üí call backend ‚Üí draw ----------
    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=document.getElementById('name').value.trim();
      const date=document.getElementById('date').value;
      const time=document.getElementById('time').value;
      const tz=document.getElementById('tz').value.trim();
      const lat=parseFloat(document.getElementById('lat').value);
      const lon=parseFloat(document.getElementById('lon').value);
      if(!(name && date && time && isFinite(lat) && isFinite(lon))){ alert('Fill all required fields.'); return; }

      const dtUTC = toUTCFromOffset(date, time, parseTZToMinutes(tz||'+00:00'));
      const url   = `/api/graha?dt=${encodeURIComponent(dtUTC)}&lat=${lat}&lon=${lon}`;

      const analysis=document.getElementById('analysis');
      analysis.textContent='Fetching real planetary positions‚Ä¶';
      try{
        const r=await fetch(url);
        if(!r.ok) throw new Error(await r.text());
        const j=await r.json();
        drawWheel(j.planets||[]);
        const signs=["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
        const rows=(j.planets||[]).map(pl=>`<tr><td>${pl.name}</td><td>${pl.longitude.toFixed(2)}¬∞</td><td>${signs[Math.floor(pl.longitude/30)%12]}</td></tr>`).join('');
        analysis.innerHTML=`<b>${name}'s KP Chart (Real Planets)</b><br><table style="border-collapse:collapse;margin-top:6px">
          <tr><th style="border:1px solid #dbeafe;padding:4px 7px">Planet</th><th style="border:1px solid #dbeafe;padding:4px 7px">Degree</th><th style="border:1px solid #dbeafe;padding:4px 7px">Sign</th></tr>${rows}</table>
          <div style="margin-top:6px;font-size:.95em;color:#555">Source: NASA Horizons (via server proxy). Time sent as UTC.</div>`;
      }catch(err){
        analysis.textContent = `Error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
