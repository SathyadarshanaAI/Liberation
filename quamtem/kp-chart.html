<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KP Astrology Chart ‚Ä¢ Sathyadarshana (NASA Horizons via Local Proxy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--brand:#3451bf;}
    body { margin:0; padding:0; background:linear-gradient(135deg,#f2f5fa 0,#eaf0ff 100%); font-family:'Segoe UI',Arial,sans-serif; color:#102a43;}
    .container { max-width: 560px; margin: 36px auto 32px; padding:24px 16px 26px; background:#fff; border-radius: 15px; box-shadow: 0 6px 36px #3451bf19, 0 1.5px 7px #b1b1b117;}
    h2 { color:var(--brand); margin:0 0 10px; text-align:center; }
    label { display:block; margin-top:9px; margin-bottom:2px; font-weight:600; }
    input, select, button { width:100%; padding:10px 12px; margin-bottom:9px; border-radius:9px; border:1px solid #dbeafe; background:#f8fafc; font-size:1em; }
    input:focus,select:focus{outline:none;border-color:var(--brand); box-shadow:0 0 0 2px #3451bf22;}
    #drawBtn { background: linear-gradient(90deg, var(--brand) 0%, #5e7bdf 100%); color:#fff; font-weight:700; letter-spacing:.4px; cursor:pointer; border:none; margin-top:8px; font-size:1.05em; padding:13px 0; box-shadow:0 3px 10px #3451bf33; }
    #drawBtn[disabled]{opacity:.65; cursor:not-allowed;}
    #wheelBox { display:flex; justify-content:center; margin-top:20px; }
    #analysis { background:#f8f8fc; border-left:3px solid var(--brand); margin-top:22px; padding:13px 16px 12px; font-size:1.02em; border-radius:7px; min-height:40px;}
    .footer { text-align:center; color:var(--brand); font-size:.98em; letter-spacing:1px; opacity:0.88; margin-top:24px;}
    #placeGroup {display:flex; gap:6px;}
    #geocodeBtn {width:auto; background:#4a5fbf; color:#fff; margin-bottom:0; padding:10px 16px; border:none; border-radius:9px;}
    table.kp { border-collapse:collapse; margin:18px auto 0; font-size:1.03em; }
    table.kp th, table.kp td{ padding:8px 14px; border:1px solid #e6edff; }
    table.kp th{ background:#eff4ff; color:var(--brand); }
    @media(max-width:600px){
      .container{max-width:98vw; padding:4vw;}
      #wheelBox svg{width:95vw !important; height:95vw !important;}
      h2{font-size:1.25em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>KP Astrology Chart<br><span style="font-size:.78em; font-weight:500;">(NASA Horizons ‚Ä¢ Local Node Proxy)</span></h2>

    <!-- Form -->
    <form id="form" autocomplete="off">
      <label>Name</label>
      <input id="name" placeholder="Your name"/>

      <label>Date of Birth</label>
      <input id="date" type="date" required/>

      <label>Time of Birth</label>
      <input id="time" type="time" required value="12:00"/>

      <label>Time Zone</label>
      <select id="tz" required>
        <option value="+05:30" selected>Asia/Colombo (+05:30)</option>
        <option value="+05:45">Asia/Kathmandu (+05:45)</option>
        <option value="+05:00">Asia/Karachi (+05:00)</option>
        <option value="+06:00">Asia/Dhaka (+06:00)</option>
        <option value="+00:00">UTC (+00:00)</option>
      </select>

      <label>Latitude</label>
      <input id="lat" placeholder="e.g. 6.9271" step="any" inputmode="decimal"/>

      <label>Longitude</label>
      <input id="lon" placeholder="e.g. 79.8612" step="any" inputmode="decimal"/>

      <label>Place</label>
      <div id="placeGroup">
        <input id="place" placeholder="e.g. Colombo, Sri Lanka" style="flex:1"/>
        <button type="button" id="geocodeBtn">Find</button>
      </div>
      <div id="placeResult" style="font-size:.95em;color:var(--brand);margin-top:2px;"></div>

      <button id="drawBtn" type="submit">Draw KP Chart</button>
    </form>

    <div id="wheelBox"></div>
    <div id="analysis"></div>
    <div class="footer">sathyadarshana astrology</div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const PROXY = "http://127.0.0.1:3000";  // your running server.js

    // ---------- Geocode (OSM Nominatim) ----------
    async function geocodePlace(q) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const res = await fetch(url).then(r=>r.json());
      if (!res.length) return null;
      return { lat:+res[0].lat, lon:+res[0].lon, label:res[0].display_name };
    }
    document.getElementById('geocodeBtn').onclick = async ()=>{
      const q = document.getElementById('place').value.trim();
      const out = document.getElementById('placeResult');
      if(!q){ out.innerHTML = "<span style='color:#c00'>Enter place name.</span>"; return; }
      const geo = await geocodePlace(q);
      if(!geo){ out.innerHTML = "<span style='color:#c00'>Place not found.</span>"; return; }
      document.getElementById('lat').value = geo.lat;
      document.getElementById('lon').value = geo.lon;
      out.innerHTML = `üìç <b>${geo.label}</b> <span style="color:#333">(${geo.lat}, ${geo.lon})</span>`;
    };

    // ---------- Time helpers ----------
    function toUTCISO(dateStr, timeStr, tzOffset){ // "+05:30"
      const [H,M] = (timeStr||"00:00").split(":").map(Number);
      const local = new Date(`${dateStr}T${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}:00`);
      const sign = tzOffset[0]==="-" ? -1 : 1;
      const offMin = sign*(+tzOffset.slice(1,3)*60 + +tzOffset.slice(4,6));
      const utcMs = local.getTime() - offMin*60*1000; // local -> UTC
      return new Date(utcMs).toISOString().replace(".000Z","Z");
    }

    // ---------- Proxy calls ----------
    async function fetchGeoLongitudes(utcISO){
      const url = `${PROXY}/geo-longitudes?utc=${encodeURIComponent(utcISO)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }
    async function fetchTopoLongitudes(utcISO, lat, lon){
      const url = `${PROXY}/topo-longitudes?utc=${encodeURIComponent(utcISO)}&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    // ---------- Chart helpers ----------
    const SIGN_NAMES = ["Aries (Mesha)","Taurus (Vrushabha)","Gemini (Mithuna)","Cancer (Kataka)","Leo (Simha)","Virgo (Kanya)","Libra (Thula)","Scorpio (Vrischika)","Sagittarius (Dhanu)","Capricorn (Makara)","Aquarius (Kumbha)","Pisces (Meena)"];
    function drawWheel(planets){
      const w=340, r=135, cx=w/2, cy=w/2;
      let svg = `<svg width="${w}" height="${w}" viewBox="0 0 ${w} ${w}">`;
      for(let i=0;i<12;i++){
        const a1=(i*30-90)*Math.PI/180, a2=((i+1)*30-90)*Math.PI/180;
        const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
        const x2=cx+r*Math.cos(a2), y2=cy+r*Math.sin(a2);
        svg += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 0,1 ${x2},${y2} Z" fill="${i%2? '#e7eaff':'#eef2fc'}" stroke="#cfd8ec"/>`;
        const tx=cx+(r-30)*Math.cos((a1+a2)/2), ty=cy+(r-30)*Math.sin((a1+a2)/2);
        svg += `<text x="${tx}" y="${ty}" fill="#3451bf" font-size="12" font-weight="bold" text-anchor="middle" alignment-baseline="middle">${SIGN_NAMES[i].split(" ")[0]}</text>`;
      }
      for(const p of planets){
        const a=(p.longitude-90)*Math.PI/180;
        const px=cx+(r-55)*Math.cos(a), py=cy+(r-55)*Math.sin(a);
        svg += `<circle cx="${px}" cy="${py}" r="12" fill="#fff" stroke="#3451bf" stroke-width="2"/>`;
        svg += `<text x="${px}" y="${py+4}" fill="#3451bf" font-size="12" font-weight="bold" text-anchor="middle">${p.name[0]}</text>`;
      }
      svg += `</svg>`;
      document.getElementById('wheelBox').innerHTML = svg;
    }
    function drawTable(planets){
      let html = `<table class="kp"><tr><th>Planet</th><th>Degrees</th><th>Sign</th></tr>`;
      for(const p of planets){
        const signIndex = Math.floor((+p.longitude)%360/30);
        const degInSign = ((+p.longitude)%30).toFixed(2);
        html += `<tr><td>${p.name}</td><td>${degInSign}¬∞</td><td>${SIGN_NAMES[signIndex]}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById('analysis').innerHTML = html;
    }

    // ---------- Form submit ----------
    document.getElementById('form').onsubmit = async (e)=>{
      e.preventDefault();
      const btn = document.getElementById('drawBtn');
      btn.disabled = true; btn.innerText = "Loading‚Ä¶";

      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value || "12:00";
      const tz   = document.getElementById('tz').value;
      const lat  = (document.getElementById('lat').value||"").trim();
      const lon  = (document.getElementById('lon').value||"").trim();

      if(!date){ alert("Please select Date of Birth."); btn.disabled=false; btn.innerText="Draw KP Chart"; return; }

      const utcISO = toUTCISO(date, time, tz); // "YYYY-MM-DDTHH:mm:ssZ"
      let data;
      try{
        if(lat && lon) data = await fetchTopoLongitudes(utcISO, lat, lon);
        else           data = await fetchGeoLongitudes(utcISO);
      }catch(err){
        document.getElementById('analysis').innerHTML = `<span style="color:#c00">Proxy fetch failed: ${String(err)}</span>`;
        btn.disabled=false; btn.innerText="Draw KP Chart"; return;
      }

      const planets = (data.planets||[]).map(p=>({ name:p.name, longitude:+p.longitude }));
      if(!planets.length){
        document.getElementById('analysis').innerHTML = `<span style="color:#c00">No planets returned.</span>`;
        document.getElementById('wheelBox').innerHTML = "";
        btn.disabled=false; btn.innerText="Draw KP Chart"; return;
      }

      drawWheel(planets);
      drawTable(planets);
      btn.disabled=false; btn.innerText="Draw KP Chart";
    };
  </script>
</body>
</html>
