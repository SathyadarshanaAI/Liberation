<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KP Chart</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f8fafc; color: #222;}
    .container { max-width: 560px; margin: 24px auto; padding: 16px; background: #fff; border-radius: 10px; box-shadow:0 2px 12px #0001;}
    label { display: block; margin-top: 8px; margin-bottom: 2px;}
    input, select, button { width: 100%; padding: 7px; margin-bottom: 10px;}
    #wheelBox { display: flex; justify-content: center; margin-top: 24px; }
    #mapPreview { width: 100%; height: 170px; border: 1px solid #bbb; border-radius: 8px; margin-bottom: 14px; display: none;}
    #mapPreview iframe { width:100%; height:100%; border:0; border-radius:8px;}
    #analysis { background:#f8f8fc; border-left:3px solid #3451bf; margin-top:24px; padding:12px 16px 12px 16px; font-size:1.08em;}
    @media(max-width:600px){
      .container{max-width:98vw;padding:4px;}
      #mapPreview{height:120px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>KP Chart</h2>
    <form id="form">
      <label>Name</label>
      <input id="name" required placeholder="Your name"/>
      <label>Date of Birth</label>
      <input id="date" type="date" required/>
      <label>Time of Birth</label>
      <input id="time" type="time" required value="12:00"/>
      <label>Timezone (Manual select)</label>
      <select id="timezone" required>
        <option value="">Select timezone</option>
        <option value="+05:30">IST (India/Sri Lanka) +05:30</option>
        <option value="+06:00">Bangladesh +06:00</option>
        <option value="+05:45">Nepal +05:45</option>
        <option value="+01:00">CET +01:00</option>
        <option value="-05:00">EST (US East) -05:00</option>
        <option value="+09:00">Japan +09:00</option>
        <option value="+03:00">Arabia +03:00</option>
        <option value="+08:00">China +08:00</option>
        <option value="-08:00">PST (US West) -08:00</option>
        <option value="+00:00">UTC/GMT +00:00</option>
      </select>
      <label>Latitude</label>
      <input id="lat" required placeholder="e.g. 51.5074" step="any" inputmode="decimal"/>
      <label>Longitude</label>
      <input id="lon" required placeholder="e.g. -0.1278" step="any" inputmode="decimal"/>
      <label>Place</label>
      <div style="display:flex;gap:4px;">
        <input id="place" placeholder="e.g. London, UK" style="flex:1"/>
        <button type="button" id="geocodeBtn" style="width:auto;">Find</button>
      </div>
    </form>
    <div id="mapPreview"></div>
    <button id="drawBtn" style="margin-top:10px;width:100%;">Draw Chart</button>
    <div id="wheelBox"></div>
    <div id="analysis"></div>
  </div>
<script>
async function geocodePlace(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
  const res = await fetch(url).then(r=>r.json());
  if(!res.length) return null;
  return { lat:+res[0].lat, lon:+res[0].lon, label:res[0].display_name };
}
function showMap(lat, lon){
  const mapDiv = document.getElementById('mapPreview');
  if(!lat||!lon){ mapDiv.style.display='none'; return; }
  mapDiv.style.display = '';
  mapDiv.innerHTML = `<iframe loading="lazy" allowfullscreen
    src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.02}%2C${lat-0.01}%2C${lon+0.02}%2C${lat+0.01}&layer=mapnik&marker=${lat}%2C${lon}"></iframe>
    <div style="text-align:right;font-size:12px;margin-top:2px;">
      <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}" target="_blank">View Full Map</a>
    </div>`;
}
document.getElementById('geocodeBtn').onclick = async function(){
  const place = document.getElementById('place').value.trim();
  if(!place){ alert("Enter place name."); return; }
  const geo = await geocodePlace(place);
  if(!geo){
    alert("Place not found. Try a more specific name.");
    return;
  }
  document.getElementById('lat').value = geo.lat;
  document.getElementById('lon').value = geo.lon;
  showMap(geo.lat, geo.lon);
};
document.getElementById('lat').addEventListener('input', ()=>{
  const lat=document.getElementById('lat').value,lon=document.getElementById('lon').value;
  if(lat && lon) showMap(lat, lon);
});
document.getElementById('lon').addEventListener('input', ()=>{
  const lat=document.getElementById('lat').value,lon=document.getElementById('lon').value;
  if(lat && lon) showMap(lat, lon);
});

function drawKPWheelChart(planets) {
    const wheel = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    wheel.setAttribute("width", 340);
    wheel.setAttribute("height", 340);
    wheel.innerHTML = '';
    const cx = 170, cy = 170, rOuter = 150, rInner = 70;
    // Outer circle
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", cx); circle.setAttribute("cy", cy);
    circle.setAttribute("r", rOuter); circle.setAttribute("fill", "#fafafa");
    circle.setAttribute("stroke", "#888"); circle.setAttribute("stroke-width", 2);
    wheel.appendChild(circle);
    // 12 houses
    for(let i=0; i<12; ++i){
        let a = (i/12) * 2 * Math.PI - Math.PI/2;
        let x1 = cx + rInner * Math.cos(a), y1 = cy + rInner * Math.sin(a);
        let x2 = cx + rOuter * Math.cos(a), y2 = cy + rOuter * Math.sin(a);
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1); line.setAttribute("y1", y1);
        line.setAttribute("x2", x2); line.setAttribute("y2", y2);
        line.setAttribute("stroke", "#888");
        line.setAttribute("stroke-width", 1.1);
        wheel.appendChild(line);
        // House numbers
        let tx = cx + (rInner+35) * Math.cos(a + Math.PI/12), ty = cy + (rInner+35) * Math.sin(a + Math.PI/12)+5;
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", tx);
        label.setAttribute("y", ty);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("font-size", "16px");
        label.setAttribute("fill", "#444");
        label.textContent = (i+1);
        wheel.appendChild(label);
    }
    // Inner circle
    const inner = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    inner.setAttribute("cx", cx); inner.setAttribute("cy", cy); inner.setAttribute("r", rInner);
    inner.setAttribute("fill", "#fff"); inner.setAttribute("stroke", "#aaa"); inner.setAttribute("stroke-width", 1.3);
    wheel.appendChild(inner);

    // Planets (draw as colored dots, if available)
    if (planets) {
        const planetColors = ["#e68a00","#aad","red","#1ca","#fb0","#e8a","#555","#222","#999","#bbb"];
        planets.forEach((pl,i)=>{
            // Houses in KP are each 30 deg, so house = Math.floor(longitude/30)
            let angle = (pl.longitude/360)*2*Math.PI - Math.PI/2;
            let px = cx + 110*Math.cos(angle), py = cy + 110*Math.sin(angle);
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot.setAttribute("cx", px); dot.setAttribute("cy", py);
            dot.setAttribute("r", 8);
            dot.setAttribute("fill", planetColors[i%planetColors.length]);
            dot.setAttribute("stroke", "#222"); dot.setAttribute("stroke-width", 1.4);
            wheel.appendChild(dot);
            // Planet label
            const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t.setAttribute("x", px); t.setAttribute("y", py-15);
            t.setAttribute("text-anchor","middle");
            t.setAttribute("font-size","13px");
            t.setAttribute("fill","#111");
            t.textContent = pl.name;
            wheel.appendChild(t);
        });
    }

    document.getElementById('wheelBox').innerHTML = '';
    document.getElementById('wheelBox').appendChild(wheel);
}

function getPlanetAnalysis(formData, planets) {
    let txt = `<b>KP Astrological Analysis for ${formData.name || 'the native'}:</b><br><br>`;
    if (!planets) {
        txt += "Planets' data could not be loaded at this time. Please check your connection or try again later.";
        return txt;
    }
    txt += `Your planetary positions at birth:<br>`;
    planets.forEach(pl => {
        txt += `<b>${pl.name}</b>: ${pl.longitude.toFixed(2)}Â°<br>`;
    });
    txt += `<br>Based on KP astrology, the position of each planet in your chart influences your life's path, opportunities, and challenges. For example, if your Mars is close to the ascendant, you may show courage and initiative, while a strong Venus in a favorable house can enhance creativity and relationships. The unique combination in your chart points to periods of growth and learning, especially when your main chart houses are influenced by Jupiter and Saturn. Rahu and Ketu, the lunar nodes, highlight karmic lessons and spiritual evolution. 
    <br><br>
    This is an automatically generated summary using NASA Horizons planetary data. For a more in-depth personalized analysis, consult a professional KP astrologer with your full birth chart and life context.
    `;
    return txt;
}

async function getPlanetsFromNasa(date, time, lat, lon) {
    try {
        // Call your backend proxy, adjust /horizons path if needed
        const url = `/horizons?date=${date}&time=${time}&lat=${lat}&lon=${lon}`;
        const res = await fetch(url);
        if (!res.ok) return null;
        const data = await res.json();
        // Horizons API output: data.result (text) or data["ephemeris"]
        // We'll parse data.result for ecliptic longitudes
        if (!data.result) return null;
        const lines = data.result.split('\n');
        const planetNames = ["Sun", "Mercury", "Venus", "Moon", "Mars", "Jupiter", "Saturn", "Uranus", "Neptune", "Pluto"];
        // Find $$SOE (start of ephemeris) and $$EOE (end)
        const start = lines.findIndex(l=>l.includes('$$SOE'));
        const end = lines.findIndex(l=>l.includes('$$EOE'));
        let planets = [];
        for(let i=start+1;i<end;i++){
            let row = lines[i].trim().split(/\s+/);
            if(row.length>=5) {
                let name = planetNames[i-(start+1)];
                let longitude = parseFloat(row[4]);
                if (!isNaN(longitude)) planets.push({name, longitude});
            }
        }
        return planets;
    } catch(e) {
        return null;
    }
}

document.getElementById('drawBtn').onclick = async function(e) {
    e.preventDefault();
    const formData = {
      name: document.getElementById('name').value.trim(),
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      timezone: document.getElementById('timezone').value,
      lat: document.getElementById('lat').value,
      lon: document.getElementById('lon').value,
      place: document.getElementById('place').value.trim()
    };
    if(!(formData.name && formData.date && formData.time && formData.timezone && formData.lat && formData.lon)){
      alert('Please fill all required fields.');
      return;
    }
    // Get planet data from NASA Horizons via your proxy
    const planets = await getPlanetsFromNasa(formData.date, formData.time, formData.lat, formData.lon);
    drawKPWheelChart(planets);
    document.getElementById('analysis').innerHTML = getPlanetAnalysis(formData, planets);
};
</script>
</body>
</html>
