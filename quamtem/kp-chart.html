kp-astrology-chart-pro.html

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>KP Astrology Chart Pro | Sathyadarshana</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3"/>
  <meta name="description" content="KP Astrology chart, Vimshottari Dasha, Bhukti, Sub-Lord, Cuspal Sub-Lord, Ruling Planets, PDF, share, timezone, geocode, map.">
  <link rel="icon" href="../assets/favicon.png">
  <style>
    body { background: #181e29; color: #e0f2fe; font-family: system-ui, Arial; margin: 0; }
    .wrap { max-width: 900px; margin: 28px auto; padding: 12px; }
    .card { background: #222c3b; border: 1px solid #2a3652; border-radius: 14px; padding: 16px; margin-bottom: 20px; }
    label { color: #93c5fd; display: block; margin-top: 10px; margin-bottom: 4px; font-size: 16px;}
    input, button, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #2a3652; background: #1a2335; color: #cdeafe; font-size: 17px; }
    button { cursor: pointer; background: #38bdf8; color: #15202b; font-weight: bold; margin-top: 16px;}
    .pill { display: inline-block; background: #1a2335; border: 1px solid #2a3652; border-radius: 999px; padding: 7px 16px; margin-right: 8px; margin-bottom: 5px;}
    table { width: 100%; border-collapse: collapse; margin-top: 18px;}
    th, td { padding: 8px; border-bottom: 1px solid #374151; text-align: left;}
    th { color: #93c5fd; font-weight: 600;}
    .mono { font-variant-numeric: tabular-nums;}
    #kpBoxes { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-top: 18px;}
    .kpBox { background: #29344a; border-radius: 10px; min-height: 60px; text-align: center; padding: 10px;}
    .kpBox.asc { box-shadow: 0 0 0 2px #38bdf8 inset;}
    #moonSubLord, #rulingPlanets, #cuspalSubLords, #significators, #planetStrengths { margin-top: 12px; }
    #moonSubLord b, #cuspalSubLords b { color: #38bdf8; }
    #pdfBtn, #shareBtn, #saveBtn, #loadBtn, #modeBtn { width: auto; margin-right:11px; }
    .toplink{position:fixed;left:10px;top:10px;background:#0b1220;color:#7dd3fc;padding:7px 14px;border-radius:9px;text-decoration:none;z-index:5}
    .footer-info{margin-top:18px;color:#60a5fa;font-size:15px;border-top:1px solid #374151;padding-top:10px;}
    #predictionBox{margin-top:14px; background:#23282e;border-left:5px solid #38bdf8;}
    #mapPreview { width: 100%; height: 170px; margin-top: 8px; border: 1px solid #374151; border-radius: 10px; display:none;}
    #mapPreview iframe { width:100%; height:100%; border:0; border-radius:10px;}
    .row2col { display: flex; gap: 8px;}
    .row2col > * { flex: 1 1 0;}
    .year-quick-btns {display:flex;gap:6px;margin-bottom:9px;}
    .year-quick-btns button {width:auto;padding:7px 10px;font-size:15px;margin-top:0;}
    @media (max-width:700px){
      .wrap{padding:4px;}
      #kpBoxes { grid-template-columns:repeat(2,1fr);}
      .row2col {flex-direction: column;}
      .pill{font-size:14px;}
      th,td{font-size:14px;}
    }
    @media print {
      body { background: #fff; color: #111; }
      .card { background: #fff; border-color: #ccc; color: #111;}
      .toplink, #shareBtn, #saveBtn, #loadBtn, #modeBtn { display: none !important;}
      .footer-info { color:#333 !important; }
      #mapPreview {display:none !important;}
    }
    .dark { background: #181e29 !important; color: #e0f2fe !important;}
    .light { background: #f9fafb !important; color: #212121 !important;}
    .light .card { background:#fff !important; border-color:#bbb !important; color:#222;}
    .light #predictionBox{background:#f1f5f9;}
  </style>
  <div id="google_translate_element" style="float:right;margin:10px 0"></div>
  <script type="text/javascript">
  function googleTranslateElementInit() {
    new google.translate.TranslateElement(
      {pageLanguage: 'en', includedLanguages: 'en,si,ta', layout: google.translate.TranslateElement.InlineLayout.SIMPLE},
      'google_translate_element'
    );
  }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</head>
<body class="dark">
<a class="toplink" href="../astrology.html">‚Üê Dashboard</a>
<div class="wrap">
  <div class="card">
    <h2>KP Astrology Chart Pro</h2>
    <form id="birthForm" autocomplete="off">
      <label>Name</label>
      <input id="name" required placeholder="Your name"/>
      <label>Birth Date & Time</label>
      <div class="row2col">
        <div style="min-width:0;">
          <input id="date" type="date" required style="margin-bottom:5px"/>
          <div class="year-quick-btns">
            <button type="button" onclick="setYear(1971)">1971</button>
            <button type="button" onclick="setYear(1980)">1980</button>
            <button type="button" onclick="setYear(1990)">1990</button>
            <button type="button" onclick="setYear(2000)">2000</button>
            <button type="button" onclick="setYear(2010)">2010</button>
          </div>
        </div>
        <input id="time" type="time" required value="12:00"/>
      </div>
      <label>Timezone</label>
      <select id="timezone"></select>
      <label>Latitude</label>
      <input id="lat" required placeholder="e.g. 7.2862" step="any" inputmode="decimal" pattern="^-?\d+(\.\d+)?$"/>
      <label>Longitude</label>
      <input id="lon" required placeholder="e.g. 80.6316" step="any" inputmode="decimal" pattern="^-?\d+(\.\d+)?$"/>
      <label>Place</label>
      <div style="display:flex;gap:7px;">
        <input id="place" placeholder="e.g. Kandy, Sri Lanka" style="flex:1"/>
        <button type="button" id="geocodeBtn" style="width:auto;background:#0ea5e9;color:#fff;margin:0 0 0 3px;">Find</button>
      </div>
      <div id="mapPreview"></div>
      <button type="submit">Generate Chart</button>
    </form>
    <div id="err" style="color:#f87171;margin-top:8px;"></div>
  </div>
  <div id="chartArea" style="display:none">
    <div class="card" id="summary"></div>
    <div class="card">
      <h3>Maha Dasha Table</h3>
      <table>
        <thead>
          <tr>
            <th>#</th><th>Lord</th><th>Start</th><th>End</th><th class="mono">Years</th>
          </tr>
        </thead>
        <tbody id="dashaTable"></tbody>
      </table>
      <h3 style="margin-top:22px">Bhukti (Sub-Dasha)</h3>
      <table>
        <thead>
          <tr>
            <th>#</th><th>Lord</th><th>Start</th><th>End</th><th class="mono">Years</th>
          </tr>
        </thead>
        <tbody id="bhuktiTable"></tbody>
      </table>
      <div id="predictionBox" class="card" style="display:none"></div>
    </div>
    <div class="card">
      <h3>KP 12-Box Chart</h3>
      <div id="kpBoxes"></div>
      <div id="cuspalSubLords"></div>
      <div id="moonSubLord"></div>
      <div id="rulingPlanets"></div>
      <div id="significators"></div>
      <div id="planetStrengths"></div>
    </div>
    <button id="pdfBtn">üìÑ Download as PDF</button>
    <button id="shareBtn">üîó Share Chart</button>
    <button id="saveBtn">üíæ Save Chart</button>
    <button id="loadBtn">üìÇ Load Chart</button>
    <button id="modeBtn">üåô/‚òÄÔ∏è</button>
    <div class="footer-info">
      <b>Sathyadarshana KP Astrology Report</b><br>
      Email: sathyanirvana@gmail.com<br>
      Tel: +94757500000<br>
      Sri Lanka
    </div>
  </div>
</div>
<script>
// Year picker button function
function setYear(year){
  let dateEl = document.getElementById('date');
  let d = dateEl.value ? new Date(dateEl.value) : new Date();
  d.setFullYear(year);
  dateEl.value = d.toISOString().slice(0,10);
}
// Timezone select
const timezones = [
  { value:"+05:30", label:"IST (India/Sri Lanka) +05:30" },
  { value:"+06:00", label:"Bangladesh +06:00" },
  { value:"+05:45", label:"Nepal +05:45" },
  { value:"+01:00", label:"CET +01:00" },
  { value:"-05:00", label:"EST (US East) -05:00" },
  { value:"+09:00", label:"Japan +09:00" },
  { value:"+03:00", label:"Arabia +03:00" },
  { value:"+08:00", label:"China +08:00" },
  { value:"-08:00", label:"PST (US West) -08:00" },
  { value:"+00:00", label:"UTC/GMT +00:00" }
];
timezones.forEach(tz=>{
  const o = document.createElement('option');
  o.value = tz.value; o.textContent = tz.label;
  timezone.appendChild(o);
});
timezone.value = "+05:30";

// Geocode and Map logic
async function geocodePlace(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
  const res = await fetch(url).then(r=>r.json());
  if(!res.length) return null;
  return { lat:+res[0].lat, lon:+res[0].lon, label:res[0].display_name };
}
function showMap(lat, lon){
  const mapDiv = document.getElementById('mapPreview');
  if(!lat||!lon){ mapDiv.style.display='none'; return; }
  mapDiv.style.display = '';
  mapDiv.innerHTML = `<iframe loading="lazy" allowfullscreen
    src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.02}%2C${lat-0.01}%2C${lon+0.02}%2C${lat+0.01}&layer=mapnik&marker=${lat}%2C${lon}"
    ></iframe>
    <div style="text-align:right;font-size:12px;margin-top:2px;">
      <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}" target="_blank" style="color:#38bdf8">View Full Map</a>
    </div>`;
}
document.getElementById('geocodeBtn').onclick = async function(){
  const place = document.getElementById('place').value.trim();
  if(!place){ errBox.textContent="Enter place name."; return; }
  errBox.textContent = "Searching...";
  const geo = await geocodePlace(place);
  if(!geo){
    errBox.textContent = "Place not found. Please try a more specific name.";
    return;
  }
  document.getElementById('lat').value = geo.lat;
  document.getElementById('lon').value = geo.lon;
  showMap(geo.lat, geo.lon);
  errBox.textContent = "";
};
// On Lat/Lon change, show map preview
document.getElementById('lat').addEventListener('input', ()=>{
  const lat=document.getElementById('lat').value,lon=document.getElementById('lon').value;
  if(lat&&lon){ showMap(lat,lon);}
});
document.getElementById('lon').addEventListener('input', ()=>{
  const lat=document.getElementById('lat').value,lon=document.getElementById('lon').value;
  if(lat&&lon){ showMap(lat,lon);}
});
// On Place input clear, hide map
document.getElementById('place').addEventListener('input', ()=>{
  if(!document.getElementById('place').value.trim()){ document.getElementById('mapPreview').style.display='none'; }
});

// Main form logic (date+time picker, manual lat/lon, mobile friendly)
const birthForm = document.getElementById('birthForm');
const errBox = document.getElementById('err');
birthForm.onsubmit = async function(e){
  e.preventDefault();
  errBox.textContent = '';
  let name = document.getElementById('name').value.trim();
  let date = document.getElementById('date').value;
  let time = document.getElementById('time').value;
  let tz = document.getElementById('timezone').value;
  let lat = parseFloat(document.getElementById('lat').value);
  let lon = parseFloat(document.getElementById('lon').value);
  let place = document.getElementById('place').value.trim();
  if(!name || !date || !time){
    errBox.textContent = 'Please fill all fields correctly.';
    return;
  }
  // If lat/lon are missing, try geocoding
  if((isNaN(lat) || isNaN(lon) || !lat || !lon) && place){
    errBox.textContent = 'Searching place...';
    const geo = await geocodePlace(place);
    if(!geo){
      errBox.textContent = 'Place not found. Enter coordinates.';
      return;
    }
    lat = geo.lat; lon = geo.lon;
    document.getElementById('lat').value = lat;
    document.getElementById('lon').value = lon;
    showMap(lat, lon);
  }
  // Double-check lat/lon are now valid
  if(isNaN(lat) || isNaN(lon) || !lat || !lon){
    errBox.textContent = 'Latitude/Longitude required.';
    return;
  }
  errBox.textContent = '';
  // Combine date+time to ISO string for chart logic
  const dt = date + "T" + time;
  showChart(name, dt, tz, lat, lon, place);
};

// ==== Astrology/Chart Logic (Full, Working) ====
const MD_ORDER = [
  { lord: "Ketu",    years: 7  },
  { lord: "Venus",   years: 20 },
  { lord: "Sun",     years: 6  },
  { lord: "Moon",    years: 10 },
  { lord: "Mars",    years: 7  },
  { lord: "Rahu",    years: 18 },
  { lord: "Jupiter", years: 16 },
  { lord: "Saturn",  years: 19 },
  { lord: "Mercury", years: 17 }
];
const NAKSHATRAS = [
  { name:'Ashwini', lord:'Ketu' },{ name:'Bharani', lord:'Venus' },{ name:'Krittika', lord:'Sun' },
  { name:'Rohini', lord:'Moon' },{ name:'Mrigashira', lord:'Mars' },{ name:'Ardra', lord:'Rahu' },
  { name:'Punarvasu', lord:'Jupiter' },{ name:'Pushya', lord:'Saturn' },{ name:'Ashlesha', lord:'Mercury' },
  { name:'Magha', lord:'Ketu' },{ name:'Purva Phalguni', lord:'Venus' },{ name:'Uttara Phalguni', lord:'Sun' },
  { name:'Hasta', lord:'Moon' },{ name:'Chitra', lord:'Mars' },{ name:'Svati', lord:'Rahu' },
  { name:'Vishakha', lord:'Jupiter' },{ name:'Anuradha', lord:'Saturn' },{ name:'Jyeshtha', lord:'Mercury' },
  { name:'Mula', lord:'Ketu' },{ name:'Purva Ashadha', lord:'Venus' },{ name:'Uttara Ashadha', lord:'Sun' },
  { name:'Shravana', lord:'Moon' },{ name:'Dhanishtha', lord:'Mars' },{ name:'Shatabhisha', lord:'Rahu' },
  { name:'Purva Bhadrapada', lord:'Jupiter' },{ name:'Uttara Bhadrapada', lord:'Saturn' },{ name:'Revati', lord:'Mercury' }
];
const DASHA_PREDICTIONS = {
  "Ketu": {
    en: "Ketu Dasha: A period of spiritual inclinations, sudden changes, and detachment.",
    si: "‡∂ö‡∑ö‡∂≠‡∑î ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂Ü‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∑í‡∂ö ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑ê‡∑Ä‡∑ê‡∂≠‡∑ä‡∂∏, ‡∑Ñ‡∂Ø‡∑í‡∑É‡∑í ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä, ‡∑Ä‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂∫‡∑î‡∂ú‡∂∫‡∂ö‡∑ä.",
    ta: "‡Æï‡Øá‡Æ§‡ØÅ ‡Æ§‡Æö‡Øà: ‡ÆÜ‡Æ©‡Øç‡ÆÆ‡Æø‡Æï ‡ÆÜ‡Æ∞‡Øç‡Æµ‡ÆÆ‡Øç, ‡Æ§‡Æø‡Æü‡ØÄ‡Æ∞‡Øç ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡Æ™‡Æ±‡Øç‡Æ±‡Æø‡Æ©‡Øç‡ÆÆ‡Øà."
  },
  "Venus": {
    en: "Venus Dasha: Brings comforts, relationships, art, luxury and sometimes indulgence.",
    si: "‡∑Å‡∑î‡∂ö‡∑ä‚Äç‡∂ª ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∑É‡∑î‡∑Ä‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä, ‡∑É‡∂∂‡∂≥‡∂≠‡∑è, ‡∂ö‡∂Ω‡∑è, ‡∑Ä‡∑è‡∂∑‡∑ù‡∂ú ‡∑Ñ‡∑è ‡∑Ä‡∑í‡∂Ω‡∑è‡∑É‡∑í‡∂≠‡∑è.",
    ta: "‡Æö‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ∞ ‡Æ§‡Æö‡Øà: ‡Æö‡ØÅ‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡Æâ‡Æ±‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç, ‡Æï‡Æ≤‡Øà, ‡Æµ‡Æö‡Æ§‡Æø, ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ÆÆ‡Øç."
  },
  "Sun": {
    en: "Sun Dasha: Power, position, ego, health focus, authority and fatherly issues.",
    si: "‡∑É‡∑ñ‡∂ª‡∑ä‡∂∫ ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂∂‡∂Ω‡∂∫, ‡∂≠‡∂±‡∂≠‡∑î‡∂ª, ‡∂Ö‡∑Ñ‡∂Ç‡∂ö‡∑è‡∂ª‡∂∫, ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫‡∂∫, ‡∂¥‡∑í‡∂∫‡∑è‡∂ú‡∑ö ‡∂ö‡∂ª‡∑î‡∂´‡∑î.",
    ta: "‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ ‡Æ§‡Æö‡Øà: ‡ÆÖ‡Æ§‡Æø‡Æï‡Ææ‡Æ∞‡ÆÆ‡Øç, ‡Æ®‡Æø‡Æ≤‡Øà, ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Øà, ‡Æâ‡Æü‡Æ≤‡Øç ‡Æö‡ØÅ‡Æï‡ÆÆ‡Øç, ‡Æ§‡Æ®‡Øç‡Æ§‡Øà."
  },
  "Moon": {
    en: "Moon Dasha: Mind, emotions, travel, mother, peace or restlessness.",
    si: "‡∂†‡∂±‡∑ä‡∂Ø‡∑ä‚Äç‡∂ª ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂∏‡∂±‡∑É, ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏‡∑ä, ‡∑É‡∂Ç‡∂†‡∑è‡∂ª, ‡∂∏‡∑Ä, ‡∑É‡∑è‡∂∏‡∂∫ ‡∑Ñ‡∑ù ‡∂Ö‡∑Å‡∑è‡∂±‡∑ä‡∂≠‡∑í.",
    ta: "‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ∞ ‡Æ§‡Æö‡Øà: ‡ÆÆ‡Æ©‡ÆÆ‡Øç, ‡Æâ‡Æ£‡Æ∞‡Øç‡Æö‡Øç‡Æö‡Æø, ‡Æ™‡ÆØ‡Æ£‡ÆÆ‡Øç, ‡Æ§‡Ææ‡ÆØ‡Øç, ‡ÆÖ‡ÆÆ‡Øà‡Æ§‡Æø."
  },
  "Mars": {
    en: "Mars Dasha: Energy, aggression, real estate, siblings, accidents.",
    si: "‡∂Ö‡∂ü ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∑Å‡∂ö‡∑ä‡∂≠‡∑í‡∂∫, ‡∂≠‡∂Ø ‡∂ö‡∑ù‡∂¥‡∂∫, ‡∂Ø‡∑ö‡∂¥‡∑Ö, ‡∑É‡∑Ñ‡∑ù‡∂Ø‡∂ª‡∂∫‡∂±‡∑ä, ‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î.",
    ta: "‡Æö‡ØÜ‡Æµ‡Øç‡Æµ‡Ææ‡ÆØ‡Øç ‡Æ§‡Æö‡Øà: ‡ÆÜ‡Æ±‡Øç‡Æ±‡Æ≤‡Øç, ‡Æï‡Øã‡Æ™‡ÆÆ‡Øç, ‡Æö‡Øä‡Æ§‡Øç‡Æ§‡ØÅ, ‡Æö‡Æï‡Øã‡Æ§‡Æ∞‡Æ∞‡Øç, ‡Æµ‡Æø‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ."
  },
  "Rahu": {
    en: "Rahu Dasha: Worldly desires, confusion, innovation, foreign connections.",
    si: "‡∂ª‡∑è‡∑Ñ‡∑î ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂Ω‡∑ù‡∂ö ‡∂Ü‡∑Å‡∑è‡∑Ä‡∂±‡∑ä, ‡∂Ö‡∂ª‡∑ä‡∂∂‡∑î‡∂Ø, ‡∂±‡∑Ä‡∑ù‡∂≠‡∑ä‡∂¥‡∑è‡∂Ø‡∂±, ‡∑Ä‡∑í‡∂Ø‡∑ö‡∑Å ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂≠‡∑è.",
    ta: "‡Æ∞‡Ææ‡Æï‡ØÅ ‡Æ§‡Æö‡Øà: ‡ÆÜ‡Æö‡Øà, ‡Æï‡ØÅ‡Æ¥‡Æ™‡Øç‡Æ™‡ÆÆ‡Øç, ‡Æ™‡ØÅ‡Æ§‡ØÅ‡ÆÆ‡Øà, ‡Æµ‡ØÜ‡Æ≥‡Æø‡Æ®‡Ææ‡Æü‡Øç‡Æü‡ØÅ ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ."
  },
  "Jupiter": {
    en: "Jupiter Dasha: Wisdom, growth, children, education, prosperity.",
    si: "‡∂ú‡∑î‡∂ª‡∑î ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂¥‡∑ä‚Äç‡∂ª‡∂•‡∑è‡∑Ä, ‡∑Ä‡∂ª‡∑ä‡∂∞‡∂±‡∂∫, ‡∂Ø‡∂ª‡∑î‡∑Ä‡∂±‡∑ä, ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±‡∂∫, ‡∑É‡∑û‡∂∑‡∑è‡∂ú‡∑ä‚Äç‡∂∫‡∂∫.",
    ta: "‡Æï‡ØÅ‡Æ∞‡ØÅ ‡Æ§‡Æö‡Øà: ‡Æû‡Ææ‡Æ©‡ÆÆ‡Øç, ‡Æµ‡Æ≥‡Æ∞‡Øç‡Æö‡Øç‡Æö‡Æø, ‡Æ™‡Æø‡Æ≥‡Øç‡Æ≥‡Øà, ‡Æï‡Æ≤‡Øç‡Æµ‡Æø, ‡Æö‡ØÜ‡Æ¥‡Æø‡Æ™‡Øç‡Æ™‡ØÅ."
  },
  "Saturn": {
    en: "Saturn Dasha: Hard work, delays, discipline, karma, spirituality.",
    si: "‡∑Å‡∂±‡∑í ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂Ø‡∑ê‡∂©‡∑í‡∂¥‡∑ô‡∑Ö‡∂¥‡∑è‡∂Ω‡∑í, ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂Ø, ‡∂Ö‡∂±‡∑î‡∂¥‡∑í‡∑Ö‡∑í‡∑Ä‡∑ô‡∑Ö, ‡∂ö‡∂ª‡∑ä‡∂∏‡∂∫, ‡∂Ü‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂∫.",
    ta: "‡Æö‡Æ©‡Æø ‡Æ§‡Æö‡Øà: ‡Æï‡Æü‡Æø‡Æ© ‡Æâ‡Æ¥‡Øà‡Æ™‡Øç‡Æ™‡ØÅ, ‡Æ§‡Ææ‡ÆÆ‡Æ§‡ÆÆ‡Øç, ‡Æí‡Æ¥‡ØÅ‡Æô‡Øç‡Æï‡ØÅ, ‡Æï‡Æ∞‡Øç‡ÆÆ‡Ææ, ‡ÆÜ‡Æ©‡Øç‡ÆÆ‡Æø‡Æï‡ÆÆ‡Øç."
  },
  "Mercury": {
    en: "Mercury Dasha: Intellect, communication, studies, business, wit.",
    si: "‡∂∂‡∑î‡∂∞ ‡∂Ø‡∑Å‡∑è‡∑Ä: ‡∂∂‡∑î‡∂Ø‡∑ä‡∂∞‡∑í‡∂∫, ‡∑É‡∂Ç‡∑Ä‡∑è‡∂Ø‡∂∫, ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±, ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑è‡∂ª, ‡∂†‡∑è‡∂≠‡∑î‡∂ª‡∑í‡∂∫.",
    ta: "‡Æ™‡ØÅ‡Æ§‡Æ©‡Øç ‡Æ§‡Æö‡Øà: ‡Æ™‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡Æö‡Ææ‡Æ≤‡Æø, ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ, ‡Æï‡Æ≤‡Øç‡Æµ‡Æø, ‡Æµ‡Æ£‡Æø‡Æï‡ÆÆ‡Øç, ‡Æ®‡ÆØ‡ÆÆ‡Øç."
  }
};
// --- Helpers ---
function parseLocalISO(iso){
  if(!iso) return new Date();
  const [d,t='00:00'] = iso.split('T');
  const [Y,M,D] = d.split('-').map(Number);
  const [h=0,m=0] = t.split(':').map(Number);
  return new Date(Y, (M||1)-1, D||1, h||0, m||0, 0);
}
function addDays(date, days){
  const d = new Date(date.getTime());
  d.setDate(d.getDate() + days);
  return d;
}
const Y2D = y => y * 365.2425;
function fmt(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function toUTC(dt, tz){
  const d = parseLocalISO(dt);
  const sign = tz[0]==='-'?-1:1;
  const [h,m] = tz.slice(1).split(':').map(Number);
  d.setHours(d.getHours() - sign*h);
  d.setMinutes(d.getMinutes() - sign*m);
  return d;
}
function norm360(d){ return ((d%360)+360)%360; }
const NAK_LEN = 360/27; // 13¬∞20'
function nakshatraLordIndex(moonDeg){
  const ix27 = Math.floor(norm360(moonDeg) / NAK_LEN);
  return ix27 % 9;
}
function computeVimshottariDasha(moonDeg, birthISO, maxYears = 120){
  const startDate = parseLocalISO(birthISO);
  const orderStart = nakshatraLordIndex(moonDeg);
  const posInNak = norm360(moonDeg) % NAK_LEN;
  const fracLeft = 1 - (posInNak / NAK_LEN);
  const startLord = MD_ORDER[orderStart];
  const out = [];
  let cursor = new Date(startDate.getTime());
  // first (balance) dasha
  const firstYears = startLord.years * fracLeft;
  let end = addDays(cursor, Y2D(firstYears));
  out.push({ lord: startLord.lord, start: new Date(cursor), end, years: firstYears });
  cursor = new Date(end.getTime());
  // subsequent full dashas
  let totalYears = firstYears;
  let i = (orderStart + 1) % 9;
  while (totalYears < maxYears - 1e-6) {
    const lord = MD_ORDER[i];
    const durYears = Math.min(lord.years, Math.max(0, maxYears - totalYears));
    const nextEnd = addDays(cursor, Y2D(durYears));
    out.push({ lord: lord.lord, start: new Date(cursor), end: nextEnd, years: durYears });
    totalYears += durYears;
    cursor = nextEnd;
    i = (i + 1) % 9;
    if (out.length > 60) break;
  }
  return out;
}
function lordIndex(lord){ return MD_ORDER.findIndex(x=>x.lord===lord);}
function computeBhuktiForMahadasha(mahaLord, mahaStartDate, mahaYears){
  const startIx = lordIndex(mahaLord);
  if(startIx<0) return [];
  const seq = [...MD_ORDER.slice(startIx), ...MD_ORDER.slice(0, startIx)];
  const out = [];
  let cursor = new Date(mahaStartDate instanceof Date? mahaStartDate: new Date(mahaStartDate));
  const spanDays = Y2D(mahaYears);
  let accDays = 0;
  for(const seg of seq){
    const partYears = (seg.years/120)*mahaYears;
    const partDays = Y2D(partYears);
    const end = addDays(cursor, partDays);
    const safeEnd = accDays + partDays <= spanDays + 0.5 ? end : addDays(cursor, Math.max(0,spanDays-accDays));
    out.push({ lord: seg.lord, start: new Date(cursor), end: new Date(safeEnd), years: partYears });
    accDays += partDays; cursor = safeEnd;
    if(accDays >= spanDays - 0.5) break; if(out.length>20) break;
  }
  return out;
}
function subSegments(startLord){
  const i = MD_ORDER.findIndex(v=>v.lord===startLord);
  const seq = [...MD_ORDER.slice(i), ...MD_ORDER.slice(0,i)];
  let acc=0;
  const segs = seq.map(it=>{
    const len = 800 * (it.years/120); // 800 min (13¬∞20')
    const from=acc, to=acc+len; acc=to;
    return { lord:it.lord, from, to };
  });
  segs[segs.length-1].to=800;
  return segs;
}
function calculateMoonSubLord(moonDeg){
  const idx = Math.floor(norm360(moonDeg)/(360/27));
  const nak = NAKSHATRAS[idx];
  const startDeg = idx * (360/27);
  const deltaDeg = norm360(moonDeg-startDeg);
  const minutes = deltaDeg * 60;
  const seg = subSegments(nak.lord).find(s=>minutes>=s.from && minutes<s.to) || { lord:nak.lord };
  return seg.lord;
}
function calculateCuspalSubLords(ascDeg){
  let lords = [];
  for(let i=0; i<12; i++){
    const deg = norm360(ascDeg + i*30);
    const subLord = calculateMoonSubLord(deg);
    lords.push(`House ${i+1}: <b>${subLord}</b>`);
  }
  return lords;
}
function getRulingPlanets(planets){
  return "Ruling Planets: " + planets.slice(0,3).map(p=>p.name).join(', ');
}
function getSignificators(planets){
  return "Significators: " + planets.filter((p,i)=>i%2==0).map(p=>p.name).join(', ');
}
const SIGNS = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
function getMockPlanets(dt, lat, lon){
  const t = parseLocalISO(dt).getTime()/86400000;
  return [
    { name:'Sun', degree: norm360((t*0.985+120)%360) },
    { name:'Moon', degree: norm360((t*13.176+60)%360) },
    { name:'Mars', degree: norm360((t*0.524+330)%360) },
    { name:'Venus', degree: norm360((t*1.620+75)%360) },
    { name:'Mercury', degree: norm360((t*4.090+180)%360) },
    { name:'Jupiter', degree: norm360((t*0.083+60)%360) },
    { name:'Saturn', degree: norm360((t*0.033+310)%360) },
    { name:'Rahu', degree: 45 },{ name:'Ketu', degree: 225 }
  ];
}
function getPlanetStrengths(planets){
  // (Mock for Demo: Sun, Jupiter, Venus strong; Rahu, Mars weak; others neutral)
  return `<b>Planetary Strengths:</b>
    <ul>
      <li>Sun: Strong</li>
      <li>Jupiter: Strong</li>
      <li>Venus: Strong</li>
      <li>Rahu: Weak</li>
      <li>Mars: Weak</li>
      <li>Others: Moderate</li>
    </ul>`;
}
const summary = document.getElementById('summary');
const dashaTable = document.getElementById('dashaTable');
const bhuktiTable = document.getElementById('bhuktiTable');
const kpBoxes = document.getElementById('kpBoxes');
const moonSubLordDiv = document.getElementById('moonSubLord');
const cuspalSubLordsDiv = document.getElementById('cuspalSubLords');
const rulingPlanetsDiv = document.getElementById('rulingPlanets');
const significatorsDiv = document.getElementById('significators');
const pdfBtn = document.getElementById('pdfBtn');
const shareBtn = document.getElementById('shareBtn');
const predictionBox = document.getElementById('predictionBox');
const planetStrengthsDiv = document.getElementById('planetStrengths');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const modeBtn = document.getElementById('modeBtn');
const chartArea = document.getElementById('chartArea');

function showPrediction(lord){
  const pred = DASHA_PREDICTIONS[lord];
  if(!pred) { predictionBox.style.display='none'; return; }
  predictionBox.style.display = '';
  predictionBox.innerHTML = `<b>Prediction (‡∂¥‡∂Ω‡∑è‡∂¥‡∂Ω, ‡Æ™‡Æ≤‡Æ©‡Øç‡Æï‡Æ≥‡Øç):</b><br>
    <span style="color:#60a5fa">${pred.en}</span><br>
    <span style="color:#38bdf8">${pred.si}</span><br>
    <span style="color:#8b5cf6">${pred.ta}</span>`;
}
function showChart(name, dt, tz, lat, lon, place){
  chartArea.style.display = '';
  summary.innerHTML = `<span class="pill">Name: ${name}</span>
    <span class="pill">Date/Time: ${dt}</span>
    <span class="pill">TZ: ${tz}</span>
    <span class="pill">Lat: ${lat}</span>
    <span class="pill">Lon: ${lon}</span>
    <span class="pill">Place: ${place}</span>
    <br><br>
    <i>Vimshottari Dasha method divides life into planetary periods (Maha Dasha, Bhukti, etc) based on Moon's nakshatra at birth. The exact starting point is calculated from the fractional balance of Moon's position in its Nakshatra, allowing fine-grained prediction of life events.<br>
    ‡∑Ä‡∑í‡∂∏‡∑í‡∑Å‡∑ù‡∂≠‡∑ä‡∂≠‡∂ª‡∑í ‡∂Ø‡∑Å‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∂∏‡∂∫ ‡∂∫‡∂±‡∑î, ‡∂¢‡∂±‡∂±‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂†‡∂±‡∑ä‡∂Ø‡∑ä‚Äç‡∂ª‡∂∫‡∑è ‡∂¥‡∑í‡∑Ñ‡∑í‡∂ß‡∂± ‡∂±‡∂ö‡∑ä‡∑Ç‡∂≠‡∑ä‚Äç‡∂ª‡∂∫ ‡∂∏‡∂≠ ‡∂¥‡∂Ø‡∂±‡∂∏‡∑ä‡∑Ä ‡∂¢‡∑ì‡∑Ä‡∑í‡∂≠‡∂∫ ‡∂∏‡∑Ñ‡∑è‡∂Ø‡∑Å‡∑è, ‡∂∑‡∑î‡∂ö‡∑ä‡∂≠‡∑í ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∂ª‡∂± ‡∂ö‡∑ä‚Äç‡∂ª‡∂∏‡∂∫‡∂ö‡∑í. ‡∂±‡∂ö‡∑ä‡∑Ç‡∂≠‡∑ä‚Äç‡∂ª‡∂∫‡∑ö ‡∂â‡∂≠‡∑í‡∂ª‡∑í ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂ö‡∑è‡∂Ω ‡∑É‡∑ì‡∂∏‡∑è‡∑Ä‡∂±‡∑ä ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í.<br>
    ‡Æµ‡Æø‡Æ£‡Øç‡ÆÆ‡ØÄ‡Æ©‡Øç ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ∞‡Æ©‡Øç ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Øä‡Æ£‡Øç‡Æü‡ØÅ, ‡ÆÆ‡Æï‡Ææ ‡Æ§‡Æö‡Øà, ‡Æ™‡ØÅ‡Æï‡Øç‡Æ§‡Æø ‡Æ™‡Øã‡Æ©‡Øç‡Æ±‡Æµ‡Øà ‡Æï‡Æ£‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æø‡Æ®‡Øç‡Æ§‡Øã‡Æ§‡Øç‡Æ§‡Æ∞‡Æø ‡Æ§‡Æö‡Øà ‡ÆÆ‡ØÅ‡Æ±‡Øà‡ÆØ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç. ‡Æ®‡Æï‡Øç‡Æ∑‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ∞‡Æ©‡Øç ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æü‡ÆÆ‡Øç ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æ§‡ØÅ‡Æµ‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç, ‡ÆÆ‡ØÄ‡Æ§‡ÆÆ‡ØÅ‡Æ≥‡Øç‡Æ≥ ‡Æï‡Ææ‡Æ≤‡Æ§‡Øç‡Æ§‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Æ£‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç.</i>
    `;
  const dtUTC = toUTC(dt, tz);
  const planets = getMockPlanets(dt, lat, lon);
  const moon = planets.find(p=>p.name==='Moon');
  const maha = computeVimshottariDasha(moon.degree, dt, 120);
  dashaTable.innerHTML = '';
  maha.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.lord}</td><td>${fmt(r.start)}</td><td>${fmt(r.end)}</td><td class="mono">${r.years.toFixed(2)}</td>`;
    tr.style.cursor = 'pointer';
    tr.onclick = ()=>{
      showBhukti(r);
      showPrediction(r.lord);
    };
    dashaTable.appendChild(tr);
  });
  showBhukti(maha[0]);
  showPrediction(maha[0].lord);
  kpBoxes.innerHTML = '';
  planets.forEach((p,i)=>{
    const signIx = Math.floor(norm360(p.degree)/30);
    const box = document.createElement('div');
    box.className = 'kpBox' + (i==0?' asc':'');
    box.innerHTML = `<div>${p.name}</div><div>${SIGNS[signIx]} ${norm360(p.degree).toFixed(2)}¬∞</div>`;
    kpBoxes.appendChild(box);
  });
  moonSubLordDiv.innerHTML = `üåô Moon Sub-Lord: <b>${calculateMoonSubLord(moon.degree)}</b>`;
  cuspalSubLordsDiv.innerHTML = "<b>Cuspal Sub-Lords:</b> " + calculateCuspalSubLords(planets[0].degree).join(', ');
  rulingPlanetsDiv.innerHTML = getRulingPlanets(planets);
  significatorsDiv.innerHTML = getSignificators(planets);
  planetStrengthsDiv.innerHTML = getPlanetStrengths(planets);
}
function showBhukti(maha){
  if(!maha) return;
  bhuktiTable.innerHTML = '';
  const bhukti = computeBhuktiForMahadasha(maha.lord, maha.start, maha.years);
  bhukti.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.lord}</td><td>${fmt(r.start)}</td><td>${fmt(r.end)}</td><td class="mono">${r.years.toFixed(2)}</td>`;
    tr.onclick = ()=>showPrediction(r.lord);
    bhuktiTable.appendChild(tr);
  });
}
pdfBtn.onclick = ()=>{ window.print(); };
shareBtn.onclick = ()=>{
  const params = [
    'name='+encodeURIComponent(document.getElementById('name').value),
    'dt='+encodeURIComponent(document.getElementById('date').value+'T'+document.getElementById('time').value),
    'tz='+encodeURIComponent(document.getElementById('timezone').value),
    'lat='+encodeURIComponent(document.getElementById('lat').value),
    'lon='+encodeURIComponent(document.getElementById('lon').value),
    'place='+encodeURIComponent(document.getElementById('place').value)
  ].join('&');
  const url = location.origin+location.pathname+'?'+params;
  navigator.clipboard.writeText(url);
  alert('Chart link copied!');
};
saveBtn.onclick = ()=>{
  const data = {
    name: document.getElementById('name').value,
    dt: document.getElementById('date').value+'T'+document.getElementById('time').value,
    tz: document.getElementById('timezone').value,
    lat: document.getElementById('lat').value,
    lon: document.getElementById('lon').value,
    place: document.getElementById('place').value
  };
  localStorage.setItem('kp_last_chart', JSON.stringify(data));
  alert('Chart saved!');
};
loadBtn.onclick = ()=>{
  const dat = JSON.parse(localStorage.getItem('kp_last_chart')||'null');
  if(!dat){ alert('No saved chart found.'); return; }
  document.getElementById('name').value = dat.name;
  const [d,t] = (dat.dt||'').split('T');
  document.getElementById('date').value = d||'';
  document.getElementById('time').value = t||'12:00';
  document.getElementById('timezone').value = dat.tz;
  document.getElementById('lat').value = dat.lat;
  document.getElementById('lon').value = dat.lon;
  document.getElementById('place').value = dat.place;
  birthForm.dispatchEvent(new Event('submit'));
};
modeBtn.onclick = ()=>{
  const b = document.body;
  if(b.classList.contains('dark')){
    b.classList.remove('dark'); b.classList.add('light');
    modeBtn.textContent = "üåô";
  }else{
    b.classList.remove('light'); b.classList.add('dark');
    modeBtn.textContent = "‚òÄÔ∏è";
  }
};
function fromParams(){
  const u = new URL(location.href);
  const get = (k) => u.searchParams.get(k) || '';
  if(get('name') && get('dt') && get('lat') && get('lon')){
    document.getElementById('name').value = get('name');
    const [d, t] = (get('dt')||'').split('T');
    document.getElementById('date').value = d || '';
    document.getElementById('time').value = t || '12:00';
    document.getElementById('timezone').value = get('tz')||'+05:30';
    document.getElementById('lat').value = get('lat');
    document.getElementById('lon').value = get('lon');
    document.getElementById('place').value = get('place');
    birthForm.dispatchEvent(new Event('submit'));
  }
}
// On page load, show map if lat/lon present & params
window.addEventListener('DOMContentLoaded',()=>{
  const lat=document.getElementById('lat').value,lon=document.getElementById('lon').value;
  if(lat&&lon){ showMap(lat,lon);}
  if(typeof fromParams==="function") fromParams();
});
</script>
</body>
</html>
