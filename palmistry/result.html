<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palmistry · PDF Report</title>
<style>
  :root{ --ink:#0b0f16; --mut:#4b5563; --pri:#111827; --accent:#0ea5e9; --good:#16a34a; --bad:#ef4444; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Inter,Arial; color:#111; background:#f8fafc; }
  .sheet{ max-width:820px; margin:0 auto; background:#fff; padding:28px 28px 36px; }
  header{ text-align:center; border-bottom:2px solid #e5e7eb; padding-bottom:8px; margin-bottom:14px; }
  header h1{ margin:4px 0 2px; font-size:24px; color:#0ea5e9; }
  header small{ color:#6b7280 }
  .meta{ display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; margin:10px 0 16px; color:#374151; }
  .badge{ display:inline-block; border:1px solid #d1d5db; border-radius:999px; padding:2px 10px; font-size:12px; }
  .row{ display:flex; gap:14px; flex-wrap:wrap; }
  .card{ border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
  h2{ font-size:18px; margin:0 0 8px; color:#111827 }
  h3{ font-size:15px; margin:14px 0 6px; color:#111827 }
  ul{ margin:6px 0 4px 18px; }
  .imgs{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  figure{ margin:0 }
  .bw{ width:100%; border-radius:10px; border:1px solid #e5e7eb; display:block;
       filter: grayscale(100%) contrast(140%) brightness(102%); }
  .cap{ text-align:center; color:#6b7280; font-size:12px; margin-top:4px }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; }
  th{ text-align:left; color:#1f2937; }
  .delta{ font-weight:700 }
  .delta.up{ color:var(--good) }
  .delta.down{ color:var(--bad) }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .mut{ color:#6b7280 }
  .disclaimer{ font-size:12px; color:#374151; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:8px; padding:10px; }
  .footer{ margin-top:12px; display:flex; justify-content:space-between; align-items:center; color:#6b7280; font-size:12px }
  .btns{ display:flex; gap:8px; justify-content:flex-end; margin:10px auto 16px; max-width:820px }
  button{ border:1px solid #cbd5e1; background:#0ea5e9; color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer }
  .btn-light{ background:#fff; color:#0ea5e9 }
  @media print{
    body{ background:#fff }
    .btns{ display:none }
    .sheet{ box-shadow:none; page-break-after:always }
  }
</style>
</head>
<body>
<div class="btns">
  <button class="btn-light" id="loadPair">Load Last Pair</button>
  <button onclick="window.print()">Print / Save as PDF</button>
</div>

<div class="sheet" id="sheet">
  <header>
    <h1>Palmistry Report</h1>
    <small>Left = Past · Right = Present · ΔK = change (Present − Past)</small>
  </header>

  <div class="meta">
    <div>
      <div><b>Client:</b> <span id="clientName">—</span></div>
      <div class="mut">Pair ID: <span id="pairId">—</span></div>
    </div>
    <div>
      <span class="badge">Generated: <span id="genAt">—</span></span>
      <span class="badge">Engine v4</span>
    </div>
  </div>

  <section class="card">
    <h2>Hand Photos (B/W enhanced for line clarity)</h2>
    <div class="imgs">
      <figure>
        <img id="imgL" class="bw" alt="Left hand (Past)"/>
        <figcaption class="cap">Left (Past)</figcaption>
      </figure>
      <figure>
        <img id="imgR" class="bw" alt="Right hand (Present)"/>
        <figcaption class="cap">Right (Present)</figcaption>
      </figure>
    </div>
  </section>

  <section class="row">
    <article class="card" style="flex:1">
      <h2>Past (Left) – Highlights</h2>
      <div id="pastInsight" class="mut">—</div>
      <h3>Line Scores</h3>
      <table id="tblPast"></table>
    </article>

    <article class="card" style="flex:1">
      <h2>Present (Right) – Highlights</h2>
      <div id="presInsight" class="mut">—</div>
      <h3>Line Scores</h3>
      <table id="tblPres"></table>
    </article>
  </section>

  <section class="card">
    <h2>ΔK Comparison</h2>
    <table id="tblDelta">
      <thead><tr><th>Line</th><th>Past</th><th>Present</th><th>ΔK</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="grid-2">
      <div>
        <h3>Summary</h3>
        <ul id="deltaSummary" class="mut"></ul>
      </div>
      <div>
        <h3>Vitality Trend Index</h3>
        <div class="mut" id="vtiText">—</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Interpretive Notes</h2>
    <p class="mut">
      • Insights are symbolic reflections from palm lines (Heart, Head, Life, Fate, Sun, Mercury, Marriage).
      We avoid exact age predictions (e.g., marriage age or lifespan). Instead we describe <b>trends</b>,
      <b>windows</b>, and <b>relative changes</b>.
    </p>
    <div class="disclaimer">
      <b>Disclaimer.</b> This report is for personal reflection. It is <i>not</i> medical, legal, or
      financial advice. For health concerns, consult qualified professionals.
    </div>
  </section>

  <div class="footer">
    <div>© 2025 Sathyadarshana · Palmistry Research Division</div>
    <div><b>Deep Analysis</b> (extended narrative & Q&A) — <b>$5</b></div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const KEY='palmistryResults';
const q = sel => document.querySelector(sel);
const fmt = ts => {
  const d=new Date(ts||Date.now()), pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
};
function loadAll(){
  try{ return JSON.parse(localStorage.getItem(KEY)||'[]') || []; }catch{ return []; }
}
function vitalityTrend(lines){
  const L=lines.life?.score||0, S=lines.sun?.score||0, M=lines.mercury?.score||0;
  return Math.round(0.5*L + 0.3*S + 0.2*M); // not medical prediction
}
function marriageWindow(lines){
  const m=lines.marriage?.score||0;
  if(m>=75) return 'Partnership window strong (mid–early)';
  if(m>=55) return 'Moderate partnership window (mid)';
  return 'Evolving window (later / focus on presence)';
}
function strongestAndTender(lines){
  const arr=Object.entries(lines).map(([k,v])=>[k, v?.score||0]);
  arr.sort((a,b)=>b[1]-a[1]);
  return {hi:arr[0], lo:arr[arr.length-1]};
}
function makeRows(lines){
  const order=['heart','head','life','fate','sun','mercury','marriage'];
  const name={heart:'Heart',head:'Head',life:'Life',fate:'Fate',sun:'Sun',mercury:'Mercury',marriage:'Marriage'};
  return order.map(k=>`<tr><th>${name[k]}</th><td>${lines?.[k]?.score ?? '—'}</td></tr>`).join('');
}

/* ===== Load by pairId =====
   URL options:
   - ?pair=<PAIR_ID>   -> pick exact pair
   - if missing        -> use the most recent pair with both hands
*/
function pickPair(){
  const all=loadAll();
  const url = new URL(location.href);
  const req = url.searchParams.get('pair');

  function groupByPair(a){
    const m={}; for(const r of a){ const id=r.pairId||`solo-${r.ts}`; (m[id]??=( {id,left:null,right:null} ))[r.hand]=r; }
    return Object.values(m);
  }
  const groups = groupByPair(all).filter(p=>p.left || p.right);
  if(!groups.length) return null;

  if(req){
    const g=groups.find(x=>x.id===req);
    return g||null;
  }
  // otherwise pick newest having both (prefer), else newest any
  groups.sort((a,b)=>(Math.max(a.left?.ts||0,a.right?.ts||0) - Math.max(b.left?.ts||0,b.right?.ts||0))).reverse();
  const both = groups.find(p=>p.left && p.right);
  return both || groups[0];
}

/* ===== Render ===== */
function render(){
  const pair = pickPair();
  if(!pair){ alert('No saved results found. Generate in Analyzer first.'); return; }

  q('#pairId').textContent = pair.id;
  q('#genAt').textContent = fmt(Date.now());
  q('#clientName').textContent = '—'; // optional: fill from a form later

  if(pair.left?.thumb)  q('#imgL').src = pair.left.thumb;
  if(pair.right?.thumb) q('#imgR').src = pair.right.thumb;

  // Past / Present tables + insights
  q('#tblPast').innerHTML = makeRows(pair.left?.lines||{});
  q('#tblPres').innerHTML = makeRows(pair.right?.lines||{});

  function insight(which, rec){
    if(!rec){ q(which).textContent='—'; return; }
    const {hi,lo}=strongestAndTender(rec.lines||{});
    const names={heart:'Heart',head:'Head',life:'Life',fate:'Fate',sun:'Sun',mercury:'Mercury',marriage:'Marriage'};
    const parts=[];
    parts.push(`Confidence: ${rec.meta?.confidence ?? '—'}%`);
    parts.push(`Strongest → ${names[hi[0]]} (${hi[1]})`);
    parts.push(`Tender   → ${names[lo[0]]} (${lo[1]})`);
    if(hi[0]==='marriage' || lo[0]==='marriage'){ parts.push(`Partnership: ${marriageWindow(rec.lines)}`); }
    q(which).innerHTML = parts.map(p=>`<div>• ${p}</div>`).join('');
  }
  insight('#pastInsight', pair.left);
  insight('#presInsight', pair.right);

  // ΔK table
  const order=['heart','head','life','fate','sun','mercury','marriage'];
  const name={heart:'Heart',head:'Head',life:'Life',fate:'Fate',sun:'Sun',mercury:'Mercury',marriage:'Marriage'};
  const tbody = q('#tblDelta tbody');
  tbody.innerHTML='';
  for(const k of order){
    const L=pair.left?.lines?.[k]?.score ?? null;
    const R=pair.right?.lines?.[k]?.score ?? null;
    const d = (R!=null && L!=null) ? (R-L) : null;
    const cls = d==null?'':(d>1?'up':(d<-1?'down':''));
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${name[k]}</td><td>${L??'—'}</td><td>${R??'—'}</td><td class="delta ${cls}">${d==null?'—':(d>0?'+':'')+d}</td></tr>`);
  }

  // VTI
  const vtiL = pair.left ? vitalityTrend(pair.left.lines) : null;
  const vtiR = pair.right ? vitalityTrend(pair.right.lines): null;
  q('#vtiText').innerHTML =
    `Past VTI: <b>${vtiL ?? '—'}</b> · Present VTI: <b>${vtiR ?? '—'}</b>` +
    (vtiL!=null && vtiR!=null ? ` · ΔK: <b>${(vtiR - vtiL > 0? '+':'') + (vtiR - vtiL)}</b>` : '') +
    `<div class="mut">(Vitality Trend Index is heuristic, not a lifespan prediction.)</div>`;

  // Delta summary
  const deltas = order.map(k=>{
    const L=pair.left?.lines?.[k]?.score ?? null;
    const R=pair.right?.lines?.[k]?.score ?? null;
    return [k, (R!=null && L!=null) ? (R-L) : null];
  }).filter(([k,d])=>d!=null);
  deltas.sort((a,b)=>Math.abs(b[1])-Math.abs(a[1]));
  q('#deltaSummary').innerHTML = deltas.slice(0,3).map(([k,d])=>{
    const label=name[k], pol=d>0?'+':''; const cls=d>0?'style="color:var(--good)"':'style="color:var(--bad)"';
    return `<li>${label}: <b ${cls}>${pol}${d}</b></li>`;
  }).join('');
}

document.getElementById('loadPair').onclick = render;
window.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
