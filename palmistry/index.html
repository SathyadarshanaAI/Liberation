<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quantum Palm Analyzer v4.5.2</title>
<style>
:root{--bg:#0b0f16;--card:#0f172a;--neon:#00e5ff;--pri:#16f0a7;--mut:#a9c2da}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#0e2133,#0b0f16);color:#e6f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
h1{margin:12px 0 6px;text-align:center;color:var(--neon)}
.wrap{max-width:1000px;margin:0 auto;padding:10px}

/* buttons */
.btn,button,a{background:#0d1522;color:#c7e8ff;border:1px solid #1a3a55;border-radius:22px;
  padding:12px 16px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
.btn:hover,button:hover,a:hover{background:#00e5ff;color:#001015;border-color:#00e5ff}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:8px 0 12px}

/* options dropdown */
.drop{position:relative}
.drop>.menu{position:absolute;right:0;top:42px;background:#0b1320;border:1px solid #17324a;border-radius:12px;min-width:220px;display:none;flex-direction:column;overflow:hidden;z-index:5}
.drop.open>.menu{display:flex}
.menu button{justify-content:space-between;border:0;border-bottom:1px solid #17324a;border-radius:0;background:#0b1320;padding:10px 12px}
.menu button:last-child{border-bottom:0}

/* camera */
.camWrap{display:grid;place-items:center}
.camBox{position:relative;width:min(96vw,720px);aspect-ratio:3/4;border-radius:16px;border:2px solid #00d0ff;overflow:hidden;background:#000}
.camBox video,.camBox canvas,.camBox .aura{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:16px}
#video[hidden]{display:none}
.aura{mix-blend-mode:screen;background:conic-gradient(from 0deg,#00e5ff88,#16f0a788,#9a6bff88,#00e5ff88);animation:spin 6s linear infinite;opacity:.7}
@keyframes spin{to{transform:rotate(360deg)}}

/* cards */
.card{background:linear-gradient(180deg,#101a2b,#0c1320);border:1px solid #133149;border-radius:16px;padding:14px;margin-top:12px}
.badge{display:inline-block;background:#0b1320;border:1px solid #17324a;border-radius:10px;padding:3px 8px;font-size:12px;color:#9edcff}

/* bars */
.lines{display:grid;grid-template-columns:1fr;gap:8px}
.row{display:grid;grid-template-columns:240px 1fr;gap:10px;align-items:center}
.bar{background:#0b1320;height:12px;border-radius:10px;overflow:hidden}
.bar>span{display:block;height:100%;transform-origin:left center;transform:scaleX(0);transition:transform 900ms ease}
.bar.h>span{background:linear-gradient(90deg,#ff6b6b,#ff3b3b)}   /* Heart */
.bar.hh>span{background:linear-gradient(90deg,#60a5fa,#3b82f6)}   /* Mind */
.bar.l>span{background:linear-gradient(90deg,#34d399,#10b981)}    /* Life */
.bar.f>span{background:linear-gradient(90deg,#f59e0b,#fbbf24)}    /* Fate */
.bar.s>span{background:linear-gradient(90deg,#f97316,#fb923c)}    /* Success */
.bar.hl>span{background:linear-gradient(90deg,#a78bfa,#8b5cf6)}   /* Health */
.bar.mar>span{background:linear-gradient(90deg,#f472b6,#ec4899)}  /* Marriage */

/* legend */
.legend{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
.legend .item{display:flex;align-items:center;gap:8px;font-size:14px;color:#d7e8ff}
.sw{width:14px;height:14px;border-radius:4px}
.sw.h{background:#ff4f56}.sw.hh{background:#5aa2ff}.sw.l{background:#15c194}
.sw.f{background:#f6a911}.sw.s{background:#fb8a2d}.sw.hl{background:#8b5cf6}.sw.mar{background:#ec4899}

/* radar */
#radar{display:block;margin:10px auto;background:#0b1320;border:1px solid #17324a;border-radius:12px}

/* notice */
.notice{max-width:1000px;margin:8px auto 0;background:#1b2636;border:1px solid #2d4a68;color:#e6f0ff;border-radius:12px;padding:10px 12px;box-shadow:0 4px 18px #0007}
.notice strong{color:#16f0a7}
.notice-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <h1>Quantum Palm Analyzer v4.5.2</h1>

  <!-- Toolbar -->
  <div class="toolbar">
    <a class="btn" href="../astrology.html">← Back</a>
    <button class="btn" id="startCam">📷 Start</button>
    <button class="btn" id="flashBtn">⚡ Flash</button>
    <button class="btn" id="switchBtn">🔁 Switch Cam</button>
    <button class="btn" id="capture">Capture</button>
    <label class="btn" for="filePick">Upload Photo</label>
    <input id="filePick" type="file" accept="image/*" hidden/>
    <button class="btn" id="analyze">Analyze</button>
    <button class="btn" id="save">💾 Save</button>
    <button class="btn" id="summaryBtn">🧾 Pair Summary</button>
    <button class="btn" id="pdfBtn">⬇️ Full Report (PDF)</button>

    <!-- Options -->
    <div class="drop" id="optDrop">
      <button class="btn" id="optBtn">⋮ Options</button>
      <div class="menu">
        <button id="optGrid">Toggle Grid</button>
        <button id="optClear">Clear Saved Results</button>
        <button id="optHelp">Help</button>
        <button id="optAbout">About v4.5.2</button>
      </div>
    </div>
  </div>

  <!-- Quality notice -->
  <div id="notice" class="notice" style="display:none">
    <div id="noticeText">Guidance…</div>
    <div class="notice-actions">
      <button id="noticeSwitch" class="btn" style="display:none">Switch Hand</button>
      <button id="noticeOk" class="btn">OK</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Camera + hand select -->
    <div class="card">
      <div class="toolbar" style="margin-top:0;justify-content:flex-start;gap:8px">
        <span class="badge">Hand</span>
        <select id="handSel" class="btn" style="padding:8px 12px;border-radius:12px">
          <option value="left">Left (Past)</option>
          <option value="right">Right (Present)</option>
        </select>
        <span id="pairBadge" class="badge">pair: —</span>
      </div>

      <div class="camWrap">
        <div class="camBox" id="camBox">
          <video id="video" playsinline autoplay muted hidden></video>
          <canvas id="canvas"></canvas>
          <div class="aura" aria-hidden="true"></div>
        </div>
      </div>
      <div style="text-align:center;margin-top:6px" id="status" class="badge">No image yet</div>
    </div>

    <!-- Bars + legend -->
    <div class="card">
      <div class="badge" id="conf">Confidence —</div>
      <div class="lines">
        <div class="row"><div>❤️ Heart line</div>    <div class="bar h"><span id="b0"></span></div></div>
        <div class="row"><div>🧠 Mind line</div>     <div class="bar hh"><span id="b1"></span></div></div>
        <div class="row"><div>🌿 Life line</div>     <div class="bar l"><span id="b2"></span></div></div>
        <div class="row"><div>🜂 Fate line</div>     <div class="bar f"><span id="b3"></span></div></div>
        <div class="row"><div>🏆 Success line</div>  <div class="bar s"><span id="b4"></span></div></div>
        <div class="row"><div>🩺 Health line</div>   <div class="bar hl"><span id="b5"></span></div></div>
        <div class="row"><div>💍 Marriage line</div> <div class="bar mar"><span id="b6"></span></div></div>
      </div>

      <div class="legend">
        <div class="item"><span class="sw h"></span>Heart line</div>
        <div class="item"><span class="sw hh"></span>Mind line</div>
        <div class="item"><span class="sw l"></span>Life line</div>
        <div class="item"><span class="sw f"></span>Fate line</div>
        <div class="item"><span class="sw s"></span>Success line</div>
        <div class="item"><span class="sw hl"></span>Health line</div>
        <div class="item"><span class="sw mar"></span>Marriage line</div>
      </div>
    </div>

    <!-- Radar + Insight -->
    <div class="card">
      <canvas id="radar" width="320" height="240"></canvas>
      <pre id="insight" style="white-space:pre-wrap;text-align:left;margin:6px auto;max-width:720px">Run Analyze to generate insight…</pre>
    </div>

    <!-- Pair Summary -->
    <div class="card" id="pairSummary" style="display:none">
      <h3 style="margin:0 0 8px">Pair Summary — Left (Past) vs Right (Present)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start">
        <div>
          <img id="sumLeft" alt="Left (Past)" style="width:100%;border-radius:12px;border:1px solid #17324a;filter:grayscale(100%) contrast(130%)"/>
          <div class="badge">Past (Left)</div>
          <div id="txtLeft" style="margin-top:6px;white-space:pre-wrap"></div>
        </div>
        <div>
          <img id="sumRight" alt="Right (Present)" style="width:100%;border-radius:12px;border:1px solid #17324a;filter:grayscale(100%) contrast(130%)"/>
          <div class="badge">Present (Right)</div>
          <div id="txtRight" style="margin-top:6px;white-space:pre-wrap"></div>
        </div>
      </div>
      <div class="badge" id="deltaBadge" style="margin-top:8px">ΔK —</div>
      <div class="badge" style="margin-top:6px">Note: Symbolic trend reading; no exact ages or medical claims.</div>
    </div>
  </div>

<script>
/* ====== options dropdown ====== */
const optDrop=document.getElementById('optDrop');
document.getElementById('optBtn').onclick=()=>optDrop.classList.toggle('open');
window.addEventListener('click',e=>{if(!optDrop.contains(e.target)) optDrop.classList.remove('open');});
document.getElementById('optGrid').onclick=()=>{
  const box=document.getElementById('camBox');
  box.style.backgroundImage = box.style.backgroundImage ? '' :
    'linear-gradient(#00e5ff22 1px,transparent 1px),linear-gradient(90deg,#00e5ff22 1px,transparent 1px)';
  box.style.backgroundSize='20px 20px';
};
document.getElementById('optClear').onclick=()=>{localStorage.removeItem('palmistryResults');alert('Saved results cleared.');};
document.getElementById('optHelp').onclick=()=>alert('Tip: good light, full palm in frame, include wrist lines. Use Upload if camera is blocked.');
document.getElementById('optAbout').onclick=()=>alert('Quantum Palm Analyzer v4.5.2 — Unlocked PDF report.');

/* ====== storage & pair id ====== */
const PR_KEY='palmistryResults',PAIR_KEY='currentPairId';
const handSel=document.getElementById('handSel'),pairBadge=document.getElementById('pairBadge');
const prLoad=()=>{try{return JSON.parse(localStorage.getItem(PR_KEY)||'[]')}catch{return[]}};
const prSave=a=>localStorage.setItem(PR_KEY,JSON.stringify(a));
const prAdd=o=>{const a=prLoad();a.push(o);prSave(a);};
const getPairId=()=>localStorage.getItem(PAIR_KEY)||null;
const setPairId=id=>{localStorage.setItem(PAIR_KEY,id);pairBadge.textContent='pair: '+(id||'—');};
(function(){pairBadge.textContent='pair: '+(getPairId()||'—');})();

/* ====== camera ====== */
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');const ctx=canvas.getContext('2d');
const camBox=document.getElementById('camBox');const statusBox=document.getElementById('status');
let mediaStream=null,camFacing='environment';
function sizeCanvas(){const r=camBox.getBoundingClientRect();const d=Math.min(window.devicePixelRatio||1,2);canvas.width=r.width*d;canvas.height=r.height*d;}
new ResizeObserver(sizeCanvas).observe(camBox);sizeCanvas();

async function startCamera(){
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:camFacing}}});
    video.srcObject=mediaStream;video.hidden=false;statusBox.textContent='Camera active';
  }catch{alert('Camera access failed');}
}
document.getElementById('startCam').onclick=startCamera;
document.getElementById('switchBtn').onclick=async()=>{camFacing=(camFacing==='environment')?'user':'environment';await startCamera();};
function track(){return mediaStream?.getVideoTracks?.()[0]||video.srcObject?.getVideoTracks?.()[0]||null;}
document.getElementById('flashBtn').onclick=async()=>{
  const t=track(); if(!t){alert('Start camera first');return;}
  const caps=t.getCapabilities?t.getCapabilities():{}; if(!caps.torch){alert('Torch not supported');return;}
  const isOn=t.getSettings?.().torch; try{await t.applyConstraints({advanced:[{torch:!isOn}]});
  document.getElementById('flashBtn').textContent=(!isOn)?'⚡ Flash ON':'⚡ Flash';}catch{alert('Torch control failed');}
};
document.getElementById('capture').onclick=()=>{if(!video.srcObject){alert('Start camera first');return;}sizeCanvas();drawToCanvas(video);};
document.getElementById('filePick').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const img=new Image();img.onload=()=>{sizeCanvas();drawToCanvas(img);};img.src=URL.createObjectURL(f);
};
function drawToCanvas(src){
  const w=canvas.width,h=canvas.height;ctx.fillStyle='#000';ctx.fillRect(0,0,w,h);
  const sw=src.videoWidth||src.width,sh=src.videoHeight||src.height;const CR=w/h,R=sw/sh;
  let sx=0,sy=0,Ssw=sw,Ssh=sh; if(R>CR){Ssh=sh;Ssw=Ssh*CR;sx=(sw-Ssw)/2;}else{Ssw=sw;Ssh=Ssw/CR;sy=(sh-Ssh)/2;}
  ctx.drawImage(src,sx,sy,Ssw,Ssh,0,0,w,h);statusBox.textContent='Frame captured';runFrameQA();
}

/* ====== analyzer (placeholder heuristic) ====== */
const bars=[...Array(7)].map((_,i)=>document.getElementById('b'+i));
let lastResult=null;
document.getElementById('analyze').onclick=()=>{
  const pix=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  if(!pix||!pix.length){alert('Load an image first');return;}
  let sum=0;for(let i=0;i<pix.length;i+=24)sum+=pix[i]+pix[i+1]+pix[i+2];
  const avg=sum/(pix.length/24);const conf=Math.min(99,Math.max(60,avg/4));
  document.getElementById('conf').textContent='Confidence '+conf.toFixed(1)+'%';
  const sc=[80,74,70,60,66,75,55].map(v=>Math.min(100,v+(conf-80)/2)).map(v=>Math.round(v));
  sc.forEach((v,i)=>bars[i].style.transform=`scaleX(${v/100})`);
  drawRadar(sc);
  lastResult={confidence:Number(conf.toFixed(1)),lines:{heart:sc[0],mind:sc[1],life:sc[2],fate:sc[3],success:sc[4],health:sc[5],marriage:sc[6]}};
  document.getElementById('insight').textContent =
`Confidence ${lastResult.confidence}%
• Heart ${sc[0]}  • Mind ${sc[1]}
• Life  ${sc[2]}  • Fate ${sc[3]}
• Success ${sc[4]}  • Health ${sc[5]}  • Marriage ${sc[6]}
Insight: Balanced progress profile detected.`;
};
function drawRadar(a){
  const c=document.getElementById('radar'), g=c.getContext('2d');
  const w=c.width, h=c.height, cx=w/2, cy=h/2, R=Math.min(w,h)/2-18;
  g.clearRect(0,0,w,h); g.strokeStyle='#17324a'; g.lineWidth=1;
  for(let r=0.2;r<=1;r+=0.2){
    g.beginPath();
    for(let i=0;i<7;i++){const ang=i*2*Math.PI/7-Math.PI/2; const x=cx+Math.cos(ang)*R*r; const y=cy+Math.sin(ang)*R*r; i?g.lineTo(x,y):g.moveTo(x,y);}
    g.closePath(); g.stroke();
  }
  g.beginPath();
  for(let i=0;i<7;i++){const ang=i*2*Math.PI/7-Math.PI/2; const x=cx+Math.cos(ang)*R*(a[i]/100); const y=cy+Math.sin(ang)*R*(a[i]/100); i?g.lineTo(x,y):g.moveTo(x,y);}
  g.closePath(); g.fillStyle='rgba(22,240,167,.12)'; g.fill(); g.strokeStyle='#16f0a7'; g.stroke();
}

/* ====== Save to local storage ====== */
document.getElementById('save').onclick=()=>{
  if(!lastResult){alert('Analyze first');return;}
  let pid=getPairId(); if(!pid){pid=(crypto.randomUUID?.()||('pair_'+Date.now().toString(36))); setPairId(pid);}
  const entry={
    ts:Date.now(), pairId:pid, hand:handSel.value,
    thumb:canvas.toDataURL('image/jpeg',0.8),
    meta:{version:'4.5.2',confidence:lastResult.confidence},
    lines:lastResult.lines
  };
  prAdd(entry); alert('Saved.');
};

/* ====== Pair Summary ====== */
function latestPairWithBoth(){
  const all=prLoad(), map={};
  for(const r of all){
    const id=r.pairId || ('solo-'+r.ts);
    map[id]=map[id]||{id,left:null,right:null,ts:0};
    if(r.hand==='left') map[id].left=r;
    if(r.hand==='right') map[id].right=r;
    map[id].ts=Math.max(map[id].ts,r.ts);
  }
  const groups=Object.values(map).filter(g=>g.left&&g.right).sort((a,b)=>b.ts-a.ts);
  return groups[0]||null;
}
function lineName(k){return ({heart:'Heart',mind:'Mind',life:'Life',fate:'Fate',success:'Success',health:'Health',marriage:'Marriage'})[k]||k;}
function quickNarrative(rec,mode){
  const L=rec.lines||{}, keys=['heart','mind','life','fate','success','health','marriage'];
  const sorted=keys.map(k=>[k,Number(L[k]||0)]).sort((a,b)=>b[1]-a[1]);
  const hi=sorted[0], lo=sorted.at(-1);
  const vti=Math.round(0.5*(L.life||0)+0.3*(L.success||0)+0.2*(L.health||0));
  return `Mode: ${mode} · Confidence ${rec.meta?.confidence??'—'}%
Vitality Index: ${vti}
Strongest → ${lineName(hi[0])} (${hi[1]})
Tender   → ${lineName(lo[0])} (${lo[1]})
Care: keep routines; consult professionals for health decisions.`;
}
function renderPairSummary(){
  const pair=latestPairWithBoth(); const box=document.getElementById('pairSummary');
  if(!pair){alert('Save both Left & Right first.');return;}
  document.getElementById('sumLeft').src=pair.left.thumb;
  document.getElementById('sumRight').src=pair.right.thumb;
  document.getElementById('txtLeft').textContent=quickNarrative(pair.left,'Past (Left)');
  document.getElementById('txtRight').textContent=quickNarrative(pair.right,'Present (Right)');
  const keys=['heart','mind','life','fate','success','health','marriage'];
  const deltas=keys.map(k=>(pair.right.lines[k]||0)-(pair.left.lines[k]||0));
  const dk=Math.round(deltas.reduce((a,b)=>a+b,0)/deltas.length);
  document.getElementById('deltaBadge').textContent=`ΔK average change: ${dk>0?'+':''}${dk}`;
  box.style.display='block';
}
document.getElementById('summaryBtn').onclick=renderPairSummary;

/* ====== PDF (Full Report, unlocked) ====== */
document.getElementById('pdfBtn').onclick=async()=>{
  if(!lastResult){alert('Analyze first');return;}
  await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js');
  const sc=lastResult.lines;
  const block=document.createElement('div');
  block.style.padding='20px'; block.style.fontFamily='Inter,system-ui,Arial'; block.style.color='#111';
  block.innerHTML=`
  <h1 style="margin:0 0 8px;color:#09c;">Quantum Palm Analyzer – Full Report</h1>
  <div style="font-size:12px;color:#555;margin-bottom:10px">
    Version 4.5.2 • ${new Date().toLocaleString()}
  </div>
  <img src="${canvas.toDataURL('image/jpeg',0.9)}" style="width:48%;border-radius:8px;border:1px solid #ddd" />
  <h3>Line Scores</h3>
  <ul style="line-height:1.6">
    <li>Heart: ${sc.heart}</li>
    <li>Mind: ${sc.mind}</li>
    <li>Life: ${sc.life}</li>
    <li>Fate: ${sc.fate}</li>
    <li>Success: ${sc.success}</li>
    <li>Health: ${sc.health}</li>
    <li>Marriage: ${sc.marriage}</li>
  </ul>
  <p>Confidence: ${lastResult.confidence}%</p>
  <p>Insight: Balanced progress profile with stable energy lines.</p>
  <hr />
  <small>Note: Symbolic reading for education & research — not medical advice.</small>`;
  html2pdf().set({
    margin:10, filename:'QuantumPalmReport_v4.5.2.pdf',
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  }).from(block).save();
};
function loadScript(src){
  return new Promise((res,rej)=>{
    if(document.querySelector(`script[src="${src}"]`)) return res();
    const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.body.appendChild(s);
  });
}

/* ====== QA: lighting / coverage / hand guess ====== */
const notice=document.getElementById('notice'),
      nText=document.getElementById('noticeText'),
      nSwitch=document.getElementById('noticeSwitch'),
      nOk=document.getElementById('noticeOk');
nOk.onclick=()=>notice.style.display='none';
nSwitch.onclick=()=>{handSel.value=(handSel.value==='left'?'right':'left'); notice.style.display='none';};

function skinMask(img,w,h){
  const d=img.data, m=new Uint8Array(w*h);
  for(let i=0,p=0;i<w*h;i++,p+=4){
    const r=d[p], g=d[p+1], b=d[p+2];
    const Y=0.299*r+0.587*g+0.114*b;
    const Cr=(r-Y)*0.713+128, Cb=(b-Y)*0.564+128;
    m[i]=((Cr>135&&Cr<180&&Cb>85&&Cb<135)||(r>95&&g>40&&b>20&&r>g&&r>b))?1:0;
  }
  return m;
}
function luminanceStats(img){
  const d=img.data; let s=0,s2=0;
  for(let i=0;i<d.length;i+=4){const y=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; s+=y; s2+=y*y;}
  const n=d.length/4, mu=s/n; return {mean:mu,std:Math.sqrt(Math.max(0,s2/n-mu*mu))};
}
function coverage(mask,w,h){
  let c=0,l=1e9,r=-1,t=1e9,b=-1;
  for(let y=0,i=0;y<h;y++){for(let x=0;x<w;x++,i++){if(mask[i]){c++; if(x<l)l=x;if(x>r)r=x;if(y<t)t=y;if(y>b)b=y;}}}
  return {area:c/(w*h),touch:{left:l<=w*0.02,right:r>=w*0.98,top:t<=h*0.02,bottom:b>=h*0.98}};
}
function wristEnergy(img,w,h){
  const top=Math.floor(h*0.88); let e=0,c=0;
  for(let y=top;y<h-1;y++){for(let x=1;x<w-1;x++){
    const p=(y*w+x)*4;
    const gx=(img.data[p-4]-img.data[p+4]) + (img.data[p-4*w]-img.data[p+4*w]);
    const gy=(img.data[p-4*w]-img.data[p+4*w]) + (img.data[p-4*w-4]-img.data[p+4*w+4]);
    e+=Math.hypot(gx,gy); c++;
  }}
  return e/(c||1);
}
function thumbBulk(mask,w,h){
  const band=Math.floor(w*0.25); let L=0,R=0;
  for(let y=0,i=0;y<h;y++){for(let x=0;x<w;x++,i++){ if(mask[i]){ if(x<band)L++; if(x>=w-band)R++; } }}
  if(L>R*1.25) return 'left-side-bulk';
  if(R>L*1.25) return 'right-side-bulk';
  return 'unknown';
}
function mapped(bulk){ if(bulk==='left-side-bulk')return 'right'; if(bulk==='right-side-bulk')return 'left'; return null; }

function runFrameQA(){
  const w=canvas.width,h=canvas.height;
  const frame=ctx.getImageData(0,0,w,h);
  const stats=luminanceStats(frame);
  const mask=skinMask(frame,w,h);
  const cov=coverage(mask,w,h);
  const wrist=wristEnergy(frame,w,h);
  const guess=mapped(thumbBulk(mask,w,h));

  const msgs=[];
  if(stats.mean<65) msgs.push('Image looks too dark. Use brighter light or Flash.');
  if(stats.mean>210) msgs.push('Image is over-exposed. Reduce brightness/flash.');
  if(stats.std<20) msgs.push('Low contrast. Use neutral background and steady focus.');
  if(cov.area<0.25) msgs.push('Only a small part of the hand is visible. Fill more of the frame.');
  const touches=Object.entries(cov.touch).filter(([k,v])=>v).map(([k])=>k).join(', ');
  if(touches) msgs.push(`Palm is cut at the ${touches} edge. Keep the full palm inside the border.`);
  if(wrist<150) msgs.push('Include wrist (bracelet) lines at the bottom.');

  if(guess){
    const exp=handSel.value;
    if(guess!==exp){ msgs.push(`Looks like the ${guess.toUpperCase()} hand, but selector is ${exp.toUpperCase()}.`); nSwitch.style.display='inline-flex'; }
    else nSwitch.style.display='none';
  }

  if(msgs.length){ nText.innerHTML='• ' + msgs.join('<br>• '); notice.style.display='block'; }
  else notice.style.display='none';
}
</script>
</body>
</html>
