// modules/camera.js
// üïâÔ∏è Sathyadarshana Quantum Palm Analyzer ¬∑ True Vision Camera Engine v2.3.3

// --- Start Camera ---
export async function startCamera(video, msg) {
  try {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      msg.textContent = "‚ùå Camera not supported on this browser.";
      msg.className = "error";
      return null;
    }

    // Check available video devices
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");

    if (cams.length === 0) {
      msg.textContent = "‚ùå No camera detected on this device.";
      msg.className = "error";
      return null;
    }

    // Prefer back camera if possible
    const backCam = cams.find(c => /back|rear|environment/i.test(c.label));
    const selectedCam = backCam ? backCam.deviceId : cams[0].deviceId;

    const constraints = {
      video: {
        deviceId: selectedCam ? { exact: selectedCam } : undefined,
        facingMode: backCam ? "environment" : "user",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    };

    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;

    // wait until ready
    await new Promise(r => video.onloadedmetadata = r);
    await video.play();

    msg.textContent = "‚úÖ Camera active. Hold hand steady under bright light.";
    msg.className = "";
    return stream;
  } catch (err) {
    console.error("Camera error:", err);
    msg.textContent = "‚ö†Ô∏è Camera access failed: " + err.message;
    msg.className = "error";

    if (err.name === "NotAllowedError")
      alert("Please allow camera permission: tap lock icon ‚Üí Site settings ‚Üí Camera ‚Üí Allow.");

    return null;
  }
}

// --- Capture single frame (ImageData) ---
export function captureFrame(video) {
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return ctx.getImageData(0, 0, canvas.width, canvas.height);
}
