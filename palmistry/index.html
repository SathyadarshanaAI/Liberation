<script type="module">
import { detectPalmEdges } from './js/edgeLines.js';

function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

// üïí Wait for OpenCV to be ready
async function waitForOpenCV(){
  return new Promise(resolve=>{
    const check=setInterval(()=>{
      if(window.cv && cv.Mat){clearInterval(check);resolve(true);}
    },500);
  });
}

// üß† Initialize App
async function initPalmAnalyzer(){
  await waitForOpenCV();
  document.getElementById('status').textContent='üîç OpenCV Ready';

  const hands=["left","right"];
  let streams={};

  for(const side of hands){
    const video=document.getElementById(`vid${cap(side)}`);
    const canvas=document.getElementById(`canvas${cap(side)}`);
    const ctx=canvas.getContext("2d");
    const selectEl=document.getElementById(`cameraSelect${cap(side)}`);

    // üì∏ List cameras
    navigator.mediaDevices.enumerateDevices().then(devices=>{
      selectEl.innerHTML="";
      devices.filter(d=>d.kind==="videoinput").forEach((cam,i)=>{
        const opt=document.createElement("option");
        opt.value=cam.deviceId;
        opt.textContent=cam.label||`Camera ${i}`;
        selectEl.appendChild(opt);
      });
    });

    // ‚ñ∂Ô∏è Start camera
    document.getElementById(`startCam${cap(side)}`).onclick=async()=>{
      const deviceId=selectEl.value;
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{deviceId}});
        video.srcObject=stream;
        streams[side]=stream;
        document.getElementById("status").textContent=`üì∑ ${side.toUpperCase()} camera running`;
      }catch(e){alert("Camera error: "+e.message);}
    };

    // üì∑ Capture freeze
    document.getElementById(`capture${cap(side)}`).onclick=()=>{
      if(!streams[side])return alert("Start camera first!");
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      canvas.style.display="block";
      video.pause();
      document.getElementById("status").textContent=`üì∏ ${side} captured`;
    };

    // üîÆ Analyze palm
    document.getElementById(`analyze${cap(side)}`).onclick=async()=>{
      document.getElementById("status").textContent=`üß† Analyzing ${side} hand...`;

      const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
      try{
        await detectPalmEdges(frame,canvas);
      }catch(err){
        console.error("Edge detection failed:",err);
        return;
      }

      // üìë AI mock report
      const mini=`Life line: clear\nHeart line: strong curve\nFate line: visible medium strength`;
      const deep=`Palm reveals emotional balance, courage and steady intuition.\nEnergy flow around thumb region indicates resilience & calm focus.`;
      document.getElementById(`miniReport${cap(side)}`).textContent=mini;
      document.getElementById(`deepReport${cap(side)}`).textContent=deep;

      // üéô Sinhala + English voice
      const msg=side==="left"
        ?"‡∂î‡∂∫‡∑è‡∂ú‡∑ö ‡∑Ä‡∂∏‡∑ä ‡∂Ö‡∂≠‡∑ö ‡∂ª‡∑ö‡∂õ‡∑è ‡∂¥‡∑í‡∂ª‡∑í‡∑É‡∑í‡∂Ø‡∑î‡∂∫‡∑í. ‡∑Å‡∂ö‡∑ä‡∂≠‡∑í‡∂∏‡∂≠‡∑ä ‡∂Ü‡∂≠‡∑ä‡∂∏ ‡∑Å‡∂ö‡∑ä‡∂≠‡∑í‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í."
        :"‡∂î‡∂∫‡∑è‡∂ú‡∑ö ‡∂Ø‡∂ö‡∑î‡∂´‡∑î ‡∂Ö‡∂≠‡∑ö ‡∂ª‡∑ö‡∂õ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É ‡∑É‡∑Ñ ‡∂±‡∑è‡∂∫‡∂ö‡∂≠‡∑ä‡∑Ä ‡∂ú‡∑î‡∂´ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í.";
      const u=new SpeechSynthesisUtterance(msg);
      u.lang="si-LK";u.pitch=1;u.rate=1;
      speechSynthesis.speak(u);

      document.getElementById("status").textContent="‚ú® AI Analysis complete!";
    };
  }
}

// üöÄ Run app after OpenCV fully loads
initPalmAnalyzer();
</script>
