<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quantum Palm Analyzer v4.4</title>
<style>
:root{--bg:#0b0f16;--card:#0f172a;--neon:#00e5ff;--pri:#16f0a7;--mut:#a9c2da}
*{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#0e2133,#0b0f16);color:#e6f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
h1{margin:12px 0 6px;text-align:center;color:var(--neon)} .wrap{max-width:1000px;margin:0 auto;padding:10px}

/* pill buttons */
.btn,button,a{background:#0d1522;color:#c7e8ff;border:1px solid #1a3a55;border-radius:22px;
  padding:12px 16px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
.btn:hover,button:hover,a:hover{background:#00e5ff;color:#001015;border-color:#00e5ff}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:8px 0 12px}

/* camera */
.camWrap{display:grid;place-items:center}
.camBox{position:relative;width:min(96vw,720px);aspect-ratio:3/4;border-radius:16px;border:2px solid #00d0ff;overflow:hidden;background:#000}
.camBox video,.camBox canvas,.camBox .aura{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:16px}
#video[hidden]{display:none}
.aura{mix-blend-mode:screen;background:conic-gradient(from 0deg,#00e5ff88,#16f0a788,#9a6bff88,#00e5ff88);animation:spin 6s linear infinite;opacity:.7}
@keyframes spin{to{transform:rotate(360deg)}}
.card{background:linear-gradient(180deg,#101a2b,#0c1320);border:1px solid #133149;border-radius:16px;padding:14px;margin-top:12px}
.badge{display:inline-block;background:#0b1320;border:1px solid #17324a;border-radius:10px;padding:3px 8px;font-size:12px;color:#9edcff}

/* bars */
.lines{display:grid;grid-template-columns:1fr;gap:8px}
.row{display:grid;grid-template-columns:240px 1fr;gap:10px;align-items:center}
.bar{background:#0b1320;height:12px;border-radius:10px;overflow:hidden}
.bar>span{display:block;height:100%;transform-origin:left center;transform:scaleX(0);transition:transform 900ms ease}
.bar.h  >span{background:linear-gradient(90deg,#ff6b6b,#ff3b3b)}
.bar.hh >span{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
.bar.l  >span{background:linear-gradient(90deg,#34d399,#10b981)}
.bar.f  >span{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.bar.s  >span{background:linear-gradient(90deg,#f97316,#fb923c)}
.bar.mer>span{background:linear-gradient(90deg,#a78bfa,#8b5cf6)}
.bar.mar>span{background:linear-gradient(90deg,#f472b6,#ec4899)}

/* legend */
.legend{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
.legend .item{display:flex;align-items:center;gap:8px;font-size:14px;color:#d7e8ff}
.sw{width:14px;height:14px;border-radius:4px}
.sw.h{background:#ff4f56}.sw.hh{background:#5aa2ff}.sw.l{background:#15c194}
.sw.f{background:#f6a911}.sw.s{background:#fb8a2d}.sw.mer{background:#8b5cf6}.sw.mar{background:#ec4899}

/* radar */
#radar{display:block;margin:10px auto;background:#0b1320;border:1px solid #17324a;border-radius:12px}

/* language bar */
.langbar{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:6px 0}
.langbar button{background:#0b1320;border:1px solid #17324a;color:#9edcff;border-radius:999px;padding:6px 10px;font-weight:700}
.langbar button:hover{background:#00e5ff;color:#001015}
#google_translate_element{display:inline-block;margin-left:6px}

/* notice banner */
.notice{max-width:1000px;margin:8px auto 0;background:#1b2636;border:1px solid #2d4a68;color:#e6f0ff;border-radius:12px;padding:10px 12px;box-shadow:0 4px 18px #0007}
.notice strong{color:#16f0a7} .notice-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <h1>Quantum Palm Analyzer v4.4</h1>

  <!-- Language -->
  <div class="langbar">
    <button data-lang="en">English</button><button data-lang="si">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</button>
    <button data-lang="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button><button data-lang="de">Deutsch</button>
    <button data-lang="it">Italiano</button><button data-lang="ja">Êó•Êú¨Ë™û</button>
    <button data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button><button data-lang="zh-CN">‰∏≠Êñá</button>
    <button data-lang="fr">Fran√ßais</button><button data-lang="es">Espa√±ol</button>
    <button data-lang="tr">T√ºrk√ße</button><button data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
    <span id="google_translate_element"></span>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <a class="btn" href="../astrology.html">‚Üê Astrology</a>
    <button class="btn" id="startCam">üì∑ Start</button>
    <button class="btn" id="flashBtn">‚ö° Flash</button>
    <button class="btn" id="switchBtn">üîÅ Switch Cam</button>
    <button class="btn" id="capture">Capture</button>
    <label class="btn" for="filePick">Upload Photo</label>
    <input id="filePick" type="file" accept="image/*" hidden/>
    <button class="btn" id="analyze">Analyze</button>
    <button class="btn" id="save">üíæ Save to Results</button>
    <button class="btn" id="summaryBtn">üßæ Pair Summary</button>
    <a class="btn" href="./report.html">PDF Report</a>
  </div>

  <!-- Notice / QA -->
  <div id="notice" class="notice" style="display:none">
    <div id="noticeText">Guidance‚Ä¶</div>
    <div class="notice-actions">
      <button id="noticeSwitch" class="btn" style="display:none">Switch Hand</button>
      <button id="noticeOk" class="btn">OK</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Camera & hand select -->
    <div class="card">
      <div class="toolbar" style="margin-top:0;justify-content:flex-start;gap:8px">
        <span class="badge">Hand</span>
        <select id="handSel" class="btn" style="padding:8px 12px;border-radius:12px">
          <option value="left">Left (Past)</option>
          <option value="right">Right (Present)</option>
        </select>
        <span id="pairBadge" class="badge">pair: ‚Äî</span>
      </div>
      <div class="camWrap">
        <div class="camBox" id="camBox">
          <video id="video" playsinline autoplay muted hidden></video>
          <canvas id="canvas"></canvas>
          <div class="aura" aria-hidden="true"></div>
        </div>
      </div>
      <div style="text-align:center;margin-top:6px" id="status" class="badge">No image yet</div>
    </div>

    <!-- Bars + legend -->
    <div class="card">
      <div class="badge" id="conf">Confidence ‚Äî</div>
      <div class="lines">
        <div class="row"><div>‚ù§Ô∏è ‡∑Ñ‡∑ò‡∂Ø (Heart)</div>     <div class="bar h"><span id="b0"></span></div></div>
        <div class="row"><div>üß† ‡∂†‡∑í‡∂≠‡∑ä‡∂≠/Head</div>     <div class="bar hh"><span id="b1"></span></div></div>
        <div class="row"><div>üåø ‡∂¢‡∑ì‡∑Ä‡∂± (Life)</div>     <div class="bar l"><span id="b2"></span></div></div>
        <div class="row"><div>üúÇ ‡∂∑‡∑è‡∂ú‡∑ä‚Äç‡∂∫ (Fate)</div>   <div class="bar f"><span id="b3"></span></div></div>
        <div class="row"><div>‚òÄÔ∏è ‡∑É‡∑ñ‡∂ª‡∑ä‡∂∫ (Sun)</div>     <div class="bar s"><span id="b4"></span></div></div>
        <div class="row"><div>‚òø ‡∂∂‡∑î‡∂∞/‡∑É‡∑î‡∑Ä (Mercury)</div><div class="bar mer"><span id="b5"></span></div></div>
        <div class="row"><div>üíç ‡∑Ä‡∑í‡∑Ä‡∑è‡∑Ñ (Marriage)</div><div class="bar mar"><span id="b6"></span></div></div>
      </div>
      <div class="legend">
        <div class="item"><span class="sw h"></span>‡∑Ñ‡∑ò‡∂Ø (Heart)</div>
        <div class="item"><span class="sw hh"></span>‡∂†‡∑í‡∂≠‡∑ä‡∂≠/Head</div>
        <div class="item"><span class="sw l"></span>‡∂¢‡∑ì‡∑Ä‡∂± (Life)</div>
        <div class="item"><span class="sw f"></span>‡∂∑‡∑è‡∂ú‡∑ä‚Äç‡∂∫ (Fate)</div>
        <div class="item"><span class="sw s"></span>‡∑É‡∑ñ‡∂ª‡∑ä‡∂∫ (Sun)</div>
        <div class="item"><span class="sw mer"></span>‡∂∂‡∑î‡∂∞/‡∑É‡∑î‡∑Ä (Mercury)</div>
        <div class="item"><span class="sw mar"></span>‡∑Ä‡∑í‡∑Ä‡∑è‡∑Ñ (Marriage)</div>
      </div>
    </div>

    <!-- Radar + Insight -->
    <div class="card">
      <canvas id="radar" width="320" height="240"></canvas>
      <pre id="insight" style="white-space:pre-wrap;text-align:left;margin:6px auto;max-width:720px">
üúÅ Run Analyze to generate insight‚Ä¶
      </pre>
    </div>

    <!-- Pair Summary -->
    <div class="card" id="pairSummary" style="display:none">
      <h3 style="margin:0 0 8px">Pair Summary ‚Äî Left (Past) vs Right (Present)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start">
        <div>
          <img id="sumLeft"  alt="Left (Past)"  style="width:100%;border-radius:12px;border:1px solid #17324a;filter:grayscale(100%) contrast(130%)"/>
          <div class="badge">Past (Left)</div>
          <div id="txtLeft"  style="margin-top:6px;white-space:pre-wrap"></div>
        </div>
        <div>
          <img id="sumRight" alt="Right (Present)" style="width:100%;border-radius:12px;border:1px solid #17324a;filter:grayscale(100%) contrast(130%)"/>
          <div class="badge">Present (Right)</div>
          <div id="txtRight" style="margin-top:6px;white-space:pre-wrap"></div>
        </div>
      </div>
      <div class="badge" id="deltaBadge" style="margin-top:8px">ŒîK ‚Äî</div>
      <div class="badge" style="margin-top:6px">Note: Symbolic trend reading; no exact ages or medical claims.</div>
    </div>
  </div>

<script>
/* === Google Translate === */
function googleTranslateElementInit(){
  new google.translate.TranslateElement({pageLanguage:'en',
    includedLanguages:'en,si,ta,de,it,ja,hi,zh-CN,fr,es,tr,ru',autoDisplay:false
  },'google_translate_element');
}
function setLangCookie(l){const v='/auto/'+l;document.cookie='googtrans='+v+';path=/';
document.cookie='googtrans='+v+';path=/;domain='+location.hostname;location.reload();}
document.addEventListener('click',e=>{const b=e.target.closest('.langbar button[data-lang]'); if(b) setLangCookie(b.dataset.lang);});
(function(){const s=document.createElement('script');s.src='https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';document.body.appendChild(s);})();

/* === Storage (results) & pair id === */
const PR_KEY='palmistryResults', PAIR_KEY='currentPairId';
const handSel=document.getElementById('handSel'), pairBadge=document.getElementById('pairBadge');
const prLoad=()=>{try{return JSON.parse(localStorage.getItem(PR_KEY)||'[]')}catch{return[]}};
const prSave=a=>localStorage.setItem(PR_KEY,JSON.stringify(a));
const prAdd=o=>{const a=prLoad();a.push(o);prSave(a);}
const getPairId=()=>localStorage.getItem(PAIR_KEY)||null;
const setPairId=id=>{localStorage.setItem(PAIR_KEY,id); paintPair();};
const newPairId=()=> (crypto.randomUUID?.()||('pair_'+Date.now().toString(36)));
function paintPair(){ pairBadge.textContent='pair: '+(getPairId()||'‚Äî'); } paintPair();

/* === Camera === */
const video=document.getElementById('video');
const canvas=document.getElementById('canvas'); const ctx=canvas.getContext('2d');
const camBox=document.getElementById('camBox'); const statusBox=document.getElementById('status');
let mediaStream=null, camFacing='environment';
function sizeCanvas(){const r=camBox.getBoundingClientRect();const d=Math.min(window.devicePixelRatio||1,2);canvas.width=r.width*d;canvas.height=r.height*d;}
new ResizeObserver(sizeCanvas).observe(camBox); sizeCanvas();

async function startCamera(){try{
  mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:camFacing}}});
  video.srcObject=mediaStream; video.hidden=false; statusBox.textContent='Camera active';
}catch{alert('Camera access failed');}}
document.getElementById('startCam').onclick=startCamera;

document.getElementById('switchBtn').onclick=async()=>{camFacing=(camFacing==='environment')?'user':'environment'; await startCamera();};

function detectTrack(){ return mediaStream?.getVideoTracks?.()[0] || video.srcObject?.getVideoTracks?.()[0] || null; }
document.getElementById('flashBtn').onclick=async()=>{
  const track=detectTrack(); if(!track){alert('Start camera first');return;}
  const caps=track.getCapabilities?track.getCapabilities():{}; if(!caps.torch){alert('Flash/torch not supported');return;}
  const current=track.getSettings?.().torch; try{ await track.applyConstraints({advanced:[{torch:!current}]});
    document.getElementById('flashBtn').textContent = (!current)?'‚ö° Flash ON':'‚ö° Flash';
  }catch{alert('Torch control failed');}
};

document.getElementById('capture').onclick=()=>{
  if(!video.srcObject){alert('Start camera first');return;}
  sizeCanvas(); drawToCanvas(video);
};
document.getElementById('filePick').onchange=e=>{
  const f=e.target.files[0]; if(!f)return;
  const img=new Image(); img.onload=()=>{sizeCanvas(); drawToCanvas(img);}; img.src=URL.createObjectURL(f);
};

function drawToCanvas(src){
  const w=canvas.width,h=canvas.height; ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
  const sw=src.videoWidth||src.width, sh=src.videoHeight||src.height;
  const CR=w/h, R=sw/sh; let sx=0,sy=0,Ssw=sw,Ssh=sh;
  if(R>CR){ Ssh=sh; Ssw=Ssh*CR; sx=(sw-Ssw)/2; } else { Ssw=sw; Ssh=Ssw/CR; sy=(sh-Ssh)/2; }
  ctx.drawImage(src,sx,sy,Ssw,Ssh,0,0,w,h);
  statusBox.textContent='Frame captured';
  runFrameQA();
}

/* === Analyzer (demo heuristic) === */
const bars=[...Array(7)].map((_,i)=>document.getElementById('b'+i));
let lastResult=null;
document.getElementById('analyze').onclick=()=>{
  const pix=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  if(!pix || !pix.length){alert('Load an image first');return;}
  let sum=0; for(let i=0;i<pix.length;i+=24) sum+=pix[i]+pix[i+1]+pix[i+2];
  const avg=sum/(pix.length/24); const conf=Math.min(99,Math.max(60,avg/4));
  document.getElementById('conf').textContent='Confidence '+conf.toFixed(1)+'%';
  const sc=[80,74,70,60,66,75,55].map(v=>Math.min(100,v+(conf-80)/2));
  sc.forEach((v,i)=>bars[i].style.transform=`scaleX(${v/100})`);
  drawRadar(sc);
  lastResult={confidence:Math.round(conf),lines:{
    heart:{score:Math.round(sc[0])}, head:{score:Math.round(sc[1])}, life:{score:Math.round(sc[2])},
    fate:{score:Math.round(sc[3])}, sun:{score:Math.round(sc[4])}, mercury:{score:Math.round(sc[5])},
    marriage:{score:Math.round(sc[6])}
  }};
  document.getElementById('insight').textContent=
  `Œî Confidence ${conf.toFixed(1)}%
‚Ä¢ Heart ${sc[0]}  ‚Ä¢ Head ${sc[1]}
‚Ä¢ Life  ${sc[2]}  ‚Ä¢ Fate ${sc[3]}
‚Ä¢ Sun   ${sc[4]}  ‚Ä¢ Mercury ${sc[5]}  ‚Ä¢ Marriage ${sc[6]}
Insight: Subtle energy balance emerging.`;
};

function drawRadar(a){
  const c=document.getElementById('radar'), g=c.getContext('2d');
  const w=c.width,h=c.height,cx=w/2,cy=h/2,R=Math.min(w,h)/2-18;
  g.clearRect(0,0,w,h); g.strokeStyle='#17324a'; g.lineWidth=1;
  for(let r=0.2;r<=1;r+=0.2){ g.beginPath();
    for(let i=0;i<7;i++){const ang=i*2*Math.PI/7-Math.PI/2; const x=cx+Math.cos(ang)*R*r; const y=cy+Math.sin(ang)*R*r; i?g.lineTo(x,y):g.moveTo(x,y);}
    g.closePath(); g.stroke();
  }
  g.beginPath();
  for(let i=0;i<7;i++){const ang=i*2*Math.PI/7-Math.PI/2; const x=cx+Math.cos(ang)*R*(a[i]/100); const y=cy+Math.sin(ang)*R*(a[i]/100); i?g.lineTo(x,y):g.moveTo(x,y);}
  g.closePath(); g.fillStyle='rgba(22,240,167,.12)'; g.fill(); g.strokeStyle='#16f0a7'; g.stroke();
}

/* === Save to Results === */
document.getElementById('save').onclick=()=>{
  if(!lastResult){alert('Analyze first');return;}
  let pid=getPairId(); if(!pid){ pid=newPairId(); setPairId(pid); }
  const entry={
    ts:Date.now(), pairId:pid, hand:handSel.value,
    thumb:canvas.toDataURL('image/jpeg',0.75),
    meta:{version:'4.4',confidence:lastResult.confidence},
    lines:lastResult.lines
  };
  prAdd(entry);
  alert('Saved to Results. Use Pair Summary to compare.');
};

/* === Pair Summary === */
function latestPairWithBoth(){
  const all=prLoad(); const map={};
  for(const r of all){ const id=r.pairId||('solo-'+r.ts); map[id]=map[id]||{id,left:null,right:null,ts:0};
    if(r.hand==='left') map[id].left=r; if(r.hand==='right') map[id].right=r; map[id].ts=Math.max(map[id].ts,r.ts); }
  const groups=Object.values(map).filter(g=>g.left&&g.right).sort((a,b)=>b.ts-a.ts); return groups[0]||null;
}
function lineName(k){return({heart:'Heart',head:'Head',life:'Life',fate:'Fate',sun:'Sun',mercury:'Mercury',marriage:'Marriage'})[k]||k;}
function quickNarrative(rec,mode){
  const L=rec.lines||{}, order=['heart','head','life','fate','sun','mercury','marriage'];
  const sorted=order.map(k=>[k,L[k]?.score||0]).sort((a,b)=>b[1]-a[1]); const hi=sorted[0], lo=sorted.at(-1);
  const partner=(L.marriage?.score||0)>=75?'Partnership window strong':(L.marriage?.score||0)>=55?'Moderate partnership window':'Evolving partnership window';
  const vti=Math.round(0.5*(L.life?.score||0)+0.3*(L.sun?.score||0)+0.2*(L.mercury?.score||0));
  return `‚Ä¢ Mode: ${mode} ¬∑ Confidence ${rec.meta?.confidence??'‚Äî'}%
‚Ä¢ Vitality Trend Index: ${vti}
‚Ä¢ Strongest ‚Üí ${lineName(hi[0])} (${hi[1]})
‚Ä¢ Tender   ‚Üí ${lineName(lo[0])} (${lo[1]})
‚Ä¢ Family/Partnership: ${partner}
‚Ä¢ Care: steady routines; professional advice for health decisions.`;
}
function renderPairSummary(){
  const pair=latestPairWithBoth(); const box=document.getElementById('pairSummary');
  if(!pair){alert('Save both Left & Right first.');return;}
  document.getElementById('sumLeft').src=pair.left.thumb;
  document.getElementById('sumRight').src=pair.right.thumb;
  document.getElementById('txtLeft').textContent = quickNarrative(pair.left,'Past (Left)');
  document.getElementById('txtRight').textContent= quickNarrative(pair.right,'Present (Right)');
  const keys=['heart','head','life','fate','sun','mercury','marriage'];
  const deltas=keys.map(k=> (pair.right.lines[k]?.score??0)-(pair.left.lines[k]?.score??0));
  const dk=Math.round(deltas.reduce((a,b)=>a+b,0)/deltas.length); document.getElementById('deltaBadge').textContent=`ŒîK average change: ${dk>0?'+':''}${dk}`;
  box.style.display='block';
}
document.getElementById('summaryBtn').onclick=renderPairSummary;

/* === QA Guidance (left/right + lighting + wrist/coverage) === */
const notice=document.getElementById('notice'), nText=document.getElementById('noticeText'), nSwitch=document.getElementById('noticeSwitch'), nOk=document.getElementById('noticeOk');
nOk.onclick=()=>notice.style.display='none'; nSwitch.onclick=()=>{ handSel.value=(handSel.value==='left'?'right':'left'); notice.style.display='none'; };

function skinMask(img,w,h){
  const d=img.data, m=new Uint8Array(w*h);
  for(let i=0,p=0;i<w*h;i++,p+=4){
    const r=d[p],g=d[p+1],b=d[p+2]; const Y=0.299*r+0.587*g+0.114*b; const Cr=(r-Y)*0.713+128; const Cb=(b-Y)*0.564+128;
    m[i]=((Cr>135&&Cr<180&&Cb>85&&Cb<135)||(r>95&&g>40&&b>20&&r>g&&r>b))?1:0;
  } return m;
}
function luminanceStats(img){const d=img.data;let s=0,s2=0;for(let i=0;i<d.length;i+=4){const y=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];s+=y;s2+=y*y;}const n=d.length/4,mu=s/n;return{mean:mu,std:Math.sqrt(Math.max(0,s2/n-mu*mu))};}
function coverage(mask,w,h){let c=0,l=1e9,r=-1,t=1e9,b=-1;for(let y=0,i=0;y<h;y++){for(let x=0;x<w;x++,i++){if(mask[i]){c++;if(x<l)l=x;if(x>r)r=x;if(y<t)t=y;if(y>b)b=y;}}}return{area:c/(w*h),touch:{left:l<=w*0.02,right:r>=w*0.98,top:t<=h*0.02,bottom:b>=h*0.98}};}
function wristEnergy(img,w,h){const top=Math.floor(h*0.88);let e=0,c=0;for(let y=top;y<h-1;y++){for(let x=1;x<w-1;x++){const p=(y*w+x)*4;const gx=(img.data[p-4]-img.data[p+4])+(img.data[p-4*w]-img.data[p+4*w]);const gy=(img.data[p-4*w]-img.data[p+4*w])+(img.data[p-4*w-4]-img.data[p+4*w+4]);e+=Math.hypot(gx,gy);c++;}}return e/(c||1);}
function thumbBulk(mask,w,h){const band=Math.floor(w*0.25);let L=0,R=0;for(let y=0,i=0;y<h;y++){for(let x=0;x<w;x++,i++){if(mask[i]){if(x<band)L++; if(x>=w-band)R++;}}} if(L>R*1.25) return 'left-side-bulk'; if(R>L*1.25) return 'right-side-bulk'; return 'unknown';}
function mapped(bulk){ if(bulk==='left-side-bulk') return 'right'; if(bulk==='right-side-bulk') return 'left'; return null; }

function runFrameQA(){
  const w=canvas.width,h=canvas.height; const frame=ctx.getImageData(0,0,w,h);
  const stats=luminanceStats(frame); const mask=skinMask(frame,w,h); const cov=coverage(mask,w,h); const wrist=wristEnergy(frame,w,h); const guess=mapped(thumbBulk(mask,w,h));
  const msgs=[];
  if(stats.mean<65) msgs.push('Image looks <strong>too dark</strong>. Turn on ‚ö° Flash or move to better light.');
  if(stats.mean>210) msgs.push('Image looks <strong>over-exposed</strong>. Reduce flash/brightness.');
  if(stats.std<20) msgs.push('Low contrast detected. Keep a neutral background and good focus.');
  if(cov.area<0.25) msgs.push('Only a <strong>small part of the hand</strong> is visible. Fill more of the frame.');
  const touches=Object.entries(cov.touch).filter(([k,v])=>v).map(([k])=>k).join(', '); if(touches) msgs.push(`Palm is <strong>cut at the ${touches}</strong> edge. Keep full palm inside the border.`);
  if(wrist<150) msgs.push('Include the <strong>wrist (manikha·πá·∏ça) lines</strong> at the bottom.');
  if(guess){ const exp=handSel.value; if(guess!==exp){ msgs.push(`This photo looks like <strong>${guess.toUpperCase()}</strong> hand, but selector is ${exp.toUpperCase()}.`); nSwitch.style.display='inline-flex'; } else nSwitch.style.display='none'; }
  if(msgs.length){ nText.innerHTML='‚Ä¢ '+msgs.join('<br>‚Ä¢ '); notice.style.display='block'; } else notice.style.display='none';
}

/* === Pair Summary trigger === */
document.getElementById('summaryBtn').onclick=renderPairSummary;

/* === Notice buttons === */
const nOk=document.getElementById('noticeOk'), nSwitch=document.getElementById('noticeSwitch');
nOk.onclick=()=>notice.style.display='none'; nSwitch.onclick=()=>{handSel.value=(handSel.value==='left'?'right':'left'); notice.style.display='none';};
</script>
</body>
</html>
