<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Palmistry – Capture & Analyze (Fix)</title>
<style>
:root{--pri:#16f0a7;--bg:#0b0f16;--neon:#00e5ff}
*{box-sizing:border-box} body{margin:0;background:#0b0f16;color:#e6f0ff;font-family:system-ui}
.wrap{max-width:460px;margin:20px auto;padding:12px}
h1{margin:6px 0 12px;font-weight:700}
.card{position:relative;border:2px solid var(--pri);border-radius:16px;overflow:hidden;background:#000}
video,canvas{display:block;width:100%;height:auto}
.overlay{position:absolute;inset:0;pointer-events:none;opacity:.7}
.bar{display:flex;gap:8px;align-items:center;justify-content:center;margin:10px 0 4px;flex-wrap:wrap}
button{background:var(--neon);border:none;color:#000;padding:10px 14px;border-radius:999px;font-weight:700}
button.sec{background:#1f2937;color:#e6f0ff;border:1px solid #3b82f6}
small.mono{font-family:ui-monospace,monospace;opacity:.85}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.range{accent-color:#3b82f6;width:140px}
.badge{display:inline-block;background:#111827;border:1px solid #374151;padding:4px 8px;border-radius:10px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #ef4444;
       color:#fff;padding:8px 12px;border-radius:10px;display:none;z-index:9999}
footer{opacity:.8;text-align:center;margin:12px 0 24px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Palmistry – Capture & Analyze</h1>

  <div id="status" class="badge">Ready. Opened camera…</div>

  <div class="card" id="card">
    <video id="vid" playsinline autoplay muted></video>
    <canvas id="cap" class="overlay"></canvas>
    <canvas id="out" class="overlay"></canvas>
  </div>

  <div class="bar">
    <button id="btnCap">Capture</button>
    <button id="btnAna" class="sec">Analyze</button>
    <div class="row">
      <small>Threshold</small>
      <input id="thr" class="range" type="range" min="10" max="80" step="2" value="34"/>
      <small id="thrVal" class="mono">34</small>
    </div>
  </div>

  <div id="summary" class="badge">AI Summary: —</div>

  <footer><small>© Sathyadarshana · Research build · Works offline</small></footer>
</div>

<div id="toast" class="toast"></div>

<script>
const $ = (q)=>document.querySelector(q);
const vid = $('#vid'), cap = $('#cap'), out = $('#out');
const btnCap = $('#btnCap'), btnAna = $('#btnAna');
const statusEl = $('#status'), sumEl = $('#summary');
const thr = $('#thr'), thrVal = $('#thrVal'), toast = $('#toast');
let gotFrame = false;

function say(s){ statusEl.textContent = s; }
function oops(e){ toast.textContent = e; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2200); }

async function openCam(){
  try{
    const str = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment'}
    });
    vid.srcObject = str;
    await vid.play();
    // IMPORTANT: set canvas sizes *after* metadata is ready
    await new Promise(r=>vid.onloadedmetadata=r);
    const w = vid.videoWidth, h = vid.videoHeight;
    [cap,out].forEach(c=>{ c.width=w; c.height=h; });
    say('Camera ready. Frame streaming…');
  }catch(err){ oops('Camera error: '+err.message); say('Camera failed'); }
}

btnCap.addEventListener('click', async ()=>{
  try{
    const w = vid.videoWidth, h = vid.videoHeight;
    if(!w||!h){ oops('Video not ready'); return; }
    // draw current frame to cap
    const cx = cap.getContext('2d',{willReadFrequently:true});
    cx.drawImage(vid,0,0,w,h);
    gotFrame = true;
    sumEl.textContent = 'AI Summary: Captured frame.';
    say('Captured frame. Click Analyze.');
  }catch(err){ oops('Capture failed: '+err.message); }
});

btnAna.addEventListener('click', ()=>{
  if(!gotFrame){ oops('No frame. Tap Capture first.'); return; }
  try{
    const t0 = performance.now();
    const w = cap.width, h = cap.height;
    const srcCtx = cap.getContext('2d',{willReadFrequently:true});
    const img = srcCtx.getImageData(0,0,w,h);
    // grayscale + local contrast + threshold
    const data = img.data, gray = new Uint8ClampedArray(w*h);
    for(let i=0,j=0;i<data.length;i+=4,j++){
      const r=data[i], g=data[i+1], b=data[i+2];
      gray[j] = (r*0.299 + g*0.587 + b*0.114)|0;
    }
    // simple high-pass (unsharp) to make lines pop
    const hp = new Uint8ClampedArray(w*h);
    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        const i=y*w+x;
        const c = gray[i]*5 - (gray[i-1]+gray[i+1]+gray[i-w]+gray[i+w]);
        hp[i] = Math.max(0, Math.min(255, c+128));
      }
    }
    const T = Number(thr.value); thrVal.textContent = T;
    const mask = new Uint8ClampedArray(w*h);
    let cnt=0;
    for(let i=0;i<mask.length;i++){
      const v = hp[i] > (128+T) ? 255 : 0;
      mask[i]=v; if(v) cnt++;
    }
    // draw overlay (colored)
    const octx = out.getContext('2d');
    const overlay = octx.createImageData(w,h);
    for(let i=0,j=0;i<overlay.data.length;i+=4,j++){
      if(mask[j]){
        overlay.data[i]=0;         // R
        overlay.data[i+1]=255;     // G
        overlay.data[i+2]=180;     // B
        overlay.data[i+3]=190;     // A
      }else{
        overlay.data[i]=0; overlay.data[i+1]=0; overlay.data[i+2]=0; overlay.data[i+3]=0;
      }
    }
    octx.putImageData(overlay,0,0);
    const ms = (performance.now()-t0).toFixed(1);
    say(`Analyze completed (overlay + ${cnt.toLocaleString()} px).`);
    sumEl.textContent = `AI Summary: Lines highlighted · ${w}×${h} processed in ${ms} ms · Thr=${T}`;
  }catch(err){
    oops('Analyze failed: '+err.message);
    say('Analyze failed.');
  }
});

// slider live re-run if already captured
thr.addEventListener('input', ()=>{
  thrVal.textContent = thr.value;
  if(gotFrame) btnAna.click();
});

// Prevent overlay blocking buttons on some UIs
document.querySelectorAll('.overlay').forEach(el=>el.style.pointerEvents='none');

openCam();
</script>
</body>
</html>
