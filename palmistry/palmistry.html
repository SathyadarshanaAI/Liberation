<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Palmistry Universal · Sathyadarshana</title>
<style>
:root{--pri:#16f0a7;--bg:#0b0f16;--neon:#00e5ff}
body{margin:0;background:var(--bg);color:#e6f0ff;
     font-family:system-ui;text-align:center}
h1{margin:14px 0 6px}
video,canvas{width:92vw;max-width:420px;border-radius:16px;
  border:2px solid var(--pri);display:block;margin:auto;background:#000}
.captureBtn{position:absolute;bottom:18px;left:50%;
 transform:translateX(-50%);width:85px;height:85px;border-radius:50%;
 border:none;background:#2196f3;color:#000;font-weight:600;
 box-shadow:0 0 15px #2196f333;cursor:pointer}
.btns{margin:10px 0;display:flex;gap:8px;
 justify-content:center;flex-wrap:wrap}
button{border:none;border-radius:8px;padding:.6em 1em;font-weight:700;cursor:pointer}
.left{background:#16243a;color:#cfe9ff}
.an{background:var(--pri);color:#000}
.cap{background:#fbbf24;color:#111}
.torch{background:#22c55e;color:#021}
.sliderRow{display:flex;gap:8px;justify-content:center;
 align-items:center;flex-wrap:wrap;margin-bottom:10px}
footer{color:var(--pri);margin:18px 0 22px;font-size:.9em}
.msg{color:#29e0ff;margin-top:6px;font-size:.9em}
</style>
</head>
<body>
<h1>🖐 Palmistry Universal</h1>
<p>Align palm → Capture → Analyze</p>

<div class="wrap" style="position:relative;display:inline-block">
  <video id="cam" playsinline></video>
  <canvas id="cv"></canvas>
  <button class="captureBtn" id="capBtn">📸</button>
</div>

<div class="btns">
  <button class="left" id="flipBtn">↔️ Flip</button>
  <button class="torch" id="torchBtn" hidden>🔦 Torch</button>
  <button class="an" id="anBtn">✨ Analyze</button>
  <button class="cap" id="saveBtn">💾 Save</button>
</div>

<div class="sliderRow">
  <label>Edge <input id="edge" type="range" min="40" max="100" value="70"></label>
  <label>Detail <input id="detail" type="range" min="1" max="5" value="3"></label>
</div>
<div id="status" class="msg"></div>
<footer>© 2025 Sathyadarshana · Palmistry AI Overlay</footer>

<script>
const video=document.getElementById('cam'),
      canvas=document.getElementById('cv'),
      ctx=canvas.getContext('2d');
const flipBtn=document.getElementById('flipBtn'),
      capBtn=document.getElementById('capBtn'),
      anBtn=document.getElementById('anBtn'),
      saveBtn=document.getElementById('saveBtn'),
      torchBtn=document.getElementById('torchBtn');
let flipped=false,captured=false,stream=null,track=null,torch=false;
function msg(t){document.getElementById('status').innerText=t;console.log(t);}

// CAMERA ------------------------------------------------------
async function ensureCamera(){
 try{
   stream=await navigator.mediaDevices.getUserMedia({
     video:{
       facingMode:{ideal:flipped?'user':'environment'},
       width:{ideal:1280},height:{ideal:720}},
     audio:false});
   video.srcObject=stream;await video.play();
   track=stream.getVideoTracks()[0];
   const caps=track.getCapabilities?.();
   if(caps&&caps.torch)torchBtn.hidden=false;
   msg('📷 Camera ready');
 }catch(e){msg('❌ Camera error: '+e.message);}
}
ensureCamera();

flipBtn.onclick=()=>{flipped=!flipped;ensureCamera();};
torchBtn.onclick=async()=>{if(!track)return;
 torch=!torch;try{await track.applyConstraints({advanced:[{torch}]});}catch{}};

// CAPTURE ------------------------------------------------------
capBtn.onclick=async()=>{
 if(!stream)await ensureCamera();
 canvas.width=video.videoWidth||480;canvas.height=video.videoHeight||640;
 ctx.save();if(flipped){ctx.translate(canvas.width,0);ctx.scale(-1,1);}
 ctx.drawImage(video,0,0,canvas.width,canvas.height);ctx.restore();
 captured=true;msg('🖐 Captured. Tap Analyze.');
};

// SAVE ---------------------------------------------------------
saveBtn.onclick=()=>{
 if(!captured)return msg('Capture first');
 const data=canvas.toDataURL('image/png');
 if(/iPhone|iPad|Macintosh/.test(navigator.userAgent)){
   const w=window.open();w.document.write('<img src="'+data+'" style="width:100%">');
   msg('📷 Opened in new tab. Long-press → Save Image.');
 }else{
   const a=document.createElement('a');
   a.href=data;a.download='palm_'+Date.now()+'.png';
   a.click();msg('💾 Saved.');
 }
};

// ANALYZE ------------------------------------------------------
anBtn.onclick=()=>{
 if(!captured)return msg('Capture first');
 try{analyzePureJS();msg('✨ Analyze done');}
 catch(e){msg('❌ '+e.message);}
};

// PURE-JS ANALYZE ---------------------------------------------
function analyzePureJS(){
 // downscale for speed
 if(canvas.width>480){
   const tmp=document.createElement('canvas');
   const s=480/canvas.width;
   tmp.width=480;tmp.height=canvas.height*s;
   tmp.getContext('2d').drawImage(canvas,0,0,tmp.width,tmp.height);
   canvas.width=tmp.width;canvas.height=tmp.height;
   ctx.drawImage(tmp,0,0);
 }
 const w=canvas.width,h=canvas.height,src=ctx.getImageData(0,0,w,h);
 const edgeVal=parseInt(edge.value)/255,passes=parseInt(detail.value);
 const toGray=d=>{const g=new Uint8ClampedArray(w*h);
  for(let i=0,j=0;i<d.data.length;i+=4,j++)
    g[j]=d.data[i]*.299+d.data[i+1]*.587+d.data[i+2]*.114;return g;};
 const blur=(a,p)=>{let b=Float32Array.from(a);
  const k=[1,2,1,2,4,2,1,2,1],n=16;
  for(let t=0;t<p;t++){const r=new Float32Array(w*h);
   for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){
     let s=0,i=0;for(let dy=-1;dy<=1;dy++)
       for(let dx=-1;dx<=1;dx++)s+=b[(y+dy)*w+(x+dx)]*k[i++];
     r[y*w+x]=s/n;}b=r;}return Uint8ClampedArray.from(b);};
 const sobel=(a,thr)=>{const m=new Float32Array(w*h);let mx=1;
  for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){const i=y*w+x;
   const gx=-a[i-w-1]-2*a[i-1]-a[i+w-1]+a[i-w+1]+2*a[i+1]+a[i+w+1];
   const gy=-a[i-w-1]-2*a[i-w]-a[i-w+1]+a[i+w-1]+2*a[i+w]+a[i+w+1];
   const mg=Math.hypot(gx,gy);m[i]=mg;if(mg>mx)mx=mg;}
  const T=thr*mx,bn=new Uint8ClampedArray(w*h);
  for(let i=0;i<w*h;i++)bn[i]=m[i]>T?1:0;return bn;};
 const thin=b=>{
   const img=Uint8Array.from(b);let ch=true,p=0;
   const N=(x,y)=>img[(y-1)*w+x]+img[(y-1)*w+x+1]+img[y*w+x+1]+img[(y+1)*w+x+1]+img[(y+1)*w+x]+img[(y+1)*w+x-1]+img[y*w+x-1]+img[(y-1)*w+x-1];
   const S=(x,y)=>{const p=[img[(y-1)*w+x],img[(y-1)*w+x+1],img[y*w+x+1],img[(y+1)*w+x+1],img[(y+1)*w+x],img[(y+1)*w+x-1],img[y*w+x-1],img[(y-1)*w+x-1]];
    let t=0;for(let i=0;i<8;i++)if(p[i]==0&&p[(i+1)%8]==1)t++;return t;};
   while(ch&&p<25){ch=false;const rm=[];
    for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){
     const i=y*w+x;if(!img[i])continue;const nn=N(x,y),s=S(x,y);
     if(nn>=2&&nn<=6&&s==1&&(img[(y-1)*w+x]*img[y*w+x+1]*img[(y+1)*w+x]==0)&&(img[y*w+x+1]*img[y*w+x-1]*img[(y-1)*w+x]==0))rm.push(i);}
    rm.forEach(i=>img[i]=0);if(rm.length)ch=true;p++;}
   return img;};
 const drawLine=(pts,color,wid)=>{
   if(pts.length<6)return;
   ctx.lineJoin='round';ctx.lineCap='round';
   ctx.strokeStyle='#000';ctx.lineWidth=wid+2;
   ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);
   for(const [x,y] of pts)ctx.lineTo(x,y);ctx.stroke();
   ctx.strokeStyle=color;ctx.lineWidth=wid;
   ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);
   for(const [x,y] of pts)ctx.lineTo(x,y);ctx.stroke();
 };

 const g0=toGray(src),g1=blur(g0,passes),bin=sobel(g1,edgeVal),sk=thin(bin);
 const overlay=ctx.createImageData(w,h);
 for(let i=0,j=0;i<bin.length;i++,j+=4)
  if(bin[i]){overlay.data[j]=0;overlay.data[j+1]=255;overlay.data[j+2]=255;overlay.data[j+3]=90;}
 ctx.putImageData(overlay,0,0);
 ctx.font='18px system-ui';ctx.fillStyle='#fff';
 ctx.fillText('Analyzed',14,24);
}
</script>
</body>
</html>
