<!DOCTYPE html><html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Palmistry Camera Overlay + Analyzer – Lebetion | Sathyadarshana</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <!-- OpenCV.js (for edge + line detection) -->
  <script async src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.9.0-1/opencv.min.js"></script>
  <style>
    :root{
      --bg:#090d13; --bg2:#131e2e; --card:#121b29; --ink:#e0f2fe; --glow:#16f0a7; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg2) 0%,var(--bg) 100%);color:var(--ink);font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center}
    .topbar{position:sticky;top:0;width:100%;display:flex;justify-content:space-between;align-items:center;background:#0b1220d9;backdrop-filter:blur(6px);padding:.7rem 1rem;box-shadow:0 4px 18px #0008;z-index:20}
    .topbar .btn{appearance:none;border:none;border-radius:10px;background:linear-gradient(90deg,var(--glow),var(--accent));color:#111827;font-weight:700;padding:.55rem 1rem;cursor:pointer;box-shadow:0 6px 18px #16f0a73a;transition:transform .12s ease,opacity .12s}
    .topbar .btn:hover{transform:translateY(-1px)}.wrap{width:min(980px,96vw);margin:1rem auto 2rem;display:grid;grid-template-columns:1fr;gap:1rem}

.card{background:#0f172aef;border:1px solid #1f2a44;border-radius:18px;box-shadow:0 0 28px #16f0a746, inset 0 0 0 1px #ffffff06;padding:1rem}
.card h1{font-size:1.1rem;margin:.2rem 0 1rem;color:var(--glow);text-align:center;text-shadow:0 0 12px #16f0a760}

.live{display:grid;grid-template-columns: 1fr;gap:.75rem;align-items:center;justify-items:center}
.stage{position:relative;width:min(520px,95vw);aspect-ratio:3/4;border-radius:16px;background:#111a2b;box-shadow:0 0 24px #16f0a744;overflow:hidden}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border:0}
.ghost{position:absolute;inset:0;width:100%;height:100%;opacity:.42;pointer-events:none;user-select:none;mix-blend-mode:screen}
.hint{position:absolute;left:0;right:0;bottom:8px;text-align:center;color:#c7ebff;text-shadow:0 2px 12px #000c;font-weight:600}
.controls{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center;margin:.2rem auto 0}
.controls .btn{background:#131f30;border:1px solid #1e2b44;color:#d6f3ff;border-radius:10px;padding:.55rem .9rem;font-weight:700;cursor:pointer;box-shadow:0 4px 12px #0008}
.controls .btn.primary{background:linear-gradient(90deg,var(--glow),var(--accent));color:#0b1220}
.controls .btn:disabled{opacity:.45;cursor:not-allowed}

.badgenote{display:inline-block;margin:.4rem auto 0;padding:.35rem .8rem;border-radius:999px;background:linear-gradient(90deg,#f43f5e,#f59e42);color:#fff;font-weight:800;box-shadow:0 6px 18px #0008;border:2px solid #ffffff2a}

.grid2{display:grid;grid-template-columns:1fr;gap:1rem}

.legend{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}
.chip{display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .6rem;border-radius:999px;background:#0f1a2e;border:1px solid #22324f}
.dot{width:14px;height:14px;border-radius:50%}

.chart{width:100%;height:260px;display:block;background:linear-gradient(180deg,#0e1828,#0b1220);border:1px solid #1f2a44;border-radius:14px}

.foot{margin:1rem 0 2rem;text-align:center;color:var(--glow)}

@media (min-width:900px){.grid2{grid-template-columns:1.1fr .9fr}}

  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:800;letter-spacing:.3px">🖐️ Palmistry Overlay + Analyzer</div>
    <div>
      <button class="btn" onclick="location.href='/'">🏠 Home</button>
      <button class="btn" onclick="alert('Language toggle coming soon')">🌐 Language</button>
    </div>
  </div>  <main class="wrap">
    <!-- LIVE CAMERA + OVERLAY -->
    <section class="card live">
      <h1>කැමරාවට අත සමානව තබා ‘Capture ➜ Analyze’ ඔබන්න</h1><div class="stage" id="stage">
    <video id="cam" autoplay playsinline muted></video>
    <!-- Optional: swap to your own PNG overlay with transparent background -->
    <img class="ghost" id="ghost" src="https://i.ibb.co/1K7K0gF/palm-overlay-demo.png" alt="overlay"/>
    <canvas id="paint"></canvas>
    <div class="hint">අත overlay එකට align කර පසු බොත්තම එබන්න</div>
  </div>

  <div class="controls">
    <button class="btn" id="flipBtn">↔️ Flip (R/L)</button>
    <button class="btn" id="overlayBtn">👻 Overlay</button>
    <button class="btn" id="clearBtn">🧹 Clear</button>
    <button class="btn primary" id="capBtn">📸 Capture</button>
    <button class="btn primary" id="anBtn" disabled>✨ Analyze</button>
    <button class="btn" id="saveBtn" disabled>💾 Save PNG</button>
  </div>

  <div class="badgenote">🛡️ HIGH COPYRIGHT – Lebetion | Sathyadarshana 2025</div>
</section>

<!-- RESULTS + CHART -->
<section class="card grid2">
  <div>
    <h1>Detected Lines (Auto + Heuristic)</h1>
    <div class="legend">
      <span class="chip"><span class="dot" style="background:#22d3ee"></span> Heart</span>
      <span class="chip"><span class="dot" style="background:#a78bfa"></span> Head</span>
      <span class="chip"><span class="dot" style="background:#f97316"></span> Life</span>
      <span class="chip"><span class="dot" style="background:#34d399"></span> Fate</span>
      <span class="chip"><span class="dot" style="background:#f43f5e"></span> Others</span>
    </div>
    <p id="note" style="opacity:.9">⚠️ V1 heuristic auto‑detection. If accuracy is low, use manual refine mode below.</p>
    <details>
      <summary style="cursor:pointer;font-weight:800">✏️ Manual refine (draw or tag)</summary>
      <p>Draw on the canvas (mouse/finger). Press <b>Tag ➜ Choose line</b> to assign Life/Head/Heart/Fate to your stroke.</p>
      <div class="controls" style="margin-top:.2rem">
        <button class="btn" id="drawBtn">✏️ Draw</button>
        <button class="btn" id="tagBtn">🏷️ Tag</button>
        <button class="btn" id="undoBtn">↩️ Undo</button>
      </div>
    </details>
  </div>

  <div>
    <h1>Nen Timeline Chart</h1>
    <svg id="chart" class="chart" viewBox="0 0 600 260" preserveAspectRatio="none" role="img" aria-label="line strength over age"></svg>
    <p style="opacity:.9">🧪 Prototype: life‑line තීව්‍රතාව/දිග ප්‍රමාණය අනුව වයස් පරාස (Nen) markers. You can tune mapping in code.</p>
  </div>
</section>

<div class="foot">Palmistry overlay UI · Camera + OpenCV · Edge/Hough + manual fallback · © Sathyadarshana</div>

  </main>  <script>
    // ---------- Camera boot ----------
    const video = document.getElementById('cam');
    const canvas = document.getElementById('paint');
    const ctx = canvas.getContext('2d');
    const stage = document.getElementById('stage');
    const overlayImg = document.getElementById('ghost');
    const chart = document.getElementById('chart');

    let stream; let flipped=false; let captured=false; let drawing=false; let strokes=[]; let lastPoint=null;

    function fitCanvas(){
      const r = stage.getBoundingClientRect();
      canvas.width = r.width; canvas.height = r.height;
    }
    addEventListener('resize', fitCanvas, {passive:true});
    fitCanvas();

    async function startCam(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        video.srcObject = stream;
      }catch(e){
        console.warn(e); alert('📷 කැමරාව ලබාගත නොහැක. Browser permissions പരിശോധන්න.');
      }
    }
    startCam();

    // ---------- UI controls ----------
    const flipBtn = document.getElementById('flipBtn');
    flipBtn.onclick = ()=>{ flipped=!flipped; video.style.transform = flipped? 'scaleX(-1)': 'none'; };

    const overlayBtn = document.getElementById('overlayBtn');
    overlayBtn.onclick = ()=>{ overlayImg.style.opacity = overlayImg.style.opacity===''||overlayImg.style.opacity==='0.42' ? '0' : '0.42'; };

    document.getElementById('clearBtn').onclick = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); strokes=[]; drawStrokes(); };

    document.getElementById('capBtn').onclick = ()=>{
      fitCanvas();
      ctx.save();
      // mirror if flipped
      if(flipped){ ctx.translate(canvas.width,0); ctx.scale(-1,1); }
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      ctx.restore();
      captured=true;
      document.getElementById('anBtn').disabled=false;
      document.getElementById('saveBtn').disabled=false;
    };

    document.getElementById('saveBtn').onclick = ()=>{
      const url = canvas.toDataURL('image/png');
      const a = Object.assign(document.createElement('a'), {href:url, download:'palm-capture.png'});
      a.click();
    };

    // Manual draw + tag
    const drawBtn = document.getElementById('drawBtn');
    const tagBtn  = document.getElementById('tagBtn');
    const undoBtn = document.getElementById('undoBtn');

    drawBtn.onclick = ()=>{ drawing=!drawing; drawBtn.textContent = drawing? '✅ Drawing… (tap again to stop)' : '✏️ Draw'; };
    undoBtn.onclick = ()=>{ strokes.pop(); drawStrokes(); };
    tagBtn.onclick = ()=>{
      if(!strokes.length){ alert('First draw a stroke.'); return; }
      const type = prompt('Tag last stroke as: life/head/heart/fate/other','life');
      if(!type) return; strokes[strokes.length-1].kind = type.toLowerCase(); drawStrokes();
      renderChartFromStrokes();
    };

    canvas.addEventListener('pointerdown', e=>{ if(!drawing) return; lastPoint = pointerPos(e); strokes.push({pts:[lastPoint], kind:'other'}); });
    canvas.addEventListener('pointermove', e=>{ if(!drawing||!lastPoint) return; const p = pointerPos(e); strokes[strokes.length-1].pts.push(p); drawStrokes(); lastPoint=p; });
    addEventListener('pointerup', ()=> lastPoint=null);

    function pointerPos(e){ const r = canvas.getBoundingClientRect(); return {x: (e.clientX - r.left), y: (e.clientY - r.top)}; }

    function drawStrokes(){
      // redraw capture as base (if any)
      if(captured){
        const tmp = document.createElement('canvas'); tmp.width=canvas.width; tmp.height=canvas.height; const tctx=tmp.getContext('2d');
        if(flipped){ tctx.translate(tmp.width,0); tctx.scale(-1,1); }
        tctx.drawImage(video,0,0,tmp.width,tmp.height); // refresh underlay from live
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(tmp,0,0);
      }else{ ctx.clearRect(0,0,canvas.width,canvas.height); }
      // draw each stroke
      for(const s of strokes){
        ctx.lineWidth = 4; ctx.lineJoin='round'; ctx.lineCap='round';
        ctx.strokeStyle = colorForKind(s.kind);
        ctx.beginPath(); s.pts.forEach((p,i)=> i? ctx.lineTo(p.x,p.y): ctx.moveTo(p.x,p.y)); ctx.stroke();
      }
    }

    function colorForKind(k){
      switch((k||'other')){
        case 'heart': return '#22d3ee';
        case 'head':  return '#a78bfa';
        case 'life':  return '#f97316';
        case 'fate':  return '#34d399';
        default:      return '#f43f5e';
      }
    }

    // ---------- Auto ANALYZE with OpenCV ----------
    const anBtn = document.getElementById('anBtn');
    anBtn.onclick = ()=>{ if(!captured){ alert('Capture first.'); return; } runCV(); };

    function runCV(){
      if(!window.cv || !cv.Mat){ alert('OpenCV.js not loaded yet. Try again in a second.'); return; }
      const w = canvas.width, h = canvas.height;
      // read pixels from canvas into OpenCV Mat
      const src = cv.imread(canvas); // RGBA
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(5,5), 1.2, 1.2, cv.BORDER_DEFAULT);
      let edges = new cv.Mat();
      cv.Canny(gray, edges, 60, 140, 3, false);
      // strengthen thin lines
      let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3));
      cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);

      // Hough Probabilistic
      let lines = new cv.Mat();
      cv.HoughLinesP(edges, lines, 1, Math.PI/180, 40, 40, 12);

      // Clear previous auto strokes
      strokes = strokes.filter(s => !s.auto);

      // Heuristic grouping by y/angle/region
      const segs = [];
      for (let i=0; i<lines.rows; i++){
        const [x1,y1,x2,y2] = lines.intPtr(i);
        const dx=x2-x1, dy=y2-y1; const len=Math.hypot(dx,dy);
        if(len<50) continue; // skip tiny
        const ang = Math.atan2(dy,dx); // -pi..pi
        segs.push({x1,y1,x2,y2, len, ang});
      }

      // helper region ratios
      const topY=h*0.30, midY=h*0.45, lowY=h*0.70; // rough bands
      const leftX=w*0.18, rightX=w*0.82, midX=w*0.5;

      const heart = segs.filter(s => (s.y1<topY&&s.y2<topY) && Math.abs(s.ang) > 0.35 && Math.abs(s.ang) < 1.2);
      const head  = segs.filter(s => (Math.min(s.y1,s.y2)>topY && Math.max(s.y1,s.y2)<midY+40) && Math.abs(s.ang)>0.2 && Math.abs(s.ang)<1.2);
      const fate  = segs.filter(s => (Math.abs(s.ang) > 1.35 || Math.abs(s.ang) < 0.2) && Math.min(s.x1,s.x2)>w*0.3 && Math.max(s.x1,s.x2)<w*0.7);
      const life  = segs.filter(s => (Math.min(s.x1,s.x2)<leftX+50) && (Math.max(s.y1,s.y2)>midY) && Math.abs(s.ang)>0.6);

      function topN(arr){ return arr.sort((a,b)=>b.len-a.len).slice(0,6); }

      const picks = [
        ...topN(heart).map(s=>({...s, kind:'heart'})),
        ...topN(head ).map(s=>({...s, kind:'head'} )),
        ...topN(life ).map(s=>({...s, kind:'life'} )),
        ...topN(fate ).map(s=>({...s, kind:'fate'} )),
      ];

      // convert to strokes and draw
      for(const s of picks){
        const stroke = {auto:true, kind:s.kind, pts:[{x:s.x1,y:s.y1},{x:s.x2,y:s.y2}]};
        strokes.push(stroke);
      }
      drawStrokes();

      // derive simple scores for chart
      renderChartFromStrokes();

      // Cleanup
      src.delete(); gray.delete(); edges.delete(); lines.delete(); kernel.delete();
    }

    function renderChartFromStrokes(){
      // Compute pseudo age mapping (Nen): 0..80 mapped along life-line length
      const lifeSegs = strokes.filter(s=>s.kind==='life');
      let lifeLen = lifeSegs.reduce((a,s)=> a + dist(s.pts[0], s.pts[1]), 0);
      if(lifeLen<60){ // fallback to general strength of all lines
        lifeLen = strokes.reduce((a,s)=> a + dist(s.pts[0], s.pts[1]), 0)/2;
      }
      const maxAge = 80; // Nen scale
      // build data points each 10 years based on normalized line density near bands
      const bands = 8; const w=canvas.width, h=canvas.height;
      const density = new Array(bands).fill(0);
      for(const s of strokes){
        const ymid = (s.pts[0].y + s.pts[1].y)/2; const band = Math.min(bands-1, Math.max(0, Math.floor( (ymid/h) * bands )));
        density[band] += dist(s.pts[0], s.pts[1]) * weight(s.kind);
      }
      // normalize
      const maxD = Math.max(...density, 1);
      const points = density.map((v,i)=> ({x:i*(600/(bands-1)), y: 240 - (v/maxD)*200, age:i*(maxAge/(bands-1))}));

      // draw SVG
      chart.innerHTML = '';
      // grid
      const grid = document.createElementNS('http://www.w3.org/2000/svg','g');
      for(let i=0;i<=4;i++){
        const y = 240 - i*50;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', '40'); line.setAttribute('x2','580'); line.setAttribute('y1', y); line.setAttribute('y2', y);
        line.setAttribute('stroke','#23324f'); line.setAttribute('stroke-width','1');
        grid.appendChild(line);
      }
      chart.appendChild(grid);
      // path
      const d = points.map((p,i)=> (i? 'L':'M')+p.x+','+p.y).join(' ');
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('fill','none'); path.setAttribute('stroke','#16f0a7'); path.setAttribute('stroke-width','3');
      chart.appendChild(path);
      // age ticks
      for(const p of points){
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', p.x); t.setAttribute('y', '252'); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','10'); t.setAttribute('fill','#9cc9ff');
        t.textContent = Math.round(p.age);
        chart.appendChild(t);
      }
      // title
      const ttl = document.createElementNS('http://www.w3.org/2000/svg','text');
      ttl.setAttribute('x','300'); ttl.setAttribute('y','18'); ttl.setAttribute('text-anchor','middle'); ttl.setAttribute('font-size','12'); ttl.setAttribute('fill','#bfe7ff'); ttl.setAttribute('font-weight','700');
      ttl.textContent = 'Nen Timeline – heuristic strength vs. age';
      chart.appendChild(ttl);
    }

    function weight(kind){
      return kind==='life'?1.3 : kind==='heart'?1.1 : kind==='head'?1.0 : kind==='fate'?1.15 : 0.7;
    }
    function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
  </script></body>
</html>
