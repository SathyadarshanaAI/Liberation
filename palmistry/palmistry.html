<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palmistry Universal v5.3 ¬∑ Sathyadarshana</title>
<meta name="description" content="Palmistry AI Overlay v5.3 ‚Äî Multilingual palm reading (Heart, Head, Life, Fate, Sun, Marriage, Health) with overlay + printable report.">
<style>
  :root{--pri:#16f0a7;--bg:#0b0f16;--card:#0f1420;--ink:#e6f0ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial;text-align:center;min-height:100vh}
  h1{margin:18px 0 4px} small{opacity:.85}
  .stage{position:relative;display:inline-block;width:min(92vw,520px)}
  #cam{width:100%;border-radius:16px;border:2px solid var(--pri);background:#000;display:block}
  #cv{position:absolute;inset:0;width:100%;height:100%;border-radius:16px;display:none;pointer-events:none}
  .captureBtn{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);width:86px;height:86px;border-radius:50%;border:none;background:#2196f3;color:#000;font-weight:700;box-shadow:0 0 15px #2196f333;cursor:pointer}
  .legend{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 8px}
  .tag{display:inline-flex;gap:6px;align-items:center;margin:4px;padding:4px 10px;border-radius:999px;border:1px solid #2a4b72;background:#0d1a2c;color:#9fd6ff;font-size:.9em}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
  .hrt{background:#ff3b3b}.hd{background:#ffa533}.life{background:#42ff6c}
  .fate{background:#a1a1ff}.sun{background:#ffd54a}.marr{background:#ff8ab0}.hlth{background:#5ad1ff}
  .toggles{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:6px 0}
  .toggles label{background:#142235;border:1px solid #29405f;padding:6px 10px;border-radius:10px;display:flex;align-items:center;gap:6px}
  .btns{margin:10px 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  button,.btnLike{border:none;border-radius:10px;padding:.6em 1em;font-weight:700;cursor:pointer}
  .left{background:#16243a;color:#cfe9ff}.an{background:#16f0a7;color:#062}.report{background:#a78bfa;color:#120}
  select.btnLike,input[type=file].btnLike{background:#19283f;color:#cfe9ff}
  .sliderRow{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;margin:10px 0 6px}
  .sliderRow label{display:flex;gap:8px;align-items:center}
  input[type=range]{accent-color:#16f0a7}
  #status{margin:8px auto 0;padding:10px;border:1px dashed #355;border-radius:10px;color:#cfe;max-width:900px;display:none;white-space:pre-wrap;text-align:left}
  #summary{max-width:900px;margin:10px auto;text-align:left;background:var(--card);border:1px solid #243e60;border-radius:12px;padding:12px;display:none}
  #summary h3{margin:0 0 8px}
  nav{display:flex;gap:10px;justify-content:center;margin:10px 0}
  nav a{color:#9fd6ff;text-decoration:none;border:1px solid #29405f;border-radius:10px;padding:6px 10px}
  nav a:hover{background:#0d1a2c}
  footer{color:#16f0a7;margin:12px 0 22px;font-size:.9em}
</style>
</head>
<body>
  <h1>üñêÔ∏è Palmistry Universal v5.3</h1>
  <small>Multilingual ¬∑ Capture ‚Üí Analyze ‚Üí Report</small>
  <nav><a href="./index.html">‚Üê Back to Home</a></nav>

  <div class="stage">
    <video id="cam" autoplay playsinline muted></video>
    <canvas id="cv"></canvas>
    <button class="captureBtn" id="capBtn">Capture</button>
  </div>

  <div class="legend">
    <span class="tag"><span class="dot hrt"></span><span id="L_heart">Heart</span></span>
    <span class="tag"><span class="dot hd"></span><span id="L_head">Head</span></span>
    <span class="tag"><span class="dot life"></span><span id="L_life">Life</span></span>
    <span class="tag"><span class="dot fate"></span><span id="L_fate">Fate</span></span>
    <span class="tag"><span class="dot sun"></span><span id="L_sun">Sun</span></span>
    <span class="tag"><span class="dot marr"></span><span id="L_marriage">Marriage</span></span>
    <span class="tag"><span class="dot hlth"></span><span id="L_health">Health</span></span>
  </div>

  <div class="toggles">
    <label><input type="checkbox" id="T_primary" checked><span id="T_primary_label">Primary (Heart/Head/Life)</span></label>
    <label><input type="checkbox" id="T_fate" checked><span id="T_fate_label">Fate</span></label>
    <label><input type="checkbox" id="T_sun" checked><span id="T_sun_label">Sun</span></label>
    <label><input type="checkbox" id="T_marriage" checked><span id="T_marriage_label">Marriage</span></label>
    <label><input type="checkbox" id="T_health" checked><span id="T_health_label">Health</span></label>
  </div>

  <div class="btns">
    <button class="btnLike" id="startBtn">‚ñ∂Ô∏è Start</button>
    <select id="camsel" class="btnLike"></select>
    <button class="btnLike" id="cycleBtn">üîÅ Cycle</button>
    <select id="resSel" class="btnLike">
      <option value="1280x720">HD 1280√ó720</option>
      <option value="1920x1080">FullHD 1920√ó1080</option>
      <option value="640x480">VGA 640√ó480</option>
    </select>
    <select id="fpsSel" class="btnLike">
      <option value="30">30 FPS</option><option value="60">60 FPS</option><option value="24">24 FPS</option>
    </select>
    <input id="pick" type="file" accept="image/*" class="btnLike"/>
    <button class="left" id="flipBtn">‚ÜîÔ∏è Flip</button>
    <button class="btnLike" id="torchBtn" hidden>üî¶ Torch</button>
    <label class="btnLike" style="display:flex;align-items:center;gap:8px">Zoom
      <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" style="width:120px">
    </label>
    <button class="an" id="anBtn">‚ú® Analyze</button>
    <button class="report" id="reportBtn">üìÑ Report</button>
    <button class="btnLike" id="clearBtn">üßπ Clear</button>
  </div>

  <div class="sliderRow">
    <label id="edgeLab">Edge <input id="edge" type="range" min="40" max="110" value="75"></label>
    <label id="detLab">Detail <input id="gk" type="range" min="1" max="5" value="3"></label>
  </div>

  <div id="status"></div>

  <div id="summary">
    <h3>üîé AI Summary</h3>
    <div id="sumtext"></div>
  </div>

  <footer>¬© 2025 Sathyadarshana ¬∑ Palmistry AI Overlay v5.3</footer>

<script>
/* ---------------- i18n (EN, SI, AR) ---------------- */
const I18N = {
  en:{title:"Palmistry Universal v5.3",subtitle:"Multilingual ¬∑ Capture ‚Üí Analyze ‚Üí Report",
    back:"Back to Home",
    legend:{heart:"Heart",head:"Head",life:"Life",fate:"Fate",sun:"Sun",marriage:"Marriage",health:"Health"},
    toggles:{primary:"Primary (Heart/Head/Life)",fate:"Fate",sun:"Sun",marriage:"Marriage",health:"Health"},
    ui:{start:"‚ñ∂Ô∏è Start",cycle:"üîÅ Cycle",flip:"‚ÜîÔ∏è Flip",zoom:"Zoom",analyze:"‚ú® Analyze",report:"üìÑ Report",clear:"üßπ Clear",
        res_hd:"HD 1280√ó720",res_fhd:"FullHD 1920√ó1080",res_vga:"VGA 640√ó480",
        fps30:"30 FPS",fps60:"60 FPS",fps24:"24 FPS",pick_placeholder:"Choose image‚Ä¶"},
    msg:{start_hint:"‚ñ∂Ô∏è Start ‚Üí Allow camera. Capture/Upload ‚Üí Analyze. Report shows overlay + long reading.",
         https:"üîí Use HTTPS for best camera support.",
         cam_err:"‚ùå Camera error: ",torch_err:"Torch error.",need_capture:"First Capture or Choose Photo.",
         need_analyze:"Run Analyze first.",photo_locked:"üñêÔ∏è Photo locked. Analyze to detect lines.",
         photo_loaded:"üñºÔ∏è Photo loaded. Analyze.",cleared:"üßπ Cleared. Ready.",
         analyzing:"‚è≥ Analyzing‚Ä¶",analyze_fail:"‚ùå Analyze failed: "},
    report:{title:"üñêÔ∏è Palmistry Report",legend:"Legend",save:"Save Image",print:"Print / Save PDF",
            copyright:"¬© Sathyadarshana ¬∑ Palmistry AI v5.3",detailed:"AI Summary (Detailed)",
            notes:"Notes: This reading is educational and not medical advice."},
    lines:{heart:"‚ù§Ô∏è Heart line",head:"üß° Head (Cheettha) line",life:"üíö Life line",fate:"üü™ Fate (IraNami) line",
           sun:"üü® Sun line",marriage:"ü©∑ Marriage lines",health:"ü©µ Health line"},
    meanings:{
      heartStrong:"Warm, empathetic nature; bonds deeply with people. Emotions expressed with control; relationships benefit from stability.",
      heartWeak:"Emotional energy appears sensitive; practice boundaries and self-care.",
      headStrong:"Clear thinker with practical problem-solving; learns by doing.",
      headWeak:"Focus may diffuse; use checklists and single-tasking.",
      lifeStrong:"Good vitality and resilience; steady stamina; adaptable.",
      lifeWeak:"Energy may fluctuate; prioritize sleep, hydration, and morning light.",
      fateStrong:"Purpose grows through consistent effort; career path clarifies with age.",
      fateWeak:"External factors influence direction; keep optionality and upskill.",
      sunStrong:"Creativity/reputation grows via consistent craft work.",
      sunWeak:"Recognition low now; publish small works frequently.",
      healthStrong:"Recovery is good; keep posture and breath work.",
      healthWeak:"Watch workload/posture; take micro-breaks and stretch."
    },
    grades:{weak:"weak",fragmented:"fragmented",strong:"strong",moderate:"moderate"},
    orient:{up:"tilt-up",down:"tilt-down",level:"level"}, rtl:false
  },
  si:{title:"Palmistry Universal v5.3",subtitle:"‡∂∂‡∑Ñ‡∑î‡∂∑‡∑è‡∑Ç‡∑è ¬∑ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‚Üí ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‚Üí ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä",
    back:"‡∂∏‡∑î‡∂Ω‡∑ä ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∂ß",
    legend:{heart:"‡∑Ñ‡∑ò‡∂Ø‡∂∫",head:"‡∑É‡∑í‡∂≠‡∑ä‡∂≠‡∂∏‡∑ä (Head)",life:"‡∂¢‡∑ì‡∑Ä‡∑í‡∂≠‡∂∫",fate:"‡∂â‡∂ª‡∂´‡∑è‡∂∏‡∑í / ‡∑Ä‡∑í‡∂∞‡∑í",sun:"‡∑É‡∑ñ‡∂ª‡∑ä‡∂∫",marriage:"‡∑Ä‡∑è‡∑Ñ‡∂∫",health:"‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫‡∂∫"},
    toggles:{primary:"‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂Æ‡∂∏‡∑í‡∂ö (Heart/Head/Life)",fate:"‡∂â‡∂ª‡∂´‡∑è‡∂∏‡∑í/Fate",sun:"Sun",marriage:"Marriage",health:"Health"},
    ui:{start:"‚ñ∂Ô∏è ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑",cycle:"üîÅ Cycle",flip:"‚ÜîÔ∏è Flip",zoom:"Zoom",analyze:"‚ú® ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫",report:"üìÑ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä",clear:"üßπ Clear",
        res_hd:"HD 1280√ó720",res_fhd:"FullHD 1920√ó1080",res_vga:"VGA 640√ó480",
        fps30:"30 FPS",fps60:"60 FPS",fps24:"24 FPS",pick_placeholder:"‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±‚Ä¶"},
    msg:{start_hint:"‚ñ∂Ô∏è Start ‚Üí ‡∂ö‡∑ê‡∂∏‡∂ª‡∑è ‡∂Ö‡∂∫‡∑í‡∂≠‡∑í‡∂∫ ‡∂Ø‡∑ì Capture/Upload ‚Üí Analyze ‚Üí Report.",
         https:"üîí HTTPS ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",cam_err:"‚ùå ‡∂ö‡∑ê‡∂∏‡∂ª‡∑è ‡∂Ø‡∑ù‡∑Ç‡∂∫: ",torch_err:"Torch ‡∂Ø‡∑ù‡∑Ç‡∂∫.",
         need_capture:"‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä Capture ‡∑Ñ‡∑ù Photo ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.",need_analyze:"Analyze ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂∞‡∑è‡∑Ä‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
         photo_locked:"üñêÔ∏è Photo locked. Analyze ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",photo_loaded:"üñºÔ∏è Photo loaded.",cleared:"üßπ ‡∑Ñ‡∑í‡∑É‡∑ä ‡∂ö‡∑Ö‡∑è.",
         analyzing:"‚è≥ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä‚Ä¶",analyze_fail:"‚ùå Analyze failed: "},
    report:{title:"üñêÔ∏è Palmistry Report",legend:"Legend",save:"‡∂ª‡∑ñ‡∂¥‡∂∫ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±",print:"Print / PDF",
            copyright:"¬© Sathyadarshana ¬∑ Palmistry AI v5.3",detailed:"AI ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫ (‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö)",
            notes:"‡∑É‡∂ß‡∑Ñ‡∂±: ‡∂∏‡∑ô‡∂∫ ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∂ö‡∑è‡∂ª‡∑ä‚Äç‡∂∫‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∂∏‡∂´‡∑í."},
    lines:{heart:"‚ù§Ô∏è ‡∑Ñ‡∑ò‡∂Ø‡∂∫",head:"üß° ‡∑É‡∑í‡∂≠‡∑ä‡∂≠‡∂∏‡∑ä",life:"üíö ‡∂¢‡∑ì‡∑Ä‡∑í‡∂≠‡∂∫",fate:"üü™ ‡∂â‡∂ª‡∂´‡∑è‡∂∏‡∑í",sun:"üü® ‡∑É‡∑ñ‡∂ª‡∑ä‡∂∫",marriage:"ü©∑ ‡∑Ä‡∑è‡∑Ñ‡∂∫",health:"ü©µ ‡∑É‡∑û‡∂õ‡∑ä‚Äç‡∂∫‡∂∫"},
    meanings:{heartStrong:"‡∂Ö‡∂±‡∑î‡∂ö‡∂∏‡∑ä‡∂¥‡∑è‡∑Ä‡∂≠‡∑ä; ‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∑É‡∂∂‡∂≥‡∂≠‡∑è.",heartWeak:"‡∂Ö‡∂≠‡∑í‡∑É‡∂Ç‡∑Ä‡∑ö‡∂Ø‡∑ì; ‡∑É‡∑ì‡∂∏‡∑è ‡∂Ö‡∂∑‡∑ä‚Äç‡∂∫‡∑è‡∑É ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±.",
      headStrong:"‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∑É‡∑í‡∂≠; ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂∏‡∂∫ ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∑ä.",headWeak:"‡∂ö‡∑ö‡∂±‡∑ä‡∂Ø‡∑ä‚Äç‡∂ª‡∑ì‡∂ö‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑í‡∑Ñ‡∑í‡∂Ø‡∑ô‡∂∫‡∑í; ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä‡∂ö‡∑ä/Single-tasking.",
      lifeStrong:"‡∂Ü‡∂≠‡∑ä‡∂∏ ‡∑Å‡∂ö‡∑ä‡∂≠‡∑í‡∂∏‡∂≠‡∑ä; ‡∂¥‡∂ª‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥‡∑í‡∂≠.",lifeWeak:"‡∑Å‡∂ö‡∑ä‡∂≠‡∑í‡∂∫ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö; ‡∂±‡∑í‡∂±‡∑ä‡∂Ø/‡∂Ø‡∑ô‡∑Ñ‡∑í‡∂Ø‡∑ì‡∂∏/‡∂ã‡∂Ø‡∑ö ‡∂Ü‡∂Ω‡∑ù‡∂ö‡∂∫.",
      fateStrong:"‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª‡∑ô‡∂±‡∑ä-‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∑Ä‡∑ò‡∂≠‡∑ä‡∂≠‡∑ì‡∂∫ ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∑Ä‡∑ô‡∂∫‡∑í.",fateWeak:"‡∂¥‡∑í‡∂ß‡∂≠ ‡∂∂‡∂Ω‡∂¥‡∑ë‡∂∏‡∑ä; ‡∂≠‡∑ö‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠‡∑Ä ‡∂≠‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±.",
      sunStrong:"‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ì‡∂´‡∂≠‡∑è/‡∂¥‡∑ä‚Äç‡∂ª‡∑É‡∑í‡∂Ø‡∑ä‡∂∞‡∑í‡∂∫ ‡∑Ä‡∑ê‡∂©‡∑ö ‡∑É‡∂∏‡∂ú ‡∂â‡∑Ñ‡∑Ö‡∂ß.",sunWeak:"‡∂Ø‡∑ê‡∂±‡∑ä ‡∂Ö‡∂©‡∑î; ‡∂ö‡∑î‡∂©‡∑è ‡∂ö‡∑ò‡∂≠‡∑í ‡∂±‡∑í‡∂≠‡∂ª ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
      healthStrong:"‡∂¥‡∑î‡∂ª‡∑î‡∑Ç‡∑è‡∂ª‡∂Æ‡∂∫/‡∂∑‡∑è‡∑Ä‡∂±‡∑è‡∑Ä ‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í.",healthWeak:"‡∑Ä‡∑ê‡∂©‡∂∑‡∑è‡∂ª/ÂßøÂã¢ ‡∂∏‡∂≠‡∂ö ‡∂≠‡∂∂‡∑è ‡∂ï‡∂±‡∑ë ‡∑Ä‡∑í‡∂ª‡∑è‡∂∏."},
    grades:{weak:"‡∂Ö‡∂©‡∑î",fragmented:"‡∂ö‡∑ê‡∂∂‡∂Ω‡∑í-‡∑Ä‡∑ñ",strong:"‡∂â‡∑Ñ‡∑Ö",moderate:"‡∂∏‡∂∞‡∑ä‚Äç‡∂∫‡∑É‡∑ä‡∂Æ"},
    orient:{up:"‡∂ã‡∂©‡∂ß ‡∂±‡∂∏‡∑ì",down:"‡∂¥‡∑Ñ‡∑Ö‡∂ß ‡∂±‡∂∏‡∑ì",level:"‡∑É‡∂∏"}, rtl:false
  },
  ar:{title:"‚ÄèPalmistry v5.3",subtitle:"ŸÖÿ™ÿπÿØÿØ ÿßŸÑŸÑÿ∫ÿßÿ™ ¬∑ ÿßŸÑÿ™ŸÇÿ∑ ‚Üí ÿ≠ŸÑŸëŸÑ ‚Üí ÿ™ŸÇÿ±Ÿäÿ±",
    back:"ÿßŸÑÿπŸàÿØÿ©",legend:{heart:"ÿßŸÑŸÇŸÑÿ®",head:"ÿßŸÑÿπŸÇŸÑ",life:"ÿßŸÑÿ≠Ÿäÿßÿ©",fate:"ÿßŸÑŸÇÿØÿ±",sun:"ÿßŸÑÿ¥ŸÖÿ≥",marriage:"ÿßŸÑÿ≤Ÿàÿßÿ¨",health:"ÿßŸÑÿµÿ≠ÿ©"},
    toggles:{primary:"ÿ£ÿ≥ÿßÿ≥Ÿä (ŸÇŸÑÿ®/ÿπŸÇŸÑ/ÿ≠Ÿäÿßÿ©)",fate:"ÿßŸÑŸÇÿØÿ±",sun:"ÿßŸÑÿ¥ŸÖÿ≥",marriage:"ÿßŸÑÿ≤Ÿàÿßÿ¨",health:"ÿßŸÑÿµÿ≠ÿ©"},
    ui:{start:"‚ñ∂Ô∏è ÿßÿ®ÿØÿ£",cycle:"üîÅ ÿ™ÿ®ÿØŸäŸÑ",flip:"‚ÜîÔ∏è ÿπŸÉÿ≥",zoom:"ÿ™ŸÉÿ®Ÿäÿ±",analyze:"‚ú® ÿ™ÿ≠ŸÑŸäŸÑ",report:"üìÑ ÿ™ŸÇÿ±Ÿäÿ±",clear:"üßπ ŸÖÿ≥ÿ≠",
        res_hd:"HD 1280√ó720",res_fhd:"FullHD 1920√ó1080",res_vga:"VGA 640√ó480",
        fps30:"30 ÿ•ÿ∑ÿßÿ±/ÿ´",fps60:"60 ÿ•ÿ∑ÿßÿ±/ÿ´",fps24:"24 ÿ•ÿ∑ÿßÿ±/ÿ´",pick_placeholder:"ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©‚Ä¶"},
    msg:{start_hint:"‚ñ∂Ô∏è ÿßÿ®ÿØÿ£ ÿ´ŸÖ ÿßÿ≥ŸÖÿ≠ ŸÑŸÑŸÉÿßŸÖŸäÿ±ÿß‚Ä¶",https:"üîí ÿßÿ≥ÿ™ÿÆÿØŸÖ HTTPS",
         cam_err:"‚ùå ÿÆÿ∑ÿ£ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß: ",torch_err:"ÿÆÿ∑ÿ£ ÿßŸÑŸÖÿµÿ®ÿßÿ≠.",need_capture:"ÿßŸÑÿ™ŸÇÿ∑ ÿ£Ÿà ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã.",
         need_analyze:"ÿ¥ÿ∫ŸëŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿ£ŸàŸÑÿßŸã.",photo_locked:"üñêÔ∏è ÿ™ŸÖ ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™. ÿ≠ŸÑŸëŸÑ ÿßŸÑÿ¢ŸÜ.",
         photo_loaded:"üñºÔ∏è ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ. ÿ≠ŸÑŸëŸÑ.",cleared:"üßπ ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠.",
         analyzing:"‚è≥ ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ‚Ä¶",analyze_fail:"‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ: "},
    report:{title:"üñêÔ∏è ÿ™ŸÇÿ±Ÿäÿ± ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÉŸÅ",legend:"ÿßŸÑÿØŸÑŸäŸÑ",save:"ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ©",print:"ÿ∑ÿ®ÿßÿπÿ© / PDF",
            copyright:"¬© Sathyadarshana ¬∑ Palmistry AI v5.3",detailed:"ŸÖŸÑÿÆÿµ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä",
            notes:"ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸÇÿ±ÿßÿ°ÿ© ÿ™ÿπŸÑŸäŸÖŸäÿ© ŸàŸÑŸäÿ≥ÿ™ ÿ∑ÿ®Ÿäÿ©."},
    lines:{heart:"‚ù§Ô∏è ÿÆÿ∑ ÿßŸÑŸÇŸÑÿ®",head:"üß° ÿÆÿ∑ ÿßŸÑÿπŸÇŸÑ",life:"üíö ÿÆÿ∑ ÿßŸÑÿ≠Ÿäÿßÿ©",fate:"üü™ ÿÆÿ∑ ÿßŸÑŸÇÿØÿ±",sun:"üü® ÿÆÿ∑ ÿßŸÑÿ¥ŸÖÿ≥",marriage:"ü©∑ ÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿ≤Ÿàÿßÿ¨",health:"ü©µ ÿÆÿ∑ ÿßŸÑÿµÿ≠ÿ©"},
    meanings:{heartStrong:"ÿπÿßÿ∑ŸÅÿ© ÿØÿßŸÅÿ¶ÿ© Ÿàÿ±Ÿàÿßÿ®ÿ∑ ÿ´ÿßÿ®ÿ™ÿ©.",heartWeak:"ÿ≠ÿ≥ÿßÿ≥Ÿäÿ© ÿπÿßÿ∑ŸÅŸäÿ©ÿõ ÿßÿπÿ™ŸÜŸê ÿ®ÿßŸÑÿ≠ÿØŸàÿØ.",
      headStrong:"ÿ™ŸÅŸÉŸäÿ± Ÿàÿßÿ∂ÿ≠ Ÿàÿ≠ŸÑŸàŸÑ ÿπŸÖŸÑŸäÿ©.",headWeak:"ÿ™ÿ¥ÿ™ÿ™ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ÿõ ŸÇŸàÿßÿ¶ŸÖ ŸàŸÖŸáŸÖÿ© Ÿàÿßÿ≠ÿØÿ©.",
      lifeStrong:"ÿ≠ŸäŸàŸäÿ© ÿ¨ŸäÿØÿ© ŸàŸÖÿ±ŸàŸÜÿ©.",lifeWeak:"ÿ™ŸÇŸÑŸëÿ®ÿßÿ™ ÿßŸÑÿ∑ÿßŸÇÿ©ÿõ ŸÜŸàŸÖ ŸàŸÖÿßÿ° Ÿàÿ∂Ÿàÿ° ÿµÿ®ÿßÿ≠Ÿä.",
      fateStrong:"Ÿäÿ™ÿ∂ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÖÿπ ÿßŸÑÿ¨ŸáÿØ ÿßŸÑŸÖÿ™ŸàÿßÿµŸÑ.",fateWeak:"ÿπŸàÿßŸÖŸÑ ÿÆÿßÿ±ÿ¨Ÿäÿ© ÿ™ÿ§ÿ´ÿ±ÿõ Ÿàÿ≥Ÿëÿπ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™.",
      sunStrong:"ÿ™ŸÜŸÖŸà ÿßŸÑÿ≥ŸÖÿπÿ© ÿ®ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±.",sunWeak:"ÿ•ÿ®ÿ±ÿßÿ≤ ŸÇŸÑŸäŸÑ ÿßŸÑÿ¢ŸÜÿõ ÿßŸÜÿ¥ÿ± ÿ£ÿπŸÖÿßŸÑÿßŸã ÿµÿ∫Ÿäÿ±ÿ©.",
      healthStrong:"ÿ™ÿπÿßŸÅŸç ÿ¨ŸäÿØÿõ Ÿàÿ∂ÿπ Ÿàÿ™ŸÜŸÅÿ≥.",healthWeak:"ÿÆŸÅŸÅ ÿßŸÑÿπÿ®ÿ° ŸàÿÆÿ∞ ŸÅŸàÿßÿµŸÑ."},
    grades:{weak:"ÿ∂ÿπŸäŸÅ",fragmented:"ŸÖÿ¨ÿ≤ÿ£",strong:"ŸÇŸàŸä",moderate:"ŸÖÿ™Ÿàÿ≥ÿ∑"},
    orient:{up:"ŸÖÿßÿ¶ŸÑ ŸÑŸÑÿ£ÿπŸÑŸâ",down:"ŸÖÿßÿ¶ŸÑ ŸÑŸÑÿ£ÿ≥ŸÅŸÑ",level:"ŸÖÿ≥ÿ™ŸàŸä"},
    rtl:true
  }
};

/* ---------- pick language & apply ---------- */
function getLang(){
  const q=new URL(location.href).searchParams.get('lang')||'';
  const stored=localStorage.getItem('palm_lang')||'';
  const nav=(navigator.language||'en').slice(0,2).toLowerCase();
  const prefer=(q||stored||nav);
  if(I18N[prefer]) return prefer;
  if(prefer.startsWith('si')) return 'si';
  if(prefer.startsWith('ar')) return 'ar';
  return 'en';
}
let LANG=getLang();
localStorage.setItem('palm_lang',LANG);
function tpath(path,fallback=""){const seg=path.split('.'); let o=I18N[LANG];
  for(const k of seg){ if(!o) return fallback; o=o[k]; }
  return (typeof o==="string")?o:(o||fallback);
}
function applyI18n(){
  document.title = tpath('title')+' ¬∑ Sathyadarshana';
  document.querySelector('h1').textContent = 'üñêÔ∏è '+tpath('title');
  document.querySelector('small').textContent = tpath('subtitle');
  document.querySelector('nav a').textContent = '‚Üê '+tpath('back');

  const L = I18N[LANG].legend;
  const ids = ['L_heart','L_head','L_life','L_fate','L_sun','L_marriage','L_health'];
  const names = [L.heart,L.head,L.life,L.fate,L.sun,L.marriage,L.health];
  ids.forEach((id,i)=>document.getElementById(id).textContent=names[i]);

  const T = I18N[LANG].toggles;
  document.getElementById('T_primary_label').textContent=T.primary;
  document.getElementById('T_fate_label').textContent=T.fate;
  document.getElementById('T_sun_label').textContent=T.sun;
  document.getElementById('T_marriage_label').textContent=T.marriage;
  document.getElementById('T_health_label').textContent=T.health;

  const U = I18N[LANG].ui;
  byId('startBtn').textContent=U.start; byId('cycleBtn').textContent=U.cycle;
  byId('flipBtn').textContent=U.flip; byId('anBtn').textContent=U.analyze;
  byId('reportBtn').textContent=U.report; byId('clearBtn').textContent=U.clear;
  byId('fpsSel').innerHTML=`<option value="30">${U.fps30}</option><option value="60">${U.fps60}</option><option value="24">${U.fps24}</option>`;
  byId('resSel').innerHTML=`<option value="1280x720">${U.res_hd}</option><option value="1920x1080">${U.res_fhd}</option><option value="640x480">${U.res_vga}</option>`;
  byId('pick').setAttribute('title',U.pick_placeholder);

  document.querySelector('#summary h3').textContent = 'üîé '+(tpath('report.detailed')||'AI Summary (Detailed)');

  const isRTL = !!I18N[LANG].rtl;
  document.documentElement.dir = isRTL?'rtl':'ltr';
  document.body.style.direction = isRTL?'rtl':'ltr';
}

/* ---------------- refs ---------------- */
const video=byId('cam'), cv=byId('cv'), ctx=cv.getContext('2d');
const startBtn=byId('startBtn'), camsel=byId('camsel'), cycleBtn=byId('cycleBtn');
const resSel=byId('resSel'), fpsSel=byId('fpsSel'), zoomEl=byId('zoom');
const pick=byId('pick'), flipBtn=byId('flipBtn'), torchBtn=byId('torchBtn');
const capBtn=byId('capBtn'), anBtn=byId('anBtn'), reportBtn=byId('reportBtn'), clearBtn=byId('clearBtn');
const T_primary=byId('T_primary'), T_fate=byId('T_fate'), T_sun=byId('T_sun'), T_marriage=byId('T_marriage'), T_health=byId('T_health');

let stream=null, track=null, captured=false, isMirrored=false;
let last=null;          // metrics
let lastOverlay=null;   // dataURL of canvas with colored lines

function byId(x){return document.getElementById(x)}
function msg(t){ const s=byId('status'); s.textContent=t; s.style.display='block'; }
function showSummary(html){ const b=byId('summary'); byId('sumtext').innerHTML=html; b.style.display='block'; }
function parseRes(v){ const [w,h]=v.split('x').map(Number); return {w,h}; }
function norm(maxW=1280,maxPx=1500000){
  if(cv.width<=0||cv.height<=0) return;
  const tooW=cv.width>maxW, tooPx=cv.width*cv.height>maxPx;
  if(!(tooW||tooPx)) return;
  const s=Math.min(maxW/cv.width, Math.sqrt(maxPx/(cv.width*cv.height)));
  const w=Math.max(Math.round(cv.width*s),540), h=Math.round(cv.height*s);
  const t=document.createElement('canvas'); t.width=w; t.height=h;
  t.getContext('2d').drawImage(cv,0,0,w,h); cv.width=w; cv.height=h; ctx.drawImage(t,0,0);
}

/* ---------------- camera ---------------- */
async function ensurePerm(){
  if(!navigator.mediaDevices?.getUserMedia) throw new Error('No mediaDevices');
  const t=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); t.getTracks().forEach(x=>x.stop());
}
let camList=[], camIndex=0;
async function listCams(){
  const devs=await navigator.mediaDevices.enumerateDevices();
  camList=devs.filter(d=>d.kind==='videoinput');
  camsel.innerHTML=''; camList.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`Camera ${i+1}`; camsel.appendChild(o); });
  camsel.selectedIndex=0; camIndex=0;
}
async function startCam(id=null){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; }
  const {w,h}=parseRes(resSel.value||'1280x720'); const fps=Number(fpsSel.value||30);
  const facing=isMirrored?'user':'environment';
  const cons={ video:id?{deviceId:{exact:id}}:{facingMode:{ideal:facing}}, audio:false };
  Object.assign(cons.video,{ width:{ideal:w,max:w}, height:{ideal:h,max:h}, frameRate:{ideal:fps,max:fps} });
  try{ stream=await navigator.mediaDevices.getUserMedia(cons); }
  catch{ stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); }
  video.srcObject=stream; await video.play(); track=stream.getVideoTracks()[0];
  const W=video.videoWidth||w, H=video.videoHeight||h; cv.width=W; cv.height=H;
  video.style.transform=isMirrored?'scaleX(-1)':'none'; cv.style.display=captured?'block':'none';
  const caps=track.getCapabilities?.()||{}; torchBtn.hidden=!('torch' in caps);
  if('zoom' in caps){ zoomEl.min=caps.zoom.min||1; zoomEl.max=caps.zoom.max||5; zoomEl.step=caps.zoom.step||0.1; zoomEl.value=(track.getSettings?.().zoom)||zoomEl.min; zoomEl.parentElement.style.display=''; } else zoomEl.parentElement.style.display='none';
  msg(`üì∑ ${track.label||'Camera'} ‚Ä¢ ${W}√ó${H}@${fps}`);
}
startBtn.onclick=async()=>{
  try{
    if(location.protocol!=='https:' && location.hostname!=='localhost') msg(tpath('msg.https'));
    await ensurePerm(); await listCams(); await startCam(camsel.value||camList[0]?.deviceId||null);
  }catch(e){ msg(tpath('msg.cam_err')+(e.message||e)); }
};
cycleBtn.onclick=async()=>{ if(!camList.length) await listCams(); if(!camList.length) return msg('No cameras');
  camIndex=(camIndex+1)%camList.length; camsel.selectedIndex=camIndex; await startCam(camList[camIndex].deviceId); };
camsel.onchange=async()=>startCam(camsel.value);
resSel.onchange=async()=>startCam(camsel.value||null);
fpsSel.onchange=async()=>startCam(camsel.value||null);
flipBtn.onclick=async()=>{ isMirrored=!isMirrored; if(stream && !captured){ video.style.transform=isMirrored?'scaleX(-1)':'none'; await startCam(camsel.value||null); } else if(captured){ mirrorCanvas(); } };
torchBtn.onclick=async()=>{ if(!track) return; try{ const on=(track.getSettings?.().torch)||false; await track.applyConstraints({advanced:[{torch:!on}]}); } catch(e){ msg(tpath('msg.torch_err')); } };
zoomEl.oninput=async()=>{ if(!track) return; try{ await track.applyConstraints({advanced:[{zoom:Number(zoomEl.value)}]}); }catch{} };
function mirrorCanvas(){
  const t=document.createElement('canvas'); t.width=cv.width; t.height=cv.height;
  t.getContext('2d').drawImage(cv,0,0); ctx.save(); ctx.setTransform(-1,0,0,1,cv.width,0); ctx.drawImage(t,0,0); ctx.restore();
}

/* ---------------- capture & file ---------------- */
capBtn.onclick=async()=>{
  if(!stream) await startCam(camsel.value||null);
  if(!video.videoWidth) await new Promise(r=>setTimeout(r,100));
  cv.width=video.videoWidth; cv.height=video.videoHeight; ctx.save();
  if(isMirrored){ ctx.translate(cv.width,0); ctx.scale(-1,1); }
  ctx.drawImage(video,0,0,cv.width,cv.height); ctx.restore();
  norm(1280,1500000); cv.style.display='block'; captured=true; last=null; lastOverlay=null;
  byId('summary').style.display='none'; msg(tpath('msg.photo_locked'));
};
pick.onchange=e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const img=new Image(); img.onload=()=>{ cv.width=img.naturalWidth; cv.height=img.naturalHeight; ctx.drawImage(img,0,0);
    if(isMirrored) mirrorCanvas(); norm(1280,1500000); cv.style.display='block'; captured=true; last=null; lastOverlay=null;
    byId('summary').style.display='none'; msg(tpath('msg.photo_loaded')); };
  img.onerror=()=>msg('‚ùå Image load failed'); img.src=URL.createObjectURL(f);
};
clearBtn.onclick=()=>{ ctx.clearRect(0,0,cv.width,cv.height); captured=false; cv.style.display='none'; last=null; lastOverlay=null; byId('summary').style.display='none'; msg(tpath('msg.cleared')); };

/* ---------------- REPORT (overlay + text) ---------------- */
reportBtn.onclick=()=>{
  if(!captured){ msg(tpath('msg.need_capture')); return; }
  if(!last){ msg(tpath('msg.need_analyze')); return; }
  const R=I18N[LANG].report, isRTL=!!I18N[LANG].rtl;
  const imgData=cv.toDataURL('image/png'); const details=buildDetailedReading(last);
  const w=window.open('','_blank');
  w.document.write(`
  <html><head><title>${R.title}</title><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0;padding:12px;color:#123;background:#f7f9fc;${isRTL?'direction:rtl':''}}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .box{border:1px solid #ccd;background:#fff;padding:10px;border-radius:10px}
    .imgWrap{max-width:min(92vw,700px)}
    img{max-width:100%;height:auto;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid #cfe;background:#eef6ff;color:#134}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
    .hrt{background:#ff3b3b}.hd{background:#ffa533}.life{background:#42ff6c}.fate{background:#a1a1ff}.sun{background:#ffd54a}.marr{background:#ff8ab0}.hlth{background:#5ad1ff}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    button{padding:.5em 1em;border-radius:10px;border:1px solid #aac;background:#fff;cursor:pointer}
    .muted{opacity:.8}
  </style></head><body>
  <h2>${R.title}</h2>
  <div class="row">
    <div class="imgWrap box"><img src="${imgData}" alt="Palmistry Overlay"/></div>
    <div class="box" style="flex:1;min-width:260px">
      <h3>${R.legend}</h3>
      <div class="legend">
        <span class="tag"><span class="dot hrt"></span>${tpath('legend.heart')}</span>
        <span class="tag"><span class="dot hd"></span>${tpath('legend.head')}</span>
        <span class="tag"><span class="dot life"></span>${tpath('legend.life')}</span>
        <span class="tag"><span class="dot fate"></span>${tpath('legend.fate')}</span>
        <span class="tag"><span class="dot sun"></span>${tpath('legend.sun')}</span>
        <span class="tag"><span class="dot marr"></span>${tpath('legend.marriage')}</span>
        <span class="tag"><span class="dot hlth"></span>${tpath('legend.health')}</span>
      </div>
      <div class="btns">
        <button onclick="downloadImg()">${R.save}</button>
        <button onclick="window.print()">${R.print}</button>
      </div>
      <div class="muted">${R.copyright}</div>
    </div>
  </div>
  <div class="box" style="margin-top:12px">${details}</div>
  <script>function downloadImg(){const a=document.createElement('a');a.href='${imgData}';a.download='palmistry_overlay.png';a.click();}</script>
  </body></html>`);
  w.document.close();
};

/* ---------------- ANALYZE ---------------- */
anBtn.onclick=()=>{
  if(!captured) return msg(tpath('msg.need_capture'));
  msg(tpath('msg.analyzing'));
  setTimeout(()=>{ try{ analyze(); } catch(e){ console.error(e); msg(tpath('msg.analyze_fail')+(e.message||e)); } }, 50);
};

function analyze(){
  if(!cv.width||!cv.height){ msg('No canvas'); return; }
  norm(1024,1000000);
  let w=cv.width, h=cv.height, src;
  for(let i=0;i<2;i++){
    try{ src=ctx.getImageData(0,0,w,h); break; }
    catch(e){
      const t=document.createElement('canvas'); t.width=Math.round(w*0.8); t.height=Math.round(h*0.8);
      t.getContext('2d').drawImage(cv,0,0,t.width,t.height);
      cv.width=t.width; cv.height=t.height; ctx.drawImage(t,0,0); w=cv.width; h=cv.height;
    }
  }
  const wh=w*h, edgeVal=parseInt(byId('edge').value,10)/255, passes=parseInt(byId('gk').value,10);
  // grayscale
  const d=src.data, gray=new Uint8ClampedArray(wh);
  for(let i=0,j=0;i<d.length;i+=4,j++) gray[j]=d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114;
  // blur
  let a=Float32Array.from(gray); const k=[1,2,1,2,4,2,1,2,1], kn=16;
  for(let p=0;p<passes;p++){
    const t=new Float32Array(wh);
    for(let y=1;y<h-1;y++) for(let x=1;x<w-1;x++){
      let s=0,i=0; for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) s+=a[(y+dy)*w+(x+dx)]*k[i++]; t[y*w+x]=s/kn;
    }
    a=t;
  }
  const blur=Uint8ClampedArray.from(a);
  // sobel
  const mag=new Float32Array(wh); let mx=1;
  for(let y=1;y<h-1;y++) for(let x=1;x<w-1;x++){
    const i=y*w+x;
    const gx=-blur[i-w-1]-2*blur[i-1]-blur[i+w-1] + blur[i-w+1]+2*blur[i+1]+blur[i+w+1];
    const gy=-blur[i-w-1]-2*blur[i-w]-blur[i-w+1] + blur[i+w-1]+2*blur[i+w]+blur[i+w+1];
    const m=Math.hypot(gx,gy); mag[i]=m; if(m>mx) mx=m;
  }
  const T=edgeVal*mx, bin=new Uint8ClampedArray(wh);
  for(let i=0;i<wh;i++) bin[i]=mag[i]>T?1:0;
  // skeletonize (Zhang‚ÄìSuen)
  const sk=Uint8Array.from(bin);
  const N=(x,y)=> sk[(y-1)*w+x]+sk[(y-1)*w+x+1]+sk[y*w+x+1]+sk[(y+1)*w+x+1]+sk[(y+1)*w+x]+sk[(y+1)*w+x-1]+sk[y*w+x-1]+sk[(y-1)*w+x-1];
  const S=(x,y)=>{ const p=[sk[(y-1)*w+x],sk[(y-1)*w+x+1],sk[y*w+x+1],sk[(y+1)*w+x+1],sk[(y+1)*w+x],sk[(y+1)*w+x-1],sk[y*w+x-1],sk[(y-1)*w+x-1]]; let t=0; for(let i=0;i<8;i++) if(p[i]==0&&p[(i+1)%8]==1) t++; return t; };
  let changed=true, pass=0;
  while(changed && pass<20){
    changed=false; let rem=[];
    for(let y=1;y<h-1;y++) for(let x=1;x<w-1;x++){
      const i=y*w+x; if(!sk[i]) continue; const nn=N(x,y), s=S(x,y);
      if(nn>=2&&nn<=6&&s==1 && (sk[(y-1)*w+x]*sk[y*w+x+1]*sk[(y+1)*w+x]==0) && (sk[y*w+x+1]*sk[y*w+x-1]*sk[(y-1)*w+x]==0)) rem.push(i);
    }
    rem.forEach(i=>sk[i]=0); if(rem.length) changed=true; rem=[];
    for(let y=1;y<h-1;y++) for(let x=1;x<w-1;x++){
      const i=y*w+x; if(!sk[i]) continue; const nn=N(x,y), s=S(x,y);
      if(nn>=2&&nn<=6&&s==1 && (sk[(y-1)*w+x]*sk[y*w+x-1]*sk[(y+1)*w+x]==0) && (sk[(y-1)*w+x]*sk[y*w+x+1]*sk[y*w+x-1]==0)) rem.push(i);
    }
    rem.forEach(i=>sk[i]=0); if(rem.length) changed=true; pass++;
  }

  // region helpers
  const band=(y0,y1)=>{ const m=new Uint8Array(wh); for(let y=y0;y<y1;y++) for(let x=0;x<w;x++) m[y*w+x]=1; return m; };
  const rect=(x0,y0,x1,y1)=>{ const m=new Uint8Array(wh); for(let y=y0;y<y1;y++) for(let x=x0;x<x1;x++) m[y*w+x]=1; return m; };
  const pickLongest=(mask)=>{ const seen=new Uint8Array(wh); const NB=[-1-w,-w,1-w,-1,1,-1+w,w,1+w]; let best=[];
    function walk(i0){ const st=[i0], pts=[]; seen[i0]=1; while(st.length){ const i=st.pop(); const y=(i/w)|0, x=i%w; pts.push([x,y]);
      for(const d8 of NB){ const j=i+d8; if(j>0&&j<wh && mask[j] && sk[j] && !seen[j]){ seen[j]=1; st.push(j);} } } return pts; }
    for(let y=1;y<h-1;y++) for(let x=1;x<w-1;x++){ const i=y*w+x; if(mask[i]&&sk[i]&&!seen[i]){ const p=walk(i); if(p.length>best.length) best=p; } }
    return best;
  };
  const pickTopK=(mask,K=3,minLen=30,maxLen=140,preferHorizontal=true)=>{
    const seen=new Uint8Array(wh); const NB=[-1-w,-w,1-w,-1,1,-1+w,w,1+w]; const segs=[];
    function walk(i0){ const st=[i0], pts=[]; seen[i0]=1; while(st.length){ const i=st.pop(); const y=(i/w)|0, x=i%w; pts.push([x,y]); for(const d8 of NB){ const j=i+d8; if(j>0&&j<wh&&mask[j]&&sk[j]&&!seen[j]){ seen[j]=1; st.push(j);} } } return pts; }
    const polyLen=(p)=>{ let L=0; for(let i=1;i<p.length;i++){ const dx=p[i][0]-p[i-1][0], dy=p[i][1]-p[i-1][1]; L+=Math.hypot(dx,dy);} return L; };
    const orient=(p)=>{ if(p.length<2) return 0; const A=p[0],B=p[p.length-1]; return Math.atan2(B[1]-A[1],B[0]-A[0]); };
    for(let y=1;y<h-1;y++) for(let x=1;x<w-1;x++){
      const i=y*w+x; if(mask[i]&&sk[i]&&!seen[i]){ const p=walk(i); const L=polyLen(p);
        if(L>=minLen && L<=maxLen){ let ok=true; if(preferHorizontal){ const ang=Math.abs(orient(p)*180/Math.PI); ok=(ang<25||ang>155); }
          if(ok) segs.push(p);
        }
      }
    }
    segs.sort((a,b)=>polyLen(b)-polyLen(a)); return segs.slice(0,K);
  };

  // bands (rough zoning)
  const yHeart0=0, yHeart1=Math.floor(h*0.30);
  const yHead0=yHeart1, yHead1=Math.floor(h*0.55);
  const yLife0=yHead1, yLife1=h;

  // pick paths
  const pHeart = pickLongest(band(yHeart0,yHeart1));
  const pHead  = pickLongest(band(yHead0,yHead1));
  const pLife  = pickLongest(band(yLife0,yLife1));

  const pFate  = pickLongest(rect(Math.floor(w*0.40), Math.floor(h*0.35), Math.floor(w*0.60), h));
  const pSun   = pickLongest(rect(Math.floor(w*0.60), Math.floor(h*0.40), Math.floor(w*0.80), h));
  const pMarriage = pickTopK(rect(Math.floor(w*0.70), Math.floor(h*0.10), w, Math.floor(h*0.25)), 3, 40, 120, true);
  const pHealth= pickLongest(rect(Math.floor(w*0.55), Math.floor(h*0.55), w, h));

  // faint cyan edges
  const overlay = ctx.createImageData(w,h);
  for(let i=0,j=0;i<wh;i++,j+=4) if(bin[i]){ overlay.data[j]=0; overlay.data[j+1]=255; overlay.data[j+2]=255; overlay.data[j+3]=60; }
  ctx.putImageData(overlay,0,0);

  // draw
  function drawPath(pts,color,wid){
    if(!pts||pts.length<5) return;
    ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.strokeStyle='#000'; ctx.lineWidth=wid+2;
    ctx.beginPath(); ctx.moveTo(pts[0][0],pts[0][1]); for(const [x,y] of pts) ctx.lineTo(x,y); ctx.stroke();
    ctx.strokeStyle=color; ctx.lineWidth=wid;
    ctx.beginPath(); ctx.moveTo(pts[0][0],pts[0][1]); for(const [x,y] of pts) ctx.lineTo(x,y); ctx.stroke();
  }
  const M=(p)=>{ const polyLen=(pp)=>{ let L=0; for(let i=1;i<pp.length;i++){const dx=pp[i][0]-pp[i-1][0],dy=pp[i][1]-pp[i-1][1]; L+=Math.hypot(dx,dy);} return L|0; };
    const orient=(pp)=>{ if(pp.length<2) return 0; const A=pp[0],B=pp[pp.length-1]; return Math.atan2(B[1]-A[1],B[0]-A[0]); };
    const gaps=(pp)=>{ let g=0; for(let i=2;i<pp.length;i++) if(Math.hypot(pp[i][0]-pp[i-1][0],pp[i][1]-pp[i-1][1])>6) g++; return g; };
    return {len:polyLen(p), slope:orient(p), gaps:gaps(p)}; };

  ctx.globalAlpha=0.95;
  if(T_primary.checked){ drawPath(pHeart,'#ff3b3b',4); drawPath(pHead,'#ffa533',4); drawPath(pLife,'#42ff6c',4); }
  if(T_fate.checked)   drawPath(pFate,'#a1a1ff',3.5);
  if(T_sun.checked)    drawPath(pSun,'#ffd54a',3.5);
  if(T_marriage.checked)   pMarriage.forEach(p=>drawPath(p,'#ff8ab0',3));
  if(T_health.checked) drawPath(pHealth,'#5ad1ff',3.5);
  ctx.globalAlpha=1; cv.style.display='block';

  last = { heart:M(pHeart), head:M(pHead), life:M(pLife),
           fate:M(pFate), sun:M(pSun), marriage:pMarriage.map(M), health:M(pHealth) };
  lastOverlay = cv.toDataURL('image/png');

  showSummary(buildSummaryTable(last));
  msg('‚ú® Analyze done');
}

/* ---------------- summaries ---------------- */
function grade(L,G){ const n = (L<80)?'weak':(G>15)?'fragmented':(L>220)?'strong':'moderate'; return I18N[LANG].grades[n]||n; }
function ori(r){ const d=r*180/Math.PI; const k = d<-25?'up': d>25?'down':'level'; return I18N[LANG].orient[k]||k; }
function lineRow(name,m){ if(!m||!m.len) return `${name}: <i>n/a</i>`; return `${name}: <b>${grade(m.len,m.gaps)}</b> (${ori(m.slope)}), ~${m.len}, gaps ${m.gaps}.`; }
function buildSummaryTable(m){
  const L=I18N[LANG].lines;
  const pri = `‚ù§Ô∏è ${lineRow(L.heart,m.heart)}<br>üß° ${lineRow(L.head,m.head)}<br>üíö ${lineRow(L.life,m.life)}`;
  const sec = `üü™ ${lineRow(L.fate,m.fate)}<br>üü® ${lineRow(L.sun,m.sun)}<br>ü©∑ ${m.marriage&&m.marriage.length? m.marriage.map((x,i)=>'#'+(i+1)+'~'+x.len).join(', ') : 'n/a'}<br>ü©µ ${lineRow(L.health,m.health)}`;
  return `<p>${pri}</p><hr/><p>${sec}</p>`;
}
function buildDetailedReading(m){
  const L=I18N[LANG].lines, M=I18N[LANG].meanings, R=I18N[LANG].report;
  const text=(label,mm,strong,weak)=>{ if(!mm||!mm.len) return `<p><b>${label}:</b> n/a</p>`;
    const g=grade(mm.len,mm.gaps), o=ori(mm.slope); const meaning = (g===I18N[LANG].grades.strong||g===I18N[LANG].grades.moderate)?strong:weak;
    return `<p><b>${label}:</b> <i>${g}</i> (${o}). ${meaning}</p>`;
  };
  return `
    <h3>${R.detailed}</h3>
    ${text(L.heart,m.heart,M.heartStrong,M.heartWeak)}
    ${text(L.head,m.head,M.headStrong,M.headWeak)}
    ${text(L.life,m.life,M.lifeStrong,M.lifeWeak)}
    ${text(L.fate,m.fate,M.fateStrong,M.fateWeak)}
    ${text(L.sun,m.sun,M.sunStrong,M.sunWeak)}
    <p><b>${L.marriage}:</b> ${m.marriage&&m.marriage.length? m.marriage.map((x,i)=>`#${i+1} ~ ${x.len}px`).join(', ') : 'n/a'}</p>
    ${text(L.health,m.health,M.healthStrong,M.healthWeak)}
    <hr/><div class="muted">${R.notes}</div>
  `;
}

/* ---------------- on load ---------------- */
window.addEventListener('load',()=>{
  applyI18n();
  msg(tpath('msg.start_hint'));
});
</script>
</body>
</html>
