<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Palmistry – HARD LOCK Capture</title>
<style>
:root{--pri:#16f0a7;--bg:#0b0f16;--neon:#00e5ff}
*{box-sizing:border-box} body{margin:0;background:#0b0f16;color:#e6f0ff;font-family:system-ui}
.wrap{max-width:480px;margin:18px auto;padding:12px}
h1{margin:6px 0 10px}
.card{position:relative;border:2px solid var(--pri);border-radius:16px;overflow:hidden;background:#000}
video,canvas{display:block;width:100%;height:auto}
#base{display:none} .overlay{position:absolute;inset:0;pointer-events:none;opacity:.72}
.bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0 6px}
button{border:none;border-radius:999px;padding:10px 14px;font-weight:700}
.btn{background:var(--neon);color:#000} .sec{background:#1f2937;color:#e6f0ff;border:1px solid #3b82f6}
.ghost{background:transparent;color:#e6f0ff;border:1px dashed #64748b}
.badge{display:inline-block;background:#0f172a;border:1px solid #334155;padding:6px 10px;border-radius:999px}
.mono{font-family:ui-monospace,monospace}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #ef4444;
       color:#fff;padding:8px 12px;border-radius:10px;display:none;z-index:9999}
footer{opacity:.8;text-align:center;margin:10px 0 24px}
.row{display:flex;gap:8px;align-items:center;justify-content:center}
.range{width:150px;accent-color:#3b82f6}
</style>
</head>
<body>
<div class="wrap">
  <h1>Palmistry – Capture • **LOCK** • Analyze</h1>

  <div id="status" class="badge">Opening camera…</div>

  <div class="card">
    <video id="vid" playsinline autoplay muted></video>
    <canvas id="base"></canvas>
    <canvas id="out" class="overlay"></canvas>
  </div>

  <div class="bar">
    <button id="btnCap" class="btn">Capture (Lock)</button>
    <button id="btnAna" class="sec">Analyze</button>
    <button id="btnRet" class="ghost">Retake (Unlock)</button>
  </div>

  <div class="bar">
    <small>Threshold</small>
    <input id="thr" class="range" type="range" min="10" max="80" step="2" value="34"/>
    <small id="thrVal" class="mono">34</small>
  </div>

  <div id="summary" class="badge">AI Summary: —</div>
  <footer><small>© Sathyadarshana · Research build · Works offline</small></footer>
</div>
<div id="toast" class="toast"></div>

<script>
const $=q=>document.querySelector(q);
const vid=$('#vid'), base=$('#base'), out=$('#out');
const btnCap=$('#btnCap'), btnAna=$('#btnAna'), btnRet=$('#btnRet');
const thr=$('#thr'), thrVal=$('#thrVal');
const statusEl=$('#status'), sumEl=$('#summary'), toast=$('.toast');

let stream=null, locked=false;

function say(t){ statusEl.textContent=t; }
function oops(e){ toast.textContent=e; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2200); }

async function openCam(){
  try{
    // reopen fresh stream
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject = stream;
    await vid.play();
    await new Promise(r=>vid.onloadedmetadata=r);
    const w=vid.videoWidth, h=vid.videoHeight;
    [base,out].forEach(c=>{ c.width=w; c.height=h; });
    vid.style.display='block'; base.style.display='none';
    locked=false; say('Ready. Opened camera…');
  }catch(err){ oops('Camera error: '+err.message); say('Camera failed'); }
}

function hardLock(){
  // STOP all tracks so device truly freezes (no background updates)
  try{ stream?.getTracks().forEach(t=>t.stop()); }catch{}
  vid.pause();
  vid.srcObject=null;
}

btnCap.addEventListener('click', ()=>{
  try{
    const w=vid.videoWidth, h=vid.videoHeight;
    if(!w||!h){ oops('Video not ready'); return; }
    // draw current frame -> base canvas
    const ctx=base.getContext('2d',{willReadFrequently:true});
    ctx.drawImage(vid,0,0,w,h);
    // HARD LOCK: stop camera tracks + hide video
    hardLock();
    vid.style.display='none';
    base.style.display='block';
    out.getContext('2d').clearRect(0,0,out.width,out.height);
    locked=true;
    sumEl.textContent='AI Summary: Captured frame (LOCKED).';
    say('Locked photo. You can Analyze or Retake.');
  }catch(err){ oops('Capture failed: '+err.message); }
});

btnRet.addEventListener('click', async ()=>{
  try{
    await openCam(); // unlock = reopen camera
    out.getContext('2d').clearRect(0,0,out.width,out.height);
    sumEl.textContent='AI Summary: —';
  }catch(err){ oops('Retake failed: '+err.message); }
});

btnAna.addEventListener('click', ()=>{
  if(!locked){ oops('Not locked yet. Tap Capture first.'); return; }
  try{
    const t0=performance.now();
    const w=base.width, h=base.height;
    const bctx=base.getContext('2d',{willReadFrequently:true});
    const img=bctx.getImageData(0,0,w,h);
    // grayscale
    const data=img.data, gray=new Uint8ClampedArray(w*h);
    for(let i=0,j=0;i<data.length;i+=4,j++){ const r=data[i],g=data[i+1],b=data[i+2]; gray[j]=(r*0.299+g*0.587+b*0.114)|0; }
    // high-pass
    const hp=new Uint8ClampedArray(w*h);
    for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ const i=y*w+x; const c=gray[i]*5-(gray[i-1]+gray[i+1]+gray[i-w]+gray[i+w]); hp[i]=Math.max(0,Math.min(255,c+128)); } }
    const T=Number(thr.value); thrVal.textContent=T;
    const mask=new Uint8ClampedArray(w*h); let px=0;
    for(let i=0;i<mask.length;i++){ const v = hp[i]>(128+T)?255:0; mask[i]=v; if(v) px++; }
    const octx=out.getContext('2d'), overlay=octx.createImageData(w,h);
    for(let i=0,j=0;i<overlay.data.length;i+=4,j++){
      if(mask[j]){ overlay.data[i]=0; overlay.data[i+1]=255; overlay.data[i+2]=180; overlay.data[i+3]=190; }
    }
    octx.putImageData(overlay,0,0);
    const ms=(performance.now()-t0).toFixed(1);
    say(`Analyze completed (overlay ${px.toLocaleString()}px).`);
    sumEl.textContent=`AI Summary: Lines highlighted · ${w}×${h} · ${ms} ms · Thr=${T}`;
  }catch(err){ oops('Analyze failed: '+err.message); say('Analyze failed'); }
});

thr.addEventListener('input', ()=>{ thrVal.textContent=thr.value; if(locked) btnAna.click(); });

// Start
openCam();
</script>
</body>
</html>
