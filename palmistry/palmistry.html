<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Palmistry â€“ AI Overlay (Auto-Label)</title>
<style>
:root{--pri:#16f0a7;--sec:#38bdf8}
body{margin:0;background:#0b0f16;color:#e6f0ff;font-family:system-ui,Segoe UI,Inter,Arial,sans-serif;text-align:center}
h1{margin:16px 0 8px}
.wrap{display:inline-block;position:relative;margin:10px auto}
video,canvas{width:92vw;max-width:420px;border-radius:16px;border:2px solid var(--pri);display:block;background:#0e1625}
.ghost{position:absolute;inset:0;width:100%;height:100%;opacity:.25;pointer-events:none}
.btns{margin:12px 0 14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
button{border:none;border-radius:10px;padding:.6em 1.1em;font-weight:700;cursor:pointer}
.flip{background:#16243a;color:#cfe9ff}
.cap{background:var(--sec);color:#07121f}
.an{background:var(--pri);color:#07121f}
.save{background:#fbbf24;color:#111827}
.torch{background:#22c55e;color:#052e16}
.chip{background:#0f172a;border:1px solid #1f2c48;border-radius:999px;padding:.25em .6em}
.sl{width:180px}
.hint{color:#a6c8ff;margin:8px 0}
.badge{position:absolute;left:8px;top:8px;padding:.25rem .45rem;border-radius:8px;font-size:.75rem;background:#0008}
footer{color:var(--pri);margin:18px 0 22px;font-size:.95em}
.legend{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:6px}
.legend span{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;background:#0f172a;border:1px solid #1f2c48;border-radius:999px;padding:.2em .6em}
.dot{width:12px;height:12px;border-radius:999px;display:inline-block}
.lang{display:flex;gap:8px;justify-content:center;align-items:center;margin:6px auto 0}
select{background:#0f172a;color:#e6f0ff;border:1px solid #1f2c48;border-radius:10px;padding:.4em .6em}
</style>

<!-- OpenCV.js (primary + fallback) -->
<script>
(function(){
  const s=document.createElement('script');
  s.src="https://docs.opencv.org/4.x/opencv.js";
  s.async=true;
  s.onerror=()=>{
    const f=document.createElement('script');
    f.src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.9.0-1/opencv.min.js";
    f.async=true; document.head.appendChild(f);
  };
  document.head.appendChild(s);
})();
</script>
</head>
<body>
<h1 data-i18n="title">ğŸ–ï¸ Palmistry â€“ AI Overlay</h1>

<div class="wrap">
  <!-- no autoplay (mobile may block) -->
  <video id="cam" playsinline></video>
  <img class="ghost" src="https://i.ibb.co/1K7K0gF/palm-overlay-demo.png" alt="overlay"
       onerror="this.style.display='none'">
  <canvas id="cv"></canvas>
  <span id="status" class="badge" data-i18n="loading">loading OpenCVâ€¦</span>
</div>

<div class="legend">
  <span><i class="dot" style="background:#ff6b6b"></i><span data-i18n="heart">Heart</span></span>
  <span><i class="dot" style="background:#ffd166"></i><span data-i18n="head">Head</span></span>
  <span><i class="dot" style="background:#06d6a0"></i><span data-i18n="life">Life</span></span>
  <span><i class="dot" style="background:#118ab2"></i><span data-i18n="fate">Fate</span></span>
  <span><i class="dot" style="background:#ef476f"></i><span data-i18n="marriage">Marriage</span></span>
  <span><i class="dot" style="background:#00e5ff"></i><span data-i18n="sun">Sun</span></span>
</div>

<div class="lang">
  <label for="langSel" data-i18n="langLabel">Language:</label>
  <select id="langSel" aria-label="Language">
    <option value="en">English</option>
    <option value="si">à·ƒà·’à¶‚à·„à¶½ (Sinhala)</option>
    <!-- Add more languages here by extending the i18n map -->
  </select>
</div>

<p class="hint" data-i18n="hint">
Align your palm with the overlay, then <b>Capture</b> â†’ <b>Analyze</b>. Use a dark cloth/paper behind the hand for best contrast.
</p>

<div class="btns">
  <button class="flip"  id="flipBtn"  data-i18n="flip">â†”ï¸ Flip</button>
  <button class="cap"   id="capBtn"   data-i18n="capture">ğŸ“¸ Capture</button>
  <button class="an"    id="anBtn" disabled data-i18n="analyze">âœ¨ Analyze</button>
  <button class="save"  id="saveBtn" disabled data-i18n="save">ğŸ’¾ Save PNG</button>
  <button class="torch" id="torchBtn" hidden data-i18n="torch">ğŸ”¦ Torch</button>
</div>

<div class="btns" style="margin-top:-6px">
  <span class="chip"><span data-i18n="edge">Edge</span>:
    <input id="th1" class="sl" type="range" min="20" max="120" value="60">
    <small id="th1v">60</small></span>
  <span class="chip"><span data-i18n="detail">Detail</span>:
    <input id="gk" class="sl" type="range" min="7" max="23" step="2" value="15">
    <small id="gkv">15</small></span>
</div>

<footer>
  Â© 2025 Lebaretion Â· Sathyadarshana â€” <span data-i18n="footer">One world family through spiritual unity. Add any language via the translator below.</span>
</footer>

<script>
/* ===================== i18n (extend freely) ===================== */
const i18n = {
  en: {
    title: "ğŸ–ï¸ Palmistry â€“ AI Overlay",
    loading: "loading OpenCVâ€¦",
    heart: "Heart", head: "Head", life: "Life", fate: "Fate", marriage: "Marriage", sun: "Sun",
    langLabel: "Language:",
    hint: "Align your palm with the overlay, then <b>Capture</b> â†’ <b>Analyze</b>. Use a dark cloth/paper behind the hand for best contrast.",
    flip: "â†”ï¸ Flip", capture: "ğŸ“¸ Capture", analyze: "âœ¨ Analyze", save: "ğŸ’¾ Save PNG", torch:"ğŸ”¦ Torch",
    edge: "Edge", detail: "Detail",
    footer: "One world family through spiritual unity. Add any language via the translator below.",
    camBlocked: "Camera blocked: ",
    notReady: "Video not ready",
    mustCapture: "Capture first",
    cvNotLoaded: "OpenCV not loaded",
    torchNotSupported: "Torch not supported on this device",
    ready: "OpenCV ready"
  },
  si: {
    title:"ğŸ–ï¸ à¶…à¶­ à¶»à·šà¶›à· â€“ AI Overlay",
    loading:"OpenCV à¶½à·à¶©à·Š à·€à·™à¶¸à·’à¶±à·Šâ€¦",
    heart:"Heart", head:"Head", life:"Life", fate:"Fate", marriage:"Marriage", sun:"Sun",
    langLabel:"à¶·à·à·‚à·à·€:",
    hint:"à¶…à¶­ overlay à¶‘à¶šà¶§ à·„à·œà¶³à¶§ align à¶šà¶»à¶½à· <b>Capture</b> â†’ <b>Analyze</b> à¶šà¶»à¶±à·Šà¶±. à¶…à¶­ à¶´à·ƒà·”à¶´à·ƒà¶§ à¶…à¶³à·”à¶»à·” à¶»à·™à¶¯à·’/à¶šà¶©à¶¯à·à·ƒà·’ à¶¯à·à¶±à·Šà¶±.",
    flip:"â†”ï¸ Flip", capture:"ğŸ“¸ Capture", analyze:"âœ¨ Analyze", save:"ğŸ’¾ Save PNG", torch:"ğŸ”¦ Torch",
    edge:"Edge", detail:"Detail",
    footer:"à·ƒà·’à¶ºà·…à·” à¶¢à·à¶­à·“à¶±à·Š à¶‘à¶šà¶¸à·”à¶­à·”à·€ à¶†à¶­à·Šà¶¸à·’à¶š à·€à·“à¶¸ â€” à¶´à·„à·… i18n à¶­à·”à·… à¶”à¶¶à¶§ à¶‰à·ƒà·Šà·ƒà¶»à·„à¶§ à¶·à·à·‚à· à¶‘à¶šà¶­à·” à¶šà·… à·„à·à¶š.",
    camBlocked:"à¶šà·à¶¸à¶»à· à¶…à·„à·’à¶¸à·’: ",
    notReady:"à·€à·’à¶©à·’à¶ºà· à·ƒà·–à¶¯à·à¶±à¶¸à·Š à¶±à·à·„à·",
    mustCapture:"à¶´à¶½à¶¸à·”à·€ Capture à¶šà¶»à¶±à·Šà¶±",
    cvNotLoaded:"OpenCV load à·€à·“ à¶±à·‘",
    torchNotSupported:"à¶¸à·™à¶¸ à¶‹à¶´à·à¶‚à¶œà¶ºà·š Torch à¶±à·à·„à·",
    ready:"OpenCV à·ƒà·–à¶¯à·à¶±à¶¸à·Š"
  }
};
const $t = key => (i18n[window.appLang] && i18n[window.appLang][key]) || i18n.en[key] || key;
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n");
    el.innerHTML = $t(k);
  });
}
window.appLang = (navigator.language||"en").slice(0,2) in i18n ? (navigator.language||"en").slice(0,2) : "en";
document.getElementById("langSel").value = window.appLang;
document.getElementById("langSel").addEventListener("change", e=>{
  window.appLang = e.target.value;
  applyI18n();
});
applyI18n();
/* =============================================================== */

const video=document.getElementById('cam');
const canvas=document.getElementById('cv');
const ctx=canvas.getContext('2d');
const statusEl=document.getElementById('status');
const capBtn=document.getElementById('capBtn');
const flipBtn=document.getElementById('flipBtn');
const anBtn=document.getElementById('anBtn');
const saveBtn=document.getElementById('saveBtn');
const torchBtn=document.getElementById('torchBtn');
const th1El=document.getElementById('th1'), th1v=document.getElementById('th1v');
const gkEl=document.getElementById('gk'), gkv=document.getElementById('gkv');

let flipped=false, captured=false, stream=null, track=null, torchOn=false;

function fit(){const w=Math.min(420, Math.floor(innerWidth*0.92)); const h=Math.floor(w*4/3); canvas.width=w; canvas.height=h;}
addEventListener('resize',fit,{passive:true}); fit();

flipBtn.onclick=()=>{flipped=!flipped; video.style.transform=flipped?'scaleX(-1)':'none';};
th1El.oninput=()=>th1v.textContent=th1El.value;
gkEl.oninput =()=>gkv.textContent=gkEl.value;

/* ---------- Start camera only on first Capture ---------- */
async function ensureCamera(){
  if(stream) return;
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ideal:'environment'},
        width:{ideal:3840}, height:{ideal:2160},   // request 4K if available
        frameRate:{ideal:15, max:30},
        focusMode:"continuous"
      },
      audio:false
    });
    video.srcObject=stream; await video.play();
    track=stream.getVideoTracks()[0];
    const caps=track.getCapabilities?.();
    if(caps && caps.torch){ torchBtn.hidden=false; }
  }catch(e){
    alert($t("camBlocked")+e.message);
  }
}

torchBtn.onclick=async()=>{
  if(!track) return;
  try{
    torchOn=!torchOn;
    await track.applyConstraints({advanced:[{torch:torchOn}]});
    torchBtn.textContent = torchOn ? "ğŸ”¦ Torch (ON)" : $t("torch");
  }catch(e){ alert($t("torchNotSupported")); }
};

capBtn.onclick=async()=>{
  await ensureCamera();
  if(!video.videoWidth){ alert($t("notReady")); return; }
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  ctx.save(); if(flipped){ctx.translate(canvas.width,0); ctx.scale(-1,1);}
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  ctx.restore();
  captured=true; saveBtn.disabled=false; anBtn.disabled=false;
};

saveBtn.onclick=()=>{
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='palm_'+Date.now()+'.png';
  a.click();
};

// OpenCV readiness
(function waitCV(){
  const ok=()=>{statusEl.textContent=$t("ready");};
  const poll=()=> (window.cv && cv.Mat)? ok() : setTimeout(poll,200);
  if(window.cv && cv.onRuntimeInitialized!==undefined){cv.onRuntimeInitialized=ok; poll();}
  else {poll();}
})();

/* ------------------ Analyze (enhance + overlay) ------------------ */
anBtn.onclick=()=>{
  if(!captured){ alert($t("mustCapture")); return; }
  if(!window.cv||!cv.Mat){ alert($t("cvNotLoaded")); return; }
  analyze();
};

function analyze(){
  const src=cv.imread(canvas);

  // grayscale + CLAHE
  const gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  const clahe=new cv.CLAHE(2.0,new cv.Size(8,8)); clahe.apply(gray,gray);

  // Gabor multi-orientation
  const ksize=(+gkEl.value)|0, sigma=4.0, lambd=10.0, gamma=0.5, psi=0;
  const degs=[0,20,40,60,80,100,120,140];
  const gSum=new cv.Mat.zeros(gray.rows,gray.cols,cv.CV_32F), resp=new cv.Mat();
  for(const d of degs){
    const th=d*Math.PI/180;
    const ker=cv.getGaborKernel(new cv.Size(ksize,ksize),sigma,th,lambd,gamma,psi,cv.CV_32F);
    cv.filter2D(gray,resp,cv.CV_32F,ker); cv.max(gSum,resp,gSum); ker.delete();
  }
  const g8=new cv.Mat(); cv.normalize(gSum,gSum,0,255,cv.NORM_MINMAX); gSum.convertTo(g8,cv.CV_8U);

  // local threshold + clean
  const bin=new cv.Mat();
  cv.adaptiveThreshold(g8,bin,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY,21,-(+(th1El.value)));
  const k3=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(3,3));
  cv.morphologyEx(bin,bin,cv.MORPH_OPEN,k3); cv.dilate(bin,bin,k3);

  // skeletonize
  const skel=skeletonize(bin);

  // colorize + overlay
  const rgba=new cv.Mat(); cv.cvtColor(skel,rgba,cv.COLOR_GRAY2RGBA);
  const tint=new cv.Mat(rgba.rows,rgba.cols,rgba.type(),[0,255,255,255]);
  cv.bitwise_and(tint,rgba,rgba);
  const out=new cv.Mat(); cv.addWeighted(src,1.0,rgba,1.0,0,out);
  cv.imshow(canvas,out);

  // cleanup
  [gray,clahe,gSum,g8,bin,k3,skel,rgba,tint,out,resp,src].forEach(m=>m.delete());
}

// morphological thinning (skeleton)
function skeletonize(bin){
  const el=cv.getStructuringElement(cv.MORPH_CROSS,new cv.Size(3,3));
  const sk=cv.Mat.zeros(bin.rows,bin.cols,cv.CV_8U), tmp=new cv.Mat(), er=new cv.Mat();
  while(true){
    cv.erode(bin,er,el); cv.dilate(er,tmp,el);
    cv.subtract(bin,tmp,tmp); cv.bitwise_or(sk,tmp,sk);
    er.copyTo(bin); if(cv.countNonZero(bin)===0) break;
  }
  tmp.delete(); er.delete(); el.delete(); return sk;
}
</script>
</body>
</html>
