<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palmistry AI Overlay ‚Äì Sathyadarshana</title>
<style>
:root{
  --pri:#16f0a7;--sec:#38bdf8;--bg:#0b0f16;--dim:0.8
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e6f0ff;font-family:system-ui,Segoe UI,Inter,Arial,sans-serif;text-align:center;overflow:auto}
h1{margin:16px 0 8px}
.wrap{display:inline-block;position:relative;margin:10px auto}
video,canvas{width:92vw;max-width:420px;border-radius:16px;border:2px solid var(--pri);display:block;background:#0e1625}
.badge{position:absolute;left:8px;top:8px;padding:.25rem .45rem;border-radius:8px;font-size:.75rem;background:#0008}
.captureBtn{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:#2196f3;border:none;border-radius:50%;
  width:90px;height:90px;display:flex;align-items:center;justify-content:center;
  color:#000;font-weight:600;cursor:pointer;font-size:.9rem;box-shadow:0 0 15px #2196f333;
}
.captureBtn:active{transform:translateX(-50%) scale(.95)}
.overlay{position:absolute;inset:0;pointer-events:none;opacity:.7}
.mask-dim{fill:rgba(0,0,0,var(--dim))}
.path-fat{fill:none;stroke:#00e5ff;stroke-width:4}
.path-glow{fill:none;stroke:#00e5ff;stroke-width:2;filter:drop-shadow(0 0 6px #00f5ff66)}
.btns{margin:12px 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
button{border:none;border-radius:10px;padding:.6em 1.1em;font-weight:700;cursor:pointer}
.left{background:#16243a;color:#cfe9ff}
.cap{background:#fbbf24;color:#111827}
.an{background:var(--pri);color:#07121f}
.torch{background:#22c55e;color:#052e16}
.sliderRow{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:10px}
label{font-size:.9em}
footer{color:var(--pri);margin:18px 0 22px;font-size:.9em}
</style>
<script>
(function(){
 const s=document.createElement('script');
 s.src="https://docs.opencv.org/4.x/opencv.js"; s.async=true;
 s.onerror=()=>{const f=document.createElement('script');
 f.src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.9.0-1/opencv.min.js";
 f.async=true;document.head.appendChild(f);};
 document.head.appendChild(s);
})();
</script>
</head>
<body>
<h1>üñêÔ∏è Palmistry</h1>
<p>Left = Past ¬∑ Right = Present ‚Äî align hand in block ‚Üí Capture ‚Üí Analyze</p>

<div class="wrap">
  <video id="cam" playsinline></video>
  <canvas id="cv"></canvas>
  <span id="cvStatus" class="badge">loading OpenCV...</span>

  <!-- Overlay realistic hand block -->
  <svg class="overlay" viewBox="0 0 420 560" preserveAspectRatio="xMidYMid slice" id="overlay">
    <defs>
      <path id="handSil"
        d="M142,455C120,418 113,365 130,330C130,285 138,230 160,220C179,212 192,246 195,298
        C196,258 212,215 232,214C251,214 258,254 254,304C261,258 281,220 301,224C318,228 322,275 314,320
        C321,282 344,256 359,266C372,276 372,316 360,360C386,396 396,451 373,492C350,531 300,548 232,546
        C172,545 152,523 142,455Z"/>
      <mask id="handMask">
        <rect width="420" height="560" fill="white"/>
        <use href="#handSil" fill="black"/>
      </mask>
    </defs>
    <rect class="mask-dim" width="420" height="560" mask="url(#handMask)"/>
    <use href="#handSil" class="path-fat"/>
    <use href="#handSil" class="path-glow"/>
    <g stroke="#00e5ff" stroke-width="2" opacity=".18">
      <circle cx="210" cy="320" r="30" fill="none"/>
      <line x1="180" y1="320" x2="240" y2="320"/>
      <line x1="210" y1="290" x2="210" y2="350"/>
    </g>
    <text x="210" y="520" fill="#7de9ff" text-anchor="middle" style="font:16px system-ui">
      Place palm inside the block
    </text>
  </svg>

  <button class="captureBtn" id="capBtn">Tap to Capture</button>
</div>

<div class="btns">
  <button class="left" id="flipBtn">üñê Left ¬∑ Past</button>
  <button class="torch" id="torchBtn" hidden>üî¶ Torch</button>
  <button class="an" id="anBtn">‚ú® Analyze</button>
  <button class="cap" id="saveBtn">üíæ Save PNG</button>
</div>

<div class="sliderRow">
  <label>Edge <input id="edge" type="range" min="20" max="120" value="70"/></label>
  <label>Detail <input id="gk" type="range" min="7" max="23" step="2" value="15"/></label>
</div>

<footer>¬© 2025 Sathyadarshana ¬∑ Palmistry AI Overlay</footer>

<script>
const video=document.getElementById('cam'),canvas=document.getElementById('cv'),ctx=canvas.getContext('2d');
const stat=document.getElementById('cvStatus');
const flipBtn=document.getElementById('flipBtn'),capBtn=document.getElementById('capBtn'),anBtn=document.getElementById('anBtn');
const saveBtn=document.getElementById('saveBtn'),torchBtn=document.getElementById('torchBtn');
const edge=document.getElementById('edge'),gk=document.getElementById('gk');
let flipped=false,captured=false,stream=null,track=null,torch=false;

flipBtn.onclick=()=>{flipped=!flipped;document.getElementById('overlay').style.transform=flipped?'scaleX(-1)':'none';};

async function ensureCamera(){
  if(stream) return;
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720},frameRate:{ideal:15,max:30}},
      audio:false});
    video.srcObject=stream; await video.play();
    track=stream.getVideoTracks()[0];
    const caps=track.getCapabilities?.(); if(caps && caps.torch) torchBtn.hidden=false;
    stat.textContent='Camera live';
  }catch(e){ alert('Camera error: '+e.message); }
}

torchBtn.onclick=async()=>{if(!track)return;
 try{torch=!torch;await track.applyConstraints({advanced:[{torch}]});
 torchBtn.textContent=torch?'üî¶ Torch (ON)':'üî¶ Torch';}catch{alert('Torch not supported');}};

capBtn.onclick=async()=>{
  await ensureCamera();
  if(!video.videoWidth){alert('Video not ready');return;}
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  ctx.save(); if(flipped){ctx.translate(canvas.width,0);ctx.scale(-1,1);} ctx.drawImage(video,0,0,canvas.width,canvas.height); ctx.restore();
  captured=true;
};

saveBtn.onclick=()=>{if(!captured)return;const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download='palm_'+Date.now()+'.png';a.click();};

(function waitCV(){
  const ok=()=>{stat.textContent='OpenCV ready';};
  const poll=()=> (window.cv&&cv.Mat)?ok():setTimeout(poll,200);
  if(window.cv&&cv.onRuntimeInitialized!==undefined){cv.onRuntimeInitialized=ok;poll();}else poll();
})();

anBtn.onclick=()=>{if(!captured)return alert('Capture first');if(!window.cv||!cv.Mat)return alert('OpenCV not loaded');analyze();};

function analyze(){
  const src=cv.imread(canvas);
  const gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  const clahe=new cv.CLAHE(2.0,new cv.Size(8,8)); clahe.apply(gray,gray);
  const ksize=(+gk.value)|0,sigma=4.0,lambd=10.0,gamma=0.5,psi=0,degs=[0,20,40,60,80,100,120,140];
  const gSum=cv.Mat.zeros(gray.rows,gray.cols,cv.CV_32F),resp=new cv.Mat();
  for(const d of degs){
    const th=d*Math.PI/180;
    const ker=cv.getGaborKernel(new cv.Size(ksize,ksize),sigma,th,lambd,gamma,psi,cv.CV_32F);
    cv.filter2D(gray,resp,cv.CV_32F,ker);
    cv.max(gSum,resp,gSum);
    ker.delete();
  }
  const g8=new cv.Mat(); cv.normalize(gSum,gSum,0,255,cv.NORM_MINMAX); gSum.convertTo(g8,cv.CV_8U);
  const bin=new cv.Mat(); cv.adaptiveThreshold(g8,bin,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY,21,-(+edge.value));
  const k3=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(3,3)); cv.morphologyEx(bin,bin,cv.MORPH_OPEN,k3); cv.dilate(bin,bin,k3);
  const contours=new cv.MatVector(),hierarchy=new cv.Mat(); cv.findContours(bin,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
  const out=src.clone();
  for(let i=0;i<contours.size();i++){
    const area=cv.contourArea(contours.get(i));
    if(area<100) continue;
    cv.drawContours(out,contours,i,new cv.Scalar(0,255,0,255),2);
  }
  cv.imshow(canvas,out);
  [gray,clahe,gSum,resp,g8,bin,k3,src,out,hierarchy,contours].forEach(m=>m.delete());
}
</script>
</body>
</html>
