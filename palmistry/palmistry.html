<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="manifest" href="manifest.json">
<title>Palmistry Photo Analyzer · v3.1 (Photo-only)</title>
<style>
:root{--pri:#16f0a7;--bg:#0b0f16;--neon:#00e5ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e6f0ff;font-family:system-ui;text-align:center}
h1{margin:14px 0 6px}
.stage{position:relative;width:92vw;max-width:420px;margin:0 auto 8px;border:2px solid var(--pri);border-radius:16px;overflow:hidden;background:#000;aspect-ratio:3/4}
.stage canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:none}
button{border:none;border-radius:20px;padding:10px 16px;margin:4px;font-weight:700;cursor:pointer}
.btn{background:var(--neon);color:#000}
.sec{background:#222;color:#fff;border:1px solid var(--pri)}
.sec.active{background:var(--neon);color:#000;border-color:transparent}
.controls{display:flex;gap:10px;justify-content:center;align-items:center;margin:6px 0 2px}
.range{width:180px;accent-color:#3b82f6}
small{opacity:.8}
.legend{max-width:480px;margin:6px auto;display:grid;grid-template-columns:1fr 1fr;gap:6px;text-align:left}
.tag{display:flex;align-items:center;gap:8px;font-size:14px;opacity:.95}
.sw{width:14px;height:14px;border-radius:3px;border:1px solid #0003}
#err{max-width:480px;margin:6px auto;color:#ff9b9b;min-height:20px}
#summary{margin-top:8px}
#reportBox{max-width:520px;margin:12px auto;text-align:left;background:#101820;padding:12px;border-radius:12px;display:none}
#reportBox h3{text-align:center;color:#00e5ff;margin-top:0}
.downloadBtn{background:#00e5ff;color:#000;font-weight:bold;margin-top:10px}
.bars{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;align-items:center}
.bars .lab{opacity:.9}
.bars .bar{height:10px;background:#1e293b;border-radius:6px;overflow:hidden}
.bars .bar > i{display:block;height:100%;background:#16f0a7}
footer{margin:12px 0 24px;opacity:.8}
</style>
</head>
<body>
<h1>Palmistry AI Analyzer · Photo Mode</h1>

<div class="stage">
  <canvas id="base"></canvas>
  <canvas id="overlay"></canvas>
  <canvas id="labels"></canvas>
</div>

<div>
  <button id="handLeft"  class="sec">Left Hand</button>
  <button id="handRight" class="sec active">Right Hand</button>

  <button id="takePhoto" class="btn">📷 Take Photo</button>
  <button id="pickPhoto" class="sec">🖼️ Pick from Gallery</button>
  <input id="camInput"  type="file" accept="image/*" capture="environment" style="display:none">
  <input id="galInput"  type="file" accept="image/*" style="display:none">

  <button id="analyze" class="sec">Analyze</button>
  <button id="reset" class="sec">Retake</button>
</div>

<div class="controls">
  <small>Threshold</small>
  <input id="thr" class="range" type="range" min="0" max="70" step="2" value="10" />
  <small id="thrVal">10</small>
</div>

<div class="legend">
  <div class="tag"><span class="sw" style="background:#ff5a7d"></span>Heart</div>
  <div class="tag"><span class="sw" style="background:#5aa3ff"></span>Head</div>
  <div class="tag"><span class="sw" style="background:#54f19a"></span>Life</div>
  <div class="tag"><span class="sw" style="background:#ffd24d"></span>Fate (Destiny)</div>
  <div class="tag"><span class="sw" style="background:#ffa64d"></span>Sun (Apollo)</div>
  <div class="tag"><span class="sw" style="background:#a78bfa"></span>Mercury (Health)</div>
  <div class="tag"><span class="sw" style="background:#ff9bd3"></span>Marriage</div>
</div>

<div id="err"></div>
<div id="summary">AI Summary: —</div>

<div id="reportBox">
  <h3>🪶 Palmistry Insight Report</h3>
  <div id="reportText"></div>
  <button id="savePDF" class="downloadBtn">Download PDF</button>
</div>

<footer><small>© Sathyadarshana · Research Build v3.1 (Photo-only) · Works Offline</small></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ========= elements ========= */
const base = document.getElementById('base'),
      overlay = document.getElementById('overlay'),
      labels = document.getElementById('labels'),
      bctx = base.getContext('2d'),
      octx = overlay.getContext('2d'),
      lctx = labels.getContext('2d'),
      sum  = document.getElementById('summary'),
      errBox = document.getElementById('err'),
      report = document.getElementById('reportBox'),
      rtext  = document.getElementById('reportText'),
      thr    = document.getElementById('thr'),
      thrVal = document.getElementById('thrVal');

const handLeftBtn  = document.getElementById('handLeft');
const handRightBtn = document.getElementById('handRight');
const takePhotoBtn = document.getElementById('takePhoto');
const pickPhotoBtn = document.getElementById('pickPhoto');
const camInput = document.getElementById('camInput');
const galInput = document.getElementById('galInput');

let currentHand='right', locked=false, manifestVersion='3.1';

/* ========= util ========= */
function showErr(m){ console.error(m); errBox.textContent=m||''; }
function showStack(){ [base,overlay,labels].forEach(c=>c.style.display='block'); }
function hideStack(){ [base,overlay,labels].forEach(c=>c.style.display='none'); }
function drawImageToBase(img){
  const W = base.width = overlay.width = labels.width  = img.width;
  const H = base.height= overlay.height= labels.height = img.height;
  bctx.clearRect(0,0,W,H);
  bctx.drawImage(img,0,0,W,H);
}
function setHand(h){
  currentHand=h;
  handLeftBtn.classList.toggle('active', h==='left');
  handRightBtn.classList.toggle('active',h==='right');
  sum.textContent = `Selected: ${h[0].toUpperCase()+h.slice(1)} hand`;
}

/* optional: read manifest version */
fetch('manifest.json').then(r=>r.json()).then(j=>manifestVersion=j.version).catch(()=>{});

/* ========= inputs ========= */
handLeftBtn.onclick  = ()=>setHand('left');
handRightBtn.onclick = ()=>setHand('right');

takePhotoBtn.onclick = ()=> camInput.click();
pickPhotoBtn.onclick = ()=> galInput.click();

function handleFile(file){
  if(!file){ showErr('No image selected'); return; }
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = ()=>{
    drawImageToBase(img);
    locked = true;
    showStack();
    sum.textContent = 'Photo loaded. Ready to analyze.';
    URL.revokeObjectURL(url);
  };
  img.src = url;
}
camInput.onchange = e => handleFile(e.target.files?.[0]);
galInput.onchange = e => handleFile(e.target.files?.[0]);

/* ========= analysis hooks ========= */
/* DEMO: derive line metrics from image data (replace with real CV later) */
function deriveLineScores(){
  const w=base.width,h=base.height;
  const {data}=bctx.getImageData(0,0,w,h);
  // Simple luminance variance as a proxy for detail/edges per horizontal band
  let sum=0, sum2=0, n=0;
  for(let i=0;i<data.length;i+=4){
    const y=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
    sum+=y; sum2+=y*y; n++;
  }
  const mean=sum/n, varc=Math.max(0,(sum2/n)-(mean*mean)); // 0..~65025
  const baseScore=Math.max(0, Math.min(1, varc/5000));
  // fabricate per-line but stable based on image stats + hand
  const bias = currentHand==='left'? -0.05: +0.05;
  return {
    heart:   clamp01(baseScore*0.95 + 0.10 + bias),
    head:    clamp01(baseScore*1.05 + 0.08 - bias),
    life:    clamp01(baseScore*1.10 + 0.05),
    fate:    clamp01(baseScore*0.85 + 0.12),
    sun:     clamp01(baseScore*0.80 + 0.10),
    mercury: clamp01(baseScore*0.90 + 0.06),
    marriage:clamp01(baseScore*0.75 + 0.14)
  };
}
function clamp01(x){ return x<0?0:x>1?1:x; }

/* pretty HTML for report (bars) */
function makeReportHTML(scores){
  const order=[
    ['heart','Heart ❤️'],
    ['head','Head 💙'],
    ['life','Life 💚'],
    ['fate','Fate 💛'],
    ['sun','Sun 🧡'],
    ['mercury','Mercury 💜'],
    ['marriage','Marriage 💖'],
  ];
  const rows = order.map(([k,label])=>{
    const pct=Math.round((scores[k]??0)*100);
    return `<div class="lab">${label}</div>
            <div class="bar"><i style="width:${pct}%"></i></div>`;
  }).join('');
  return `<div class="bars">${rows}</div>`;
}

/* save small thumbnail (for future list previews) */
function makeThumbnail(maxW=240){
  const ratio = base.width/base.height;
  const tw = maxW, th = Math.round(tw/ratio);
  const c = document.createElement('canvas');
  c.width=tw; c.height=th;
  const cx=c.getContext('2d');
  cx.drawImage(base,0,0,tw,th);
  return c.toDataURL('image/jpeg',0.72);
}

/* overlay (demo) */
function paintOverlay(){
  octx.clearRect(0,0,overlay.width,overlay.height);
  octx.fillStyle='rgba(255,255,255,0.10)';
  octx.fillRect(0,0,overlay.width,overlay.height);
}

/* ========= analyze ========= */
document.getElementById('analyze').onclick = ()=>{
  if(!locked){ alert('Please take or pick a photo first'); return; }
  paintOverlay();
  const scores = deriveLineScores();
  const H = currentHand[0].toUpperCase()+currentHand.slice(1);
  sum.textContent = `Analyze complete · ${H} hand.`;

  const reportHTML = makeReportHTML(scores);
  rtext.innerHTML = reportHTML;
  report.style.display='block';

  saveResult(scores, reportHTML);
};

/* ========= reset ========= */
document.getElementById('reset').onclick = ()=>{
  locked=false; hideStack(); report.style.display='none';
  showErr(''); sum.textContent='AI Summary: —';
};

/* ========= pdf ========= */
document.getElementById('savePDF').onclick = ()=>{
  const {jsPDF}=window.jspdf; const doc=new jsPDF();
  doc.setFontSize(16); doc.text('Sathyadarshana Palmistry AI Insight Report',10,15);
  doc.setFontSize(12); doc.text('────────────────────────────',10,20);
  let y=30;
  doc.text(`Hand: ${currentHand}`,10,y); y+=8;
  // crude text export from our bars (labels only)
  const labels=['Heart','Head','Life','Fate','Sun','Mercury','Marriage'];
  const sc=JSON.parse(sessionStorage.getItem('lastScores')||'{}');
  labels.forEach(L=>{ const v=sc[L.toLowerCase()]!=null? Math.round(sc[L.toLowerCase()]*100):'—';
                      doc.text(`${L}: ${v}%`,10,(y+=8)); });
  doc.save('Palmistry_AI_Report.pdf');
};

/* ========= results store ========= */
function saveResult(scores, reportHTML){
  const KEY='palmistryResults';
  sessionStorage.setItem('lastScores', JSON.stringify(scores));
  const result={
    ts: Date.now(),
    hand: currentHand,
    summary: 'auto-analyzed',
    lines: {
      heart:{score:scores.heart},
      head:{score:scores.head},
      life:{score:scores.life},
      fate:{score:scores.fate},
      sun:{score:scores.sun},
      mercury:{score:scores.mercury},
      marriage:{score:scores.marriage}
    },
    reportHTML,
    thumb: makeThumbnail(),
    meta: { version: manifestVersion, mode:'photo' }
  };
  const arr=JSON.parse(localStorage.getItem(KEY)||'[]');
  arr.unshift(result);
  localStorage.setItem(KEY, JSON.stringify(arr));
  const toast=document.createElement('div');
  toast.textContent='Saved to Results. See “Results & Reports”.';
  toast.style.cssText='position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#00e5ff;color:#000;padding:8px 12px;border-radius:10px;font-weight:700;z-index:9999';
  document.body.appendChild(toast); setTimeout(()=>toast.remove(),2200);
}

/* init */
hideStack();
thr.addEventListener('input', ()=> thrVal.textContent = thr.value );
</script>
</body>
</html>
