<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Palmistry Â· Analyzer v4 â€“ Quantum Insight</title>
<style>
:root{
  --bg:#0b0f16; --card:#0f172a; --neon:#00e5ff; --pri:#16f0a7; --mut:#7aa0c4;
  --danger:#ff6b6b; --ok:#ffd166; --good:#16f0a7;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 800px at 50% -10%, #0e2133 0%, #0b0f16 55%, #070a0f 100%);
     color:#e6f0ff;font-family:system-ui,Segoe UI,Inter}
h1{margin:14px 0 6px;text-align:center;color:var(--neon);letter-spacing:.3px}
.sub{opacity:.85;text-align:center;margin-bottom:8px}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
nav{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin:8px 0 14px}
a.btn,button.btn{background:#0c1320;color:#9edcff;border:1px solid #1c3a58;border-radius:14px;
  padding:8px 12px;text-decoration:none;font-weight:700;cursor:pointer;transition:.25s}
a.btn:hover,button.btn:hover{background:#00e5ff;color:#001015;border-color:#00e5ff}
.grid{display:grid;gap:12px}
@media(min-width:1000px){.grid{grid-template-columns:1.25fr 1fr}}
.card{background:linear-gradient(180deg,#0f1524 0%, #0c1120 100%);
      border:1px solid #113046;border-radius:16px;padding:12px;box-shadow:0 0 0 1px #0a1a29 inset}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
label{font-weight:700}
select,input[type="file"]{background:#0d1522;color:#e6f0ff;border:1px solid #17324a;border-radius:10px;padding:8px}
small.muted{opacity:.75}
.badge{display:inline-block;border:1px solid #224d6b;background:#0c1522;color:#9edcff;border-radius:999px;
       font-size:12px;padding:2px 8px;margin-left:6px}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center}
.bar{background:#0d1320;border-radius:10px;height:10px;overflow:hidden}
.bar>span{display:block;height:100%;background:linear-gradient(90deg,#34d399,#16f0a7);transform-origin:left center;transform:scaleX(0)}
hr{border:0;border-top:1px solid #0f2233;margin:10px 0}
.center{text-align:center}

.camWrap{position:relative;display:grid;place-items:center;max-width:560px}
video,canvas{width:100%;max-width:560px;border-radius:16px;border:2px solid #0e2a33;background:#000}
.aura{
  position:absolute;inset:0;border-radius:16px;pointer-events:none;
  filter:blur(28px) saturate(140%);opacity:.85;mix-blend-mode:screen;
  background:conic-gradient(from 0deg, #00e5ff55, #16f0a755, #9a6bff55, #00e5ff55);
  animation:aura 6s linear infinite;
}
@keyframes aura{to{transform:rotate(360deg)}}

.glowBtn{position:relative;overflow:hidden}
.glowBtn::after{
  content:"";position:absolute;inset:-2px;border-radius:16px;pointer-events:none;
  background:conic-gradient(from 0deg,#00e5ff,#16f0a7,#9a6bff,#00e5ff);
  filter:blur(12px);opacity:.0;transition:.25s;
}
.glowBtn.success::after{opacity:.8;animation:aura 3s linear infinite}

.pair{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.paircode{font-family:ui-monospace,Consolas,monospace;font-size:12px;background:#0c1522;border:1px dashed #224d6b;
          padding:4px 8px;border-radius:8px;color:#9edcff}

#insight{min-height:96px;background:#0b1320;border:1px solid #17324a;border-radius:12px;padding:10px}
#insight b{color:#a2f5ff}
.type{white-space:pre-wrap}

.tip{font-size:12px;opacity:.8}
.note{font-size:12px;color:#a6b4c4}
</style>
</head>
<body>
  <h1>Quantum Palm Analyzer v4</h1>
  <div class="sub">Left = <b>Past</b> â€¢ Right = <b>Present</b> Â· Î”K ready Â· v4 engine (experimental)</div>

  <nav>
    <a class="btn" href="results.html">Results & Reports</a>
    <a class="btn" href="palmistry_photo.html">Photo Analyzer</a>
    <a class="btn" href="detect.html">AI Detection</a>
  </nav>

  <div class="wrap grid">
    <!-- LEFT: Capture / Preview -->
    <section class="card">
      <div class="row">
        <label for="hand">Hand</label>
        <select id="hand">
          <option value="left">Left (Past)</option>
          <option value="right">Right (Present)</option>
        </select>
        <span class="badge">Engine v4</span>
        <small class="muted tip">Diffuse daylight â€¢ neutral bg â€¢ 40â€“50cm â€¢ fingers relaxed</small>
      </div>

      <div class="row pair">
        <button class="btn" id="newPair">New Session</button>
        <button class="btn" id="reusePair">Continue Session</button>
        <span class="paircode" id="pairCode">pair: â€”</span>
        <small class="note">Sessions link Left+Right via pairId for Î”K comparison.</small>
      </div>

      <div class="row">
        <button class="btn" id="startCam">Start Camera</button>
        <button class="btn" id="capBtn">Capture</button>
        <label class="btn" for="filePick" style="display:inline-block">Upload Photo</label>
        <input id="filePick" type="file" accept="image/*" style="display:none"/>
        <button class="btn" id="clear">Clear</button>
      </div>

      <div class="camWrap">
        <video id="video" playsinline autoplay muted style="max-height:340px"></video>
        <canvas id="preview" width="560" height="340"></canvas>
        <div class="aura" aria-hidden="true"></div>
      </div>
      <div class="tip" id="placeholder" style="text-align:center;margin-top:6px">No image yet â€” start camera or upload a photo.</div>
    </section>

    <!-- RIGHT: Analysis / Insight / Save -->
    <section class="card">
      <div class="row">
        <button class="btn" id="analyze">Analyze</button>
        <button class="btn glowBtn" id="save">Save to Results</button>
      </div>

      <div class="kv"><b>Confidence</b> <div class="badge" id="confBadge">â€”</div></div>
      <div class="kv"><span>Heart</span>   <div class="bar"><span id="bHeart"></span></div></div>
      <div class="kv"><span>Head</span>    <div class="bar"><span id="bHead"></span></div></div>
      <div class="kv"><span>Life</span>    <div class="bar"><span id="bLife"></span></div></div>
      <div class="kv"><span>Fate</span>    <div class="bar"><span id="bFate"></span></div></div>
      <div class="kv"><span>Sun</span>     <div class="bar"><span id="bSun"></span></div></div>
      <div class="kv"><span>Mercury</span> <div class="bar"><span id="bMerc"></span></div></div>
      <div class="kv"><span>Marriage</span><div class="bar"><span id="bMar"></span></div></div>

      <hr/>
      <div id="insight"><div class="type" id="typeBox">Run Analyze to generate insightâ€¦</div></div>
    </section>
  </div>

<script>
/* ================== Session / PairID ================== */
const PAIR_KEY = 'currentPairId';
function getPairId(){ return localStorage.getItem(PAIR_KEY) || null; }
function setPairId(id){ localStorage.setItem(PAIR_KEY, id); paintPair(); }
function newPairId(){ return (crypto.randomUUID && crypto.randomUUID()) || ('pair_'+Date.now().toString(36)); }
function paintPair(){ document.getElementById('pairCode').textContent = 'pair: ' + (getPairId() || 'â€”'); }
document.getElementById('newPair').onclick = ()=> setPairId(newPairId());
document.getElementById('reusePair').onclick = ()=> { if(!getPairId()) setPairId(newPairId()); paintPair(); };
paintPair();

/* =============== Storage (compatible with results.html) =============== */
const PR_KEY = 'palmistryResults';
function prLoad(){ try{ return JSON.parse(localStorage.getItem(PR_KEY)||'[]')||[] }catch{ return [] } }
function prSave(a){ try{ localStorage.setItem(PR_KEY, JSON.stringify(a)); }catch(e){ alert('Storage full. Export from Results & clear.'); } }
function prAdd(entry){ const a=prLoad(); if(a.some(x=>x.ts===entry.ts)) entry.ts=Date.now(); a.push(entry); prSave(a); }

/* ================== Camera / Upload ================== */
const video = document.getElementById('video');
const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d');
const ph  = document.getElementById('placeholder');
let stream = null;

document.getElementById('startCam').onclick = async () => {
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    ph.textContent = 'Camera active â€” align your palm in the frame.';
  }catch(e){
    alert('Camera access failed. Use Upload Photo.');
  }
};
document.getElementById('capBtn').onclick = () => {
  if(!video.srcObject){ alert('Start camera first.'); return; }
  drawToCanvas(video);
};
document.getElementById('filePick').onchange = (e) => {
  const f = e.target.files[0]; if(!f) return;
  const img = new Image();
  img.onload = ()=> drawToCanvas(img);
  img.src = URL.createObjectURL(f);
};
document.getElementById('clear').onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ph.textContent = 'Cleared â€” capture or upload again.';
};

function drawToCanvas(src){
  const w = canvas.width, h = canvas.height;
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
  const srcW = src.videoWidth || src.width, srcH = src.videoHeight || src.height;
  const CR = w/h, ratio = srcW/srcH;
  let sw,sh,sx,sy;
  if(ratio>CR){ sh=srcH; sw=sh*CR; sx=(srcW-sw)/2; sy=0; }
  else { sw=srcW; sh=sw/CR; sx=0; sy=(srcH-sh)/2; }
  ctx.drawImage(src, sx,sy,sw,sh, 0,0,w,h);
  ph.textContent = 'Frame captured.';
}

/* ================== Analyzer v4 (deterministic lightweight) ================== */
function analyzeCanvas(){
  const {width:w,height:h}=canvas;
  const img = ctx.getImageData(0,0,w,h); const d=img.data;

  // Grayscale
  const gray = new Float32Array(w*h);
  for(let i=0,j=0;i<d.length;i+=4,j++){ gray[j] = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]; }

  // Sobel edges
  const mag = new Float32Array(w*h);
  const KX=[-1,0,1,-2,0,2,-1,0,1], KY=[-1,-2,-1,0,0,0,1,2,1];
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      let gx=0, gy=0, k=0;
      for(let yy=-1;yy<=1;yy++) for(let xx=-1;xx<=1;xx++,k++){
        const g = gray[(y+yy)*w + (x+xx)];
        gx += g * KX[k]; gy += g * KY[k];
      }
      mag[y*w+x] = Math.hypot(gx,gy);
    }
  }

  // Global clarity metrics
  let mean=0; for(let i=0;i<gray.length;i++) mean+=gray[i]; mean/=gray.length;
  let var=0; for(let i=0;i<gray.length;i++){ const dv=gray[i]-mean; var+=dv*dv; }
  const contrast = Math.sqrt(var/gray.length);
  let eSum=0; for(let i=0;i<mag.length;i++) eSum+=mag[i];
  const edgeMean = eSum/(mag.length||1);

  // Confidence 0..100
  const conf = clamp( map(contrast,15,38,55,96)*0.6 + map(edgeMean,2,14,40,98)*0.4 , 30, 98);

  // 7 vertical bands ~ line zones
  const bands=7, bandScores=new Array(bands).fill(0);
  for(let y=0;y<h;y++){
    const bi = Math.min(bands-1, Math.floor(y/h*bands));
    let row=0; for(let x=0;x<w;x++) row += mag[y*w+x];
    bandScores[bi] += row/w;
  }
  const maxBand=Math.max(...bandScores,1);
  const z = bandScores.map(v=> clamp((v/maxBand)*100, 10, 96));

  const mapIdx={heart:0, head:1, life:2, fate:3, sun:4, mercury:5, marriage:6};
  const lines={};
  for(const [k,bi] of Object.entries(mapIdx)){
    lines[k] = { score: Math.round( clamp(0.65*z[bi] + 0.35*conf, 0, 100) ) };
  }
  return { confidence: Math.round(conf), lines };
}
function map(v,inMin,inMax,outMin,outMax){ const t=(v-inMin)/(inMax-inMin); return outMin + clamp(t,0,1)*(outMax-outMin); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ================== UI Bindings ================== */
const bars = {
  heart: b('bHeart'), head: b('bHead'), life: b('bLife'), fate: b('bFate'),
  sun: b('bSun'), mercury: b('bMerc'), marriage: b('bMar')
};
function b(id){return document.getElementById(id)}
const confBadge = document.getElementById('confBadge');
let lastResult = null;

document.getElementById('analyze').onclick = ()=>{
  // guard: ensure canvas not blank
  const pix = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let has = false; for(let i=0;i<pix.length;i+=64){ if(pix[i]|pix[i+1]|pix[i+2]){has=true;break;} }
  if(!has){ alert('Capture or upload a photo first.'); return; }

  const r = analyzeCanvas(); lastResult = r;
  confBadge.textContent = r.confidence + '%';
  for(const k of Object.keys(bars)){ bars[k].style.transform = `scaleX(${(r.lines[k].score||0)/100})`; }
  typeInsight(buildInsightText(r));
};

function buildInsightText(r){
  const L=r.lines;
  const hi = Object.entries(L).sort((a,b)=>b[1].score-a[1].score)[0][0];
  const lo = Object.entries(L).sort((a,b)=>a[1].score-b[1].score)[0][0];
  const mapName={heart:'Heart',head:'Head',life:'Life',fate:'Fate',sun:'Sun',mercury:'Mercury',marriage:'Marriage'};
  const handTxt = (document.getElementById('hand').value==='left') ? 'Past' : 'Present';

  const tips = [];
  if(hi==='heart') tips.push('Emotional clarity is rising; compassion guides choices.');
  if(hi==='head') tips.push('Strong mental focus; decisions align with reason.');
  if(hi==='life') tips.push('Vital energy is stable; resilience improving.');
  if(hi==='fate') tips.push('Path alignment strengthens; purpose crystallizes.');
  if(hi==='sun')  tips.push('Creative radiance; recognition possible.');
  if(hi==='mercury') tips.push('Communication & wellness patterns balancing.');
  if(hi==='marriage') tips.push('Relationship lines show steadier bonds.');

  const caut = [];
  if(lo==='heart') caut.push('Guard sensitivities; nurture calm dialogue.');
  if(lo==='head') caut.push('Simplify choices; avoid overthinking.');
  if(lo==='life') caut.push('Prioritize rest & breathing rhythms.');
  if(lo==='fate') caut.push('Allow pivots; stay open to subtle cues.');
  if(lo==='sun')  caut.push('Create without chasing applause.');
  if(lo==='mercury') caut.push('Hydrate, stretch, speak gently.');
  if(lo==='marriage') caut.push('Tend to trust; practice presence.');

  return [
    `ðŸœ Mode: ${handTxt} Â· Confidence ${r.confidence}%`,
    `â€¢ Strongest line â†’ ${mapName[hi]} (${L[hi].score})`,
    `â€¢ Tender line   â†’ ${mapName[lo]} (${L[lo].score})`,
    `â–¸ Insight: ${tips[0]||'Subtle progress emerging.'}`,
    `â–¸ Care   : ${caut[0]||'Keep steady routines.'}`
  ].join('\n');
}

/* typewriter */
function typeInsight(text){
  const box = document.getElementById('typeBox'); box.textContent='';
  let i=0; const run=()=>{ box.textContent = text.slice(0,i++); if(i<=text.length) requestAnimationFrame(run); };
  run();
}

/* ================== Save to Results ================== */
async function canvasThumb(q=0.75){ return canvas.toDataURL('image/jpeg', q); }
function buildReportHTML(whichHand, r){
  const t = whichHand==='left' ? 'Past (Left) Reading' : 'Present (Right) Reading';
  const L=r.lines;
  return `
  <section>
    <h3>${t}</h3>
    <ul>
      <li>Heart: ${L.heart.score}</li>
      <li>Head: ${L.head.score}</li>
      <li>Life: ${L.life.score}</li>
      <li>Fate: ${L.fate.score}</li>
      <li>Sun: ${L.sun.score}</li>
      <li>Mercury: ${L.mercury.score}</li>
      <li>Marriage: ${L.marriage.score}</li>
    </ul>
  </section>`.trim();
}
document.getElementById('save').onclick = async (ev)=>{
  if(!lastResult){ alert('Run Analyze first.'); return; }
  let pairId = getPairId(); if(!pairId){ pairId=newPairId(); setPairId(pairId); }
  const whichHand = document.getElementById('hand').value;
  const entry = {
    ts: Date.now(),
    pairId,
    hand: whichHand,
    thumb: await canvasThumb(0.75),
    meta: { version:'4.0', confidence:lastResult.confidence },
    lines: lastResult.lines,
    reportHTML: buildReportHTML(whichHand, lastResult)
  };
  prAdd(entry);
  const btn = ev.currentTarget; btn.classList.add('success');
  setTimeout(()=>btn.classList.remove('success'),1200);
  alert('Saved! Open Results & Reports to compare/export.');
};
</script>
</body>
</html>
