<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Palmistry Universal v5.5 · Camera + Analyze</title>
<style>
:root{
  --pri:#16f0a7; --neon:#00e5ff; --bg:#0b0f16; --ink:#e6f0ff; --card:#0f1420;
  --muted:#9fb3c8; --warn:#ffcc66; --err:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
main{max-width:980px;margin:auto;padding:14px}
h1{margin:10px 0 2px}
small{opacity:.85}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid #122136;border-radius:16px;padding:10px;box-shadow:0 0 0 1px #0a1520 inset}
.stage{position:relative;display:grid;place-items:center}
video,canvas{width:100%;max-width:460px;border-radius:16px;border:2px solid var(--pri);background:#000}
.overlay{position:absolute;inset:10px;pointer-events:none;opacity:.55}
.controls label{display:inline-flex;align-items:center;gap:6px;margin:6px 10px 0 0;font-size:.95rem}
select,input[type=range]{background:#091120;color:var(--ink);border:1px solid #2a405a;border-radius:10px;padding:6px 8px}
button{
  background:linear-gradient(180deg,var(--neon),var(--pri));
  color:#001315;border:none;border-radius:12px;padding:10px 14px;font-weight:600;
  box-shadow:0 6px 20px rgba(0,229,255,.25), inset 0 0 0 1px rgba(0,0,0,.25); cursor:pointer
}
button.secondary{background:#0f2033;color:#d7ecff;border:1px solid #29465f}
button:disabled{opacity:.45;cursor:not-allowed}
.kbd{font:600 12px/1 ui-monospace,Menlo;background:#09131f;border:1px solid #1a2a3f;padding:2px 6px;border-radius:6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e1d2c;border:1px solid #274663;color:#bfe9ff;font-size:.78rem}
hr{border:none;border-top:1px solid #173048;margin:12px 0}
.notice{font-size:.95rem;color:var(--muted)}
footer{margin:14px 0 6px;text-align:center;color:#9db3c8}
#status{border:1px dashed #35597a;border-radius:10px;padding:8px 10px;min-height:42px}
#summary{border:1px solid #234459;border-radius:12px;padding:10px;background:#0c1623}
</style>
</head>
<body>
<main>
  <h1>Palmistry Universal <span class="badge">v5.5</span></h1>
  <small>Multilingual · Capture → Analyze → Report (edge-map baseline)</small>

  <div class="row">
    <section class="card" style="flex:1 1 480px">
      <div class="stage">
        <video id="cam" playsinline muted></video>
        <canvas id="overlay" class="overlay"></canvas>
      </div>

      <div class="controls">
        <div class="row">
          <button id="startBtn">Start</button>
          <button id="cycleBtn" class="secondary">Cycle Camera</button>
          <button id="flipBtn" class="secondary">Flip</button>
          <button id="torchBtn" class="secondary">Torch</button>
          <button id="captureBtn">Capture</button>
          <button id="analyzeBtn" class="secondary">Analyze</button>
          <button id="clearBtn" class="secondary">Clear</button>
        </div>
        <div class="row" style="margin-top:6px">
          <label>Device
            <select id="deviceSel"></select>
          </label>
          <label>Resolution
            <select id="resSel">
              <option value="1920x1080">1920×1080</option>
              <option value="1280x720" selected>1280×720</option>
              <option value="960x540">960×540</option>
              <option value="640x480">640×480</option>
            </select>
          </label>
          <label>FPS
            <select id="fpsSel">
              <option>60</option><option selected>30</option><option>24</option>
            </select>
          </label>
          <label>Zoom
            <input id="zoom" type="range" min="1" max="5" value="1" step="0.1">
          </label>
          <label>Edge
            <input id="edge" type="range" min="20" max="120" value="70">
          </label>
        </div>
      </div>

      <hr/>
      <div id="status" class="notice">Press <span class="kbd">Start</span> and allow camera access.</div>
    </section>

    <section class="card" style="flex:1 1 420px">
      <canvas id="capture" width="0" height="0" aria-label="Captured frame" style="width:100%;max-width:460px"></canvas>
      <hr/>
      <h3 style="margin:6px 0">AI Summary</h3>
      <div id="summary">
        <div><strong>Lines:</strong> Heart, Head, Life, Fate, Sun, Marriage (auto-detect planned)</div>
        <div id="aiText" class="notice">Run <b>Analyze</b> to see an edge map. This baseline prepares for palm-line detection.</div>
      </div>
    </section>
  </div>

  <footer>© Sathyadarshana · Neon Jelly UI · Works offline (no external libs)</footer>
</main>

<script>
/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);
const log = (msg, type="info") => {
  const box = $("#status");
  const color = type==="error" ? "var(--err)" : type==="warn" ? "var(--warn)" : "var(--muted)";
  box.innerHTML = `<span style="color:${color}">${msg}</span>`;
  console[type==="error"?"error":type==="warn"?"warn":"log"]("[Palmistry]", msg);
};

let stream = null, track = null, torchOn = false, facing = "environment";
let currentDeviceId = null;

const cam = $("#cam");
const overlay = $("#overlay");
const octx = overlay.getContext("2d");
const cap = $("#capture");
const cctx = cap.getContext("2d");

/* ========= Camera ========= */
async function listDevices(){
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const vids = devs.filter(d=>d.kind==="videoinput");
    const sel = $("#deviceSel"); sel.innerHTML = "";
    vids.forEach((d,i)=>{
      const opt=document.createElement("option");
      opt.value=d.deviceId; opt.textContent=d.label || `Camera ${i+1}`;
      sel.appendChild(opt);
    });
    if(vids.length){ currentDeviceId = vids[0].deviceId; }
  }catch(e){ log("Device list failed: "+e.message,"warn"); }
}

function constraints(){
  const [w,h] = $("#resSel").value.split("x").map(Number);
  const fps = Number($("#fpsSel").value);
  const base = {
    audio:false,
    video:{
      deviceId: currentDeviceId?{exact:currentDeviceId}:undefined,
      facingMode: currentDeviceId?undefined:{ideal:facing},
      width:{ideal:w}, height:{ideal:h}, frameRate:{ideal:fps}
    }
  };
  return base;
}

async function startCamera(){
  try{
    if(stream){ stopCamera(); }
    stream = await navigator.mediaDevices.getUserMedia(constraints());
    cam.srcObject = stream;
    await cam.play();
    track = stream.getVideoTracks()[0];

    // Fit overlay to video box
    const resize = ()=>{
      const rect = cam.getBoundingClientRect();
      overlay.width = rect.width; overlay.height = rect.height;
    };
    resize(); setTimeout(resize, 100);
    window.addEventListener("resize", resize, {passive:true});

    // Set zoom if supported
    const caps = track.getCapabilities?.() || {};
    if(caps.zoom){
      $("#zoom").min = caps.zoom.min; $("#zoom").max = caps.zoom.max; $("#zoom").step = caps.zoom.step || 0.1;
      $("#zoom").addEventListener("input", e=>{
        track.applyConstraints({advanced:[{zoom: Number(e.target.value)}]}).catch(()=>{});
      });
    }else{
      $("#zoom").disabled = true;
    }

    // Torch capability
    $("#torchBtn").disabled = !(caps.torch);
    log(`Camera started · ${track.label || "video track"} · ${cam.videoWidth}×${cam.videoHeight}@${$("#fpsSel").value}fps`);
    drawOverlayLoop();
    await listDevices();
  }catch(e){
    if(e.name==="NotAllowedError") log("Permission denied. Allow camera in browser settings and try again.","error");
    else if(e.name==="NotFoundError") log("No camera found on this device.","error");
    else log("Camera start failed: "+e.message,"error");
  }
}

function stopCamera(){
  try{ stream?.getTracks().forEach(t=>t.stop()); }catch{}
  stream=null; track=null;
}

function cycleCamera(){
  facing = (facing==="environment") ? "user" : "environment";
  currentDeviceId = null; // let facingMode choose
  startCamera();
}

function flipVideoCSS(){
  cam.style.transform = cam.style.transform ? "" : "scaleX(-1)";
  overlay.style.transform = cam.style.transform;
}

async function toggleTorch(){
  if(!track) return;
  const caps = track.getCapabilities?.() || {};
  if(!caps.torch){ log("Torch not supported on this camera.","warn"); return; }
  torchOn = !torchOn;
  await track.applyConstraints({advanced:[{torch: torchOn}]});
  log(torchOn ? "Torch ON" : "Torch OFF");
}

/* ========= Overlay loop ========= */
let rafId = null;
function drawOverlayLoop(){
  cancelAnimationFrame(rafId);
  const draw = ()=>{
    const rect = cam.getBoundingClientRect();
    octx.clearRect(0,0,overlay.width, overlay.height);

    // guide box + crosshair
    octx.strokeStyle = "rgba(0,229,255,.9)";
    octx.lineWidth = 2;
    const pad=10;
    octx.strokeRect(pad,pad,overlay.width-2*pad,overlay.height-2*pad);

    octx.setLineDash([6,6]); octx.lineWidth=1.5; octx.strokeStyle="rgba(22,240,167,.9)";
    octx.beginPath();
    octx.moveTo(overlay.width/2, pad); octx.lineTo(overlay.width/2, overlay.height-pad);
    octx.moveTo(pad, overlay.height/2); octx.lineTo(overlay.width-pad, overlay.height/2);
    octx.stroke(); octx.setLineDash([]);

    rafId = requestAnimationFrame(draw);
  };
  draw();
}

/* ========= Capture & Analyze ========= */
function captureFrame(){
  if(!cam.videoWidth){ log("Camera not ready yet.","warn"); return; }
  cap.width = cam.videoWidth; cap.height = cam.videoHeight;
  cctx.save();
  // If video is flipped via CSS, reflect the capture to match the view
  const flipped = cam.style.transform.includes("scaleX(-1)");
  if(flipped){
    cctx.translate(cap.width,0); cctx.scale(-1,1);
  }
  cctx.drawImage(cam,0,0,cap.width,cap.height);
  cctx.restore();
  $("#aiText").innerHTML = "Captured frame ready. Click <b>Analyze</b>.";
  log("Captured current frame.");
}

// Simple Sobel edge map with threshold slider (#edge)
function analyze(){
  if(cap.width===0){ log("No capture yet. Click Capture first.","warn"); return; }
  const w=cap.width,h=cap.height;
  const img = cctx.getImageData(0,0,w,h);
  const gray = new Uint8ClampedArray(w*h);
  for(let i=0,j=0;i<img.data.length;i+=4, j++){
    const r=img.data[i], g=img.data[i+1], b=img.data[i+2];
    gray[j] = (r*0.299 + g*0.587 + b*0.114)|0;
  }
  const sob = new Uint8ClampedArray(w*h);
  const kx=[-1,0,1,-2,0,2,-1,0,1], ky=[-1,-2,-1,0,0,0,1,2,1];
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const i=y*w+x;
      let gx=0,gy=0, t=0;
      let p=0;
      for(let yy=-1;yy<=1;yy++){
        for(let xx=-1;xx<=1;xx++){
          p = gray[(y+yy)*w + (x+xx)];
          const idx=(yy+1)*3+(xx+1);
          gx += p * kx[idx]; gy += p * ky[idx];
        }
      }
      const mag = Math.hypot(gx,gy);
      sob[i] = mag> Number($("#edge").value) ? 255 : 0;
    }
  }
  // paint edge map (white on black, slight teal tint)
  const out = cctx.createImageData(w,h);
  for(let i=0;i<sob.length;i++){
    const v=sob[i];
    out.data[i*4+0]= v? 180:0;
    out.data[i*4+1]= v? 255:0;
    out.data[i*4+2]= v? 255:0;
    out.data[i*4+3]= 255;
  }
  cctx.putImageData(out,0,0);
  $("#aiText").innerHTML = "Edge map generated. Next step: line clustering & labeling (Heart/Head/Life/Fate/Sun/Marriage).";
  log("Analyze completed (Sobel edge map).");
}

function clearAll(){
  cctx.clearRect(0,0,cap.width,cap.height);
  $("#aiText").textContent = "Cleared. Capture again.";
}

/* ========= Event wiring ========= */
$("#startBtn").addEventListener("click", async ()=>{
  await startCamera();
});
$("#cycleBtn").addEventListener("click", cycleCamera);
$("#flipBtn").addEventListener("click", flipVideoCSS);
$("#torchBtn").addEventListener("click", toggleTorch);
$("#captureBtn").addEventListener("click", captureFrame);
$("#analyzeBtn").addEventListener("click", analyze);
$("#clearBtn").addEventListener("click", clearAll);
$("#deviceSel").addEventListener("change", (e)=>{ currentDeviceId=e.target.value; startCamera(); });
$("#resSel").addEventListener("change", startCamera);
$("#fpsSel").addEventListener("change", startCamera);

/* ========= Bootstrap ========= */
(async function bootstrap(){
  if(!("mediaDevices" in navigator)){
    log("This browser does not support camera access (no navigator.mediaDevices).","error");
    return;
  }
  try{
    // Pre-prompt permission (for labels) with a tiny, soon-stopped stream in some browsers
    await listDevices();
    log("Ready. Choose resolution/FPS if needed, then press Start.");
  }catch(e){
    log("Init warning: "+e.message, "warn");
  }
})();
</script>
</body>
</html>
