<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Palmistry Universal v4.6 – Sathyadarshana</title>
<style>
:root{--pri:#16f0a7;--bg:#0b0f16;--neon:#00e5ff}
body{margin:0;background:var(--bg);color:#e6f0ff;font-family:system-ui;text-align:center}
h1{margin:16px 0 8px}
.wrap{position:relative;width:92vw;max-width:480px;margin:12px auto;border:2px solid var(--pri);
border-radius:16px;overflow:hidden;aspect-ratio:3/4;background:#000}
video,canvas{position:absolute;inset:0;width:100%;height:100%;display:block;background:#000}
#cv{display:none}
.overlay{pointer-events:none}
.captureBtn{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);
width:85px;height:85px;border-radius:50%;border:none;background:#2196f3;color:#000;
font-weight:bold;font-size:16px}
button,select,input{margin:6px;padding:6px 10px;border-radius:8px;border:none;font-weight:600}
footer{color:#16f0a7;margin:18px 0;font-size:.9em}
</style>
</head>
<body>
<h1>🖐️ Palmistry Universal v4.6</h1>
<p>Align palm inside guide → Start → Capture → Analyze</p>

<div class="wrap">
  <video id="cam" playsinline muted></video>
  <canvas id="cv"></canvas>
  <canvas id="guide" class="overlay"></canvas>
  <button id="capBtn" class="captureBtn">Capture</button>
</div>

<div>
  <button id="startBtn">▶️ Start</button>
  <select id="camsel"></select>
  <button id="cycleBtn">🔁 Cycle</button>
  <button id="flipBtn">↔️ Flip</button>
</div>

<footer>© 2025 Sathyadarshana · Palmistry AI Overlay</footer>

<script>
const video=document.getElementById('cam');
const canvas=document.getElementById('cv');
const ctx=canvas.getContext('2d');
const guide=document.getElementById('guide');
const gctx=guide.getContext('2d');
const startBtn=document.getElementById('startBtn');
const camsel=document.getElementById('camsel');
const cycleBtn=document.getElementById('cycleBtn');
const flipBtn=document.getElementById('flipBtn');
let stream=null,track=null,isMirrored=false,camList=[],camIndex=0;

function msg(t){console.log(t);}
function drawGuide(){
  const w=guide.width=canvas.width||video.videoWidth||320;
  const h=guide.height=canvas.height||video.videoHeight||480;
  gctx.clearRect(0,0,w,h);
  gctx.strokeStyle='rgba(0,255,255,.4)';gctx.lineWidth=2;
  gctx.strokeRect(10,10,w-20,h-20);
  gctx.beginPath();gctx.ellipse(w/2,h/2,w*0.32,h*0.38,0,0,Math.PI*2);
  gctx.stroke();
}

async function listCams(){
  const devs=await navigator.mediaDevices.enumerateDevices();
  camList=devs.filter(d=>d.kind==='videoinput');
  camsel.innerHTML='';
  camList.forEach((c,i)=>{
    const o=document.createElement('option');
    o.value=c.deviceId;o.textContent=c.label||`Camera ${i+1}`;
    camsel.appendChild(o);
  });
  camIndex=0;
}

async function startCam(deviceId=null){
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  const base={width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}};
  let constraints={video:{...base},audio:false};
  if(deviceId&&deviceId!==""){constraints.video.deviceId={exact:deviceId};}
  else{constraints.video.facingMode={ideal:isMirrored?'user':'environment'};}

  try{
    stream=await navigator.mediaDevices.getUserMedia(constraints);
  }catch(e){
    msg('⚠️ getUserMedia failed, trying fallback: '+e.message);
    stream=await navigator.mediaDevices.getUserMedia({video:true});
  }

  video.srcObject=stream;
  await video.play();
  track=stream.getVideoTracks()[0];
  await new Promise(r=>{if(video.readyState>=1)r();else video.onloadedmetadata=r;});
  const vw=video.videoWidth||640,vh=video.videoHeight||480;
  canvas.width=vw;canvas.height=vh;
  document.querySelector('.wrap').style.aspectRatio=`${vw}/${vh}`;
  drawGuide();
  msg('✅ Camera ready');
}

startBtn.onclick=async()=>{
  try{
    await startCam();
    await listCams();
  }catch(e){msg('❌ '+e.message);}
};
cycleBtn.onclick=async()=>{
  if(!camList.length)await listCams();
  camIndex=(camIndex+1)%camList.length;
  await startCam(camList[camIndex].deviceId);
};
camsel.onchange=()=>startCam(camsel.value);
flipBtn.onclick=()=>{
  isMirrored=!isMirrored;
  video.style.transform=isMirrored?'scaleX(-1)':'none';
};

document.getElementById('capBtn').onclick=()=>{
  if(!video.videoWidth)return;
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  ctx.save();
  if(isMirrored){ctx.translate(canvas.width,0);ctx.scale(-1,1);}
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  ctx.restore();
  msg('📸 Captured!');
};
</script>
</body>
</html>
