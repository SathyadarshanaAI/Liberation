<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palmistry ‚Äì 4K Capture + Fast Shutter</title>
<style>
:root{--pri:#16f0a7;--sec:#38bdf8}
*{box-sizing:border-box}
body{margin:0;background:#0b0f16;color:#e6f0ff;font-family:system-ui,Segoe UI,Inter,Arial,sans-serif;text-align:center}
h1{margin:16px 0 6px}
.wrap{display:inline-block;position:relative;margin:10px auto}
video,canvas{width:92vw;max-width:420px;border-radius:16px;border:2px solid var(--pri);display:block;background:#0e1625}
.ghost{position:absolute;inset:0;width:100%;height:100%;opacity:.25;pointer-events:none}
.badge{position:absolute;left:8px;top:8px;padding:.2rem .45rem;border-radius:8px;font-size:.75rem;background:#0008}
.btns{margin:12px 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
button{border:none;border-radius:10px;padding:.6em 1.0em;font-weight:700;cursor:pointer}
.flip{background:#16243a;color:#cfe9ff}
.flash{background:#f59e0b;color:#111827}
.fast{background:#22c55e;color:#07121f}
.cap{background:var(--sec);color:#07121f}
.an{background:var(--pri);color:#07121f}
.save{background:#fbbf24;color:#111827}
.hint{color:#a6c8ff;margin:6px 0 10px}
.row{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
.chip{background:#0f172a;border:1px solid #1f2c48;border-radius:999px;padding:.25em .6em}
.sl{width:180px}
footer{color:var(--pri);margin:18px 0 22px;font-size:.95em}
</style>

<!-- OpenCV.js (primary + fallback) -->
<script>
(function(){
  const p=document.createElement('script');
  p.src="https://docs.opencv.org/4.x/opencv.js"; p.async=true;
  p.onerror=()=>{const f=document.createElement('script');f.src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.9.0-1/opencv.min.js";f.async=true;document.head.appendChild(f);};
  document.head.appendChild(p);
})();
</script>
</head>
<body>
  <h1>üñêÔ∏è Palmistry ‚Äì 4K Capture + Fast Shutter</h1>

  <div class="wrap">
    <video id="cam" autoplay playsinline muted></video>
    <img class="ghost" src="https://i.ibb.co/1K7K0gF/palm-overlay-demo.png" alt="overlay" onerror="this.style.display='none'">
    <canvas id="cv"></canvas>
    <span id="status" class="badge">loading‚Ä¶</span>
  </div>

  <p class="hint">Background ‡∂ë‡∂ö‡∂ß ‡∂ú‡∑ê‡∂π‡∑î‡∂ª‡∑î/‡∂Ö‡∂≥‡∑î‡∂ª‡∑î ‡∂ª‡∑ô‡∂Ø‡∑í ‡∂Ø‡∑è‡∂Ω‡∑è ‡∂Ö‡∂≠ overlay ‡∂ë‡∂ö‡∂ß align ‡∂ö‡∂ª‡∂Ω‡∑è <b>4K Photo ‚Üí Analyze</b> ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>

  <div class="btns">
    <button class="flip"  id="flipBtn">‚ÜîÔ∏è Flip</button>
    <button class="flash" id="flashBtn" disabled>‚ö° Flash</button>
    <button class="fast"  id="fastBtn"  disabled>üèÉ‚Äç‚ôÇÔ∏è Fast Shutter</button>
    <button class="cap"   id="cap4kBtn" disabled>üì∑ 4K Photo</button>
    <button class="an"    id="anBtn"    disabled>‚ú® Analyze</button>
    <button class="save"  id="saveBtn"  disabled>üíæ Save PNG</button>
  </div>

  <div class="row">
    <span class="chip">Edge: <input id="th1" class="sl" type="range" min="20" max="120" value="60"> <small id="th1v">60</small></span>
    <span class="chip">Detail: <input id="gk" class="sl" type="range" min="7" max="23" step="2" value="15"> <small id="gkv">15</small></span>
  </div>

  <footer>¬© 2025 Lebaretion ¬∑ Sathyadarshana</footer>

<script>
const v = document.getElementById('cam');
const c = document.getElementById('cv');
const x = c.getContext('2d');
const statusE = document.getElementById('status');

const btnFlip   = document.getElementById('flipBtn');
const btnFlash  = document.getElementById('flashBtn');
const btnFast   = document.getElementById('fastBtn');
const btn4k     = document.getElementById('cap4kBtn');
const btnAn     = document.getElementById('anBtn');
const btnSave   = document.getElementById('saveBtn');

const th1El = document.getElementById('th1'), gkEl = document.getElementById('gk');
const th1v  = document.getElementById('th1v'), gkv  = document.getElementById('gkv');
th1El.oninput=()=>th1v.textContent=th1El.value;
gkEl.oninput =()=>gkv.textContent =gkEl.value;

let track=null, stream=null, imageCapture=null;
let flipped=false, captured=false, torchOn=false;

// fit canvas for preview
function fit(){ const w=Math.min(420, Math.floor(innerWidth*0.92)); const h=Math.floor(w*4/3); c.width=w; c.height=h; }
addEventListener('resize',fit,{passive:true}); fit();

// start camera with high hints
async function startStream(){
  try{
    const constraints = {
      video:{
        facingMode:{ideal:'environment'},
        width:{ideal:4096}, height:{ideal:2160},
        frameRate:{ideal:60, max:120},
        advanced:[{focusMode:'continuous'},{exposureMode:'continuous'}]
      }, audio:false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    v.srcObject = stream;
    track = stream.getVideoTracks()[0];

    // capabilities
    const caps = track.getCapabilities?.() || {};
    if('torch' in caps){ btnFlash.disabled=false; }
    if('exposureTime' in caps || 'exposureMode' in caps){ btnFast.disabled=false; }
    if('ImageCapture' in window){
      imageCapture = new ImageCapture(track);
      btn4k.disabled = false;
    }
    statusE.textContent = 'camera ready';
  }catch(e){
    alert('üì∑ Camera unavailable or blocked'); console.error(e);
  }
}
startStream();

// UI
btnFlip.onclick = ()=>{ flipped=!flipped; v.style.transform = flipped?'scaleX(-1)':'none'; };

btnFlash.onclick = async ()=>{
  if(!track) return;
  try{
    torchOn = !torchOn;
    await track.applyConstraints({advanced:[{torch:torchOn}]});
    btnFlash.textContent = torchOn ? '‚ö° Flash ON' : '‚ö° Flash';
  }catch(e){ console.warn('torch not supported', e); alert('Flash/torch not supported on this device'); }
};

btnFast.onclick = async ()=>{
  if(!track) return;
  try{
    const caps = track.getCapabilities?.() || {};
    const minExp = caps.exposureTime?.min ?? null;
    const obj = { advanced:[{exposureMode:'manual'}] };
    if(minExp!=null) obj.advanced[0].exposureTime = minExp; // shortest ‚Üí fast shutter
    await track.applyConstraints(obj).catch(()=>{});
    if(imageCapture?.setOptions){
      await imageCapture.setOptions({exposureMode:'manual', ...(minExp?{exposureTime:minExp}:{})}).catch(()=>{});
    }
    btnFast.textContent='üèÉ‚Äç‚ôÇÔ∏è Fast Shutter ‚úî';
  }catch(e){ console.warn('fast shutter not supported', e); alert('Manual shutter not supported'); }
};

// 4K Still photo (fallback to frame if needed)
btn4k.onclick = async ()=>{
  if(!imageCapture){ alert('Full-res capture not supported'); return; }
  try{
    const pc = imageCapture.getPhotoCapabilities ? await imageCapture.getPhotoCapabilities() : null;
    const w  = pc?.imageWidth?.max  || 4032;
    const h  = pc?.imageHeight?.max || 3024;
    const settings = { imageWidth:w, imageHeight:h };
    if(pc?.fillLightMode?.includes('flash')) settings.fillLightMode='flash';
    const blob = await imageCapture.takePhoto(settings);
    const bmp  = await createImageBitmap(blob);
    c.width=bmp.width; c.height=bmp.height;
    x.save(); if(flipped){ x.translate(c.width,0); x.scale(-1,1); }
    x.drawImage(bmp,0,0); x.restore();
    bmp.close?.();
    captured=true; btnAn.disabled=false; btnSave.disabled=true;
    statusE.textContent = `photo ${c.width}√ó${c.height}`;
  }catch(e){
    console.warn('takePhoto failed, fallback to frame', e);
    // fallback: draw current video frame
    if(v.videoWidth){
      c.width=v.videoWidth; c.height=v.videoHeight;
      x.save(); if(flipped){ x.translate(c.width,0); x.scale(-1,1); }
      x.drawImage(v,0,0,c.width,c.height); x.restore();
      captured=true; btnAn.disabled=false; btnSave.disabled=true;
    } else {
      alert('Video not ready');
    }
  }
};

// Save
btnSave.onclick=()=>{
  const a=document.createElement('a');
  a.href=c.toDataURL('image/png'); a.download='palm_4k_'+Date.now()+'.png'; a.click();
};

// OpenCV ready gate
(function waitCV(){
  const ready=()=>{btnAn.disabled=false; statusE.textContent='OpenCV ready';};
  const poll=()=> (window.cv && cv.Mat) ? ready() : setTimeout(poll,200);
  if(window.cv && cv.onRuntimeInitialized!==undefined){ cv.onRuntimeInitialized=ready; poll(); } else { poll(); }
})();

// Analyze (Gabor + adaptive + skeleton + blend)
btnAn.onclick=()=>{ if(!captured) return alert('‡∂∏‡∑ñ‡∂Ω‡∑í‡∂±‡∑ä 4K Photo ‡∂ú‡∂±‡∑ä‡∂±'); if(!window.cv||!cv.Mat) return alert('OpenCV load ‡∑Ä‡∑ô‡∂Ω‡∑è ‡∂±‡∑ë'); analyze(); btnSave.disabled=false; };

function analyze(){
  const src = cv.imread(c);

  const gray = new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  const clahe = new cv.CLAHE(2.2, new cv.Size(8,8)); clahe.apply(gray,gray);

  const ksize=(+gkEl.value)|0, sigma=4.0, lambd=10.0, gamma=0.5, psi=0;
  const degs=[0,20,40,60,80,100,120,140];
  const gSum=new cv.Mat.zeros(gray.rows,gray.cols,cv.CV_32F), resp=new cv.Mat();
  for(const d of degs){ const th=d*Math.PI/180;
    const ker=cv.getGaborKernel(new cv.Size(ksize,ksize),sigma,th,lambd,gamma,psi,cv.CV_32F);
    cv.filter2D(gray,resp,cv.CV_32F,ker); cv.max(gSum,resp,gSum); ker.delete();
  }
  const g8=new cv.Mat(); cv.normalize(gSum,gSum,0,255,cv.NORM_MINMAX); gSum.convertTo(g8,cv.CV_8U);

  const bin=new cv.Mat(); cv.adaptiveThreshold(g8,bin,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY,21,-(+(th1El.value)));
  const k3=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(3,3)); cv.morphologyEx(bin,bin,cv.MORPH_OPEN,k3); cv.dilate(bin,bin,k3);

  const skel = skeletonize(bin);

  const rgba=new cv.Mat(); cv.cvtColor(skel,rgba,cv.COLOR_GRAY2RGBA);
  const tint=new cv.Mat(rgba.rows,rgba.cols,rgba.type(),[0,255,255,255]);
  cv.bitwise_and(tint,rgba,rgba);

  const out = new cv.Mat(); cv.addWeighted(src,1.0,rgba,1.0,0,out);
  cv.imshow(c,out);

  gray.delete(); clahe.delete(); gSum.delete(); resp.delete(); g8.delete(); bin.delete(); k3.delete(); skel.delete(); rgba.delete(); tint.delete(); out.delete(); src.delete();
}

function skeletonize(bin){
  const el=cv.getStructuringElement(cv.MORPH_CROSS,new cv.Size(3,3));
  const sk=cv.Mat.zeros(bin.rows,bin.cols,cv.CV_8U), tmp=new cv.Mat(), er=new cv.Mat();
  while(true){ cv.erode(bin,er,el); cv.dilate(er,tmp,el); cv.subtract(bin,tmp,tmp); cv.bitwise_or(sk,tmp,sk); er.copyTo(bin); if(cv.countNonZero(bin)===0) break; }
  tmp.delete(); er.delete(); el.delete(); return sk;
}
</script>
</body>
</html>
